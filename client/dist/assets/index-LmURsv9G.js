import{r as te}from"./phaser-zuK_9rBu.js";import{l as se}from"./socketio-CA1CrNgP.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();var P=te();const T={PRELOAD:"PreloadScene",MENU:"MenuScene",SINGLE_PLAYER_SETUP:"SinglePlayerSetupScene",LOBBY:"LobbyScene",GAME:"GameScene"},G={CARDS:"CARDS"},L=219,U=312,v={PRIMARY:5025616,SECONDARY:2201331,SUCCESS:5025616,ERROR:16007990},w={CARDS:10,UI:500};function E(u){return u.suit==="JOKER_RED"||u.suit==="JOKER_BLACK"}function J(u){return E(u)?0:u.value===1?10:u.value>=2&&u.value<=10?u.value:u.value>=11&&u.value<=13||u.value===14?10:0}function ie(u){return{id:u.id,suit:u.suit,value:u.value,isFaceUp:u.isFaceUp}}function C(u){return u.map(ie)}const _={DRAW:"DRAW",MELD:"MELD",DISCARD:"DISCARD",GAME_OVER:"GAME_OVER"},f={CREATE_ROOM:"createRoom",JOIN_ROOM:"joinRoom",LEAVE_ROOM:"leaveRoom",START_GAME:"startGame",ROUND_STARTED:"roundStarted",ROUND_ENDED:"roundEnded",START_NEW_ROUND:"startNewRound",ROOM_CREATED:"roomCreated",ROOM_JOINED:"roomJoined",ROOM_UPDATED:"roomUpdated",PLAYER_JOINED:"playerJoined",PLAYER_LEFT:"playerLeft",PLAYER_RECONNECTED:"playerReconnected",GAME_STARTED:"gameStarted",ROOM_LIST:"roomList",GET_ROOMS:"getRooms",DRAW_CARD:"drawCard",DRAW_FROM_DISCARD:"drawFromDiscard",TAKE_FINISHING_CARD:"takeFinishingCard",DISCARD_CARD:"discardCard",LAY_MELDS:"layMelds",SKIP_MELD:"skipMeld",ADD_TO_MELD:"addToMeld",REORDER_HAND:"reorderHand",UNDO_SPECIAL_DRAW:"undoSpecialDraw",UNDO_CONFIRMED:"undoConfirmed",GAME_STATE_UPDATE:"gameStateUpdate",TURN_CHANGED:"turnChanged",CARD_DRAWN:"cardDrawn",CARD_DISCARDED:"cardDiscarded",MELDS_LAID:"meldsLaid",MELD_PHASE_SKIPPED:"meldPhaseSkipped",CARD_ADDED_TO_MELD:"cardAddedToMeld",GAME_OVER:"gameOver",CHAT_MESSAGE:"chatMessage",EMOTE:"emote",ERROR:"error",INFO:"info"},Q={maxCardsPerSet:4,maxJokersPerSet:1};class I{static isValidSet(e){if(e.length<3||e.length>Q.maxCardsPerSet)return!1;const t=e.filter(o=>!E(o));if(e.length-t.length>Q.maxJokersPerSet||t.length===0)return!1;const i=t[0].value;return!(!t.every(o=>o.value===i)||!(new Set(t.map(o=>o.suit)).size===t.length))}static isValidRun(e){if(e.length<3)return!1;const t=e.filter(i=>!E(i));if(t.length===0)return!1;const s=t[0].suit;if(!t.every(i=>i.suit===s))return!1;for(let i=0;i<e.length-1;i++)if(E(e[i])&&E(e[i+1]))return!1;return this.validatePositionalRun(e)}static isValidMeld(e){return this.isValidSet(e)||this.isValidRun(e)}static splitIntoMeldGroups(e){const t=e.length;if(t<3)return[];const s=new Array(t+1);s[0]={cardsUsed:0,meldCount:0,melds:[]};for(let i=1;i<=t;i++){let r={cardsUsed:s[i-1].cardsUsed,meldCount:s[i-1].meldCount,melds:[...s[i-1].melds]};for(let n=Math.max(0,i-13);n<=i-3;n++){const a=e.slice(n,i),o=i-n;let l=!1;if(this.isValidSet(a))l=!0;else{const d=a.filter(c=>!E(c));if(d.length>0){const c=d[0].suit;d.every(h=>h.suit===c)&&this.isValidRun(a)&&(l=!0)}}if(l){const d=s[n].cardsUsed+o,c=s[n].meldCount+1;(d>r.cardsUsed||d===r.cardsUsed&&c>r.meldCount)&&(r={cardsUsed:d,meldCount:c,melds:[...s[n].melds,a]})}}s[i]=r}return s[t].melds}static validatePositionalRun(e){const t=e.map((d,c)=>({card:d,index:c,isJoker:E(d)})).filter(d=>!d.isJoker);if(t.length<2)return!0;let s=null,i=null;for(let d=0;d<t.length-1;d++){const c=t[d],h=t[d+1],p=h.index-c.index-1+1,y=c.card.value,S=h.card.value;let k=!1,x=!0,b=null;const X=S-y;if(Math.abs(X)===p&&(k=!0,x=X>0,(y===1||S===1)&&(b=!1)),!k&&(y===1||S===1)){const q=(S===1?14:S)-(y===1?14:y);Math.abs(q)===p&&(k=!0,x=q>0,b=!0)}if(!k)return!1;if(b!==null){if(i===null)i=b;else if(i!==b)return!1}if(s===null)s=x;else if(s!==x)return!1}const r=t[0],n=t[t.length-1],a=i??((r.card.value>=11||n.card.value>=11)&&(r.card.value===1||n.card.value===1)),o=r.index;if(o>0){let d=r.card.value;if(a&&d===1&&(d=14),d-o<1)return!1}const l=e.length-1-n.index;if(l>0){let d=n.card.value;if(a&&d===1&&(d=14),d+l>14)return!1}return!0}static calculateMeldScore(e){return e.reduce((t,s)=>E(s)?t+this.getJokerValueInMeld(s,e):t+J(s),0)}static getJokerValueInMeld(e,t){const s=t.filter(i=>!E(i));return s.length===0?0:this.isValidSet(t)?J(s[0]):this.isValidRun(t)?this.getJokerValueInRun(e,t,s):0}static getJokerValueInRun(e,t,s){const i=s||t.filter(l=>!E(l));if(i.length===0)return 0;const r=i.map(l=>l.value).sort((l,d)=>l-d),n=this.buildSequenceWithJokers(t,r),a=t.findIndex(l=>l.id===e.id);if(a===-1)return 0;const o=n[a];return J({value:o})}static buildSequenceWithJokers(e,t){const s=t[0];let i=0;for(const o of e)if(E(o))i++;else break;let r;t[0]===1&&t[t.length-1]>10?r=14-e.length+1:r=s-i;const n=[];let a=r;for(let o=0;o<e.length;o++)n.push(a),a++;return n}static sortMeldForDisplay(e){return this.isValidRun(e)?this.sortRunCards(e):[...e]}static validateMelds(e,t,s=51){if(e.length===0)return{isValid:!1,error:"No cards selected",selectedCards:[],validMelds:[],invalidCards:[],totalScore:0,meldScores:[],meetsOpenRequirement:!1,minimumNeeded:s,hasOpened:t};const i=this.splitIntoMeldGroups(e),r=i.flat(),n=e.filter(y=>!r.some(S=>S.id===y.id)),a=i.map(y=>this.calculateMeldScore(y)),o=a.reduce((y,S)=>y+S,0),l=t||o>=s,d=t?0:Math.max(0,s-o),c=i.length>0&&n.length===0,h=c?void 0:n.length>0?"Some cards do not form valid melds":"No valid melds found",g=i.map(y=>y.map(S=>({...S}))),p=n.map(y=>y);return{isValid:c,error:h,selectedCards:e,validMelds:g,invalidCards:p,totalScore:o,meldScores:a,meetsOpenRequirement:l,minimumNeeded:d,hasOpened:t}}static canAddToMeld(e,t){const s=t.filter(o=>!E(o)),r=s.length>0&&s.every(o=>o.suit===s[0].suit)?this.sortRunCards(t):t,n=[...r,e];if(this.isValidSet(n)||this.isValidRun(n))return!0;const a=[e,...r];return!!(this.isValidSet(a)||this.isValidRun(a))}static canCardsBeAdjacent(e,t){if(E(e)&&E(t))return!1;if(E(e)||E(t))return!0;const s=e.suit===t.suit,i=e.value===t.value;return s||i}static sortRunCards(e){if(e.length===0)return[];const t=e.map((o,l)=>({card:o,originalIndex:l,isJoker:E(o)})),s=t.filter(o=>o.isJoker),i=t.filter(o=>!o.isJoker);if(i.length===0)return e;const r=i.some(o=>o.card.value>=11);i.sort((o,l)=>{const d=o.card.value===1&&r?14:o.card.value,c=l.card.value===1&&r?14:l.card.value;return d-c});const n=[];let a=0;for(let o=0;o<i.length;o++){const l=i[o].card,d=i[o+1]?.card;if(n.push(l),d){const c=l.value===1&&d.value>=11?14:l.value,g=(d.value===1&&l.value>=11?14:d.value)-c-1,p=Math.min(g,s.length-a);for(let y=0;y<p;y++)n.push(s[a++].card)}}for(;a<s.length;)n.push(s[a++].card);return n}static canCardReplaceJoker(e,t,s){const i=s.filter(o=>!E(o));if(i.length===0)return!1;const r=i.every(o=>o.value===i[0].value),n=new Set(i.map(o=>o.suit)).size===i.length;if(r&&n){if(i.length===3){const o=e.value===i[0].value,l=!i.some(d=>d.suit===e.suit);return o&&l}return!1}if(i.every(o=>o.suit===i[0].suit)){const o=this.sortRunCards(s),l=this.getJokerRepresentedValueInRun(t,o),d=e.suit===i[0].suit,c=e.value===l;return d&&c}return!1}static getJokerRepresentedValueInRun(e,t){const i=t.filter(a=>!E(a)).map(a=>a.value).sort((a,o)=>a-o),r=this.buildSequenceWithJokers(t,i),n=t.findIndex(a=>a.id===e.id);return r[n]}static getAddPosition(e,t){const s=t.filter(o=>!E(o)),r=s.length>0&&s.every(o=>o.suit===s[0].suit)?this.sortRunCards(t):t,n=[...r,e];if(this.isValidSet(n)||this.isValidRun(n))return"end";const a=[e,...r];return this.isValidSet(a)||this.isValidRun(a)?"start":null}static calculateDeadwood(e){return e.reduce((t,s)=>t+J(s),0)}static getMeldType(e){return this.isValidSet(e)?"SET":this.isValidRun(e)?"RUN":null}}class V{static canDrawFromDeck(e,t){if(t.currentPlayerId!==e)return{valid:!1,error:"Not your turn",errorCode:"NOT_YOUR_TURN"};if(t.phase!==_.DRAW&&t.phase!=="DRAW")return{valid:!1,error:"Wrong phase - must draw first",errorCode:"WRONG_PHASE"};if(t.drawPileSize===0)return{valid:!1,error:"Draw pile is empty",errorCode:"EMPTY_DECK"};const s=this.getPlayer(t,e);if(!s)return{valid:!1,error:"Player not found",errorCode:"PLAYER_NOT_FOUND"};const i=this.validateHandSizeForAction("DRAW",s.handSize,s.hasOpened);if(!i.valid)return i;const r=this.validateGameStateIntegrity(t);return r.valid?{valid:!0}:r}static canDrawFromDiscard(e,t){if(t.currentPlayerId!==e)return{valid:!1,error:"Not your turn",errorCode:"NOT_YOUR_TURN"};if(t.phase!==_.DRAW&&t.phase!=="DRAW")return{valid:!1,error:"Wrong phase",errorCode:"WRONG_PHASE"};if(!t.discardPileTop)return{valid:!1,error:"Discard pile is empty",errorCode:"EMPTY_DISCARD"};const s=this.getPlayer(t,e);return s?s.handSize>=15?{valid:!1,error:"Hand is full",errorCode:"HAND_FULL"}:{valid:!0}:{valid:!1,error:"Player not found",errorCode:"PLAYER_NOT_FOUND"}}static isJoker(e){return e.suit==="JOKER_RED"||e.suit==="JOKER_BLACK"}static canTakeFinishingCard(e,t){if(t.currentPlayerId!==e)return{valid:!1,error:"Not your turn",errorCode:"NOT_YOUR_TURN"};if(t.phase!==_.DRAW&&t.phase!=="DRAW")return{valid:!1,error:"Wrong phase",errorCode:"WRONG_PHASE"};if(!t.finishingCard||t.finishingCardDrawn)return{valid:!1,error:"Finishing card not available",errorCode:"NO_FINISHING_CARD"};const s=this.getPlayer(t,e);if(!s)return{valid:!1,error:"Player not found",errorCode:"PLAYER_NOT_FOUND"};if(s.hasOpened)return{valid:!1,error:"Cannot take finishing card after opening",errorCode:"ALREADY_OPENED"};const i=this.validateHandSizeForAction("TAKE_FINISHING_CARD",s.handSize,s.hasOpened);return i.valid?{valid:!0}:i}static canDiscard(e,t,s,i){if(s.currentPlayerId!==e)return{valid:!1,error:"Not your turn",errorCode:"NOT_YOUR_TURN"};const r=s.phase,n=r===_.MELD||r==="MELD",a=r===_.DISCARD||r==="DISCARD";if(!n&&!a)return{valid:!1,error:"Draw a card first",errorCode:"WRONG_PHASE"};const o=this.getPlayer(s,e);if(!o)return{valid:!1,error:"Player not found",errorCode:"PLAYER_NOT_FOUND"};const l=o.hand||i;return l?l.some(d=>d.id===t)?{valid:!0}:{valid:!1,error:"Card not in hand",errorCode:"CARD_NOT_IN_HAND"}:{valid:!0}}static canTransitionToPhase(e,t,s,i){return i&&!this.getPlayer(i,s)?{valid:!1,error:"Player not found",errorCode:"PLAYER_NOT_FOUND"}:({DRAW:["MELD"],MELD:["DISCARD","MELD"],DISCARD:["DRAW"]}[e]||[]).includes(t)?{valid:!0}:{valid:!1,error:`Cannot transition from ${e} to ${t}`,errorCode:"INVALID_PHASE_TRANSITION"}}static validateHandSizeForAction(e,t,s){switch(e){case"DRAW":return t>=15?{valid:!1,error:"Hand is full",errorCode:"HAND_FULL"}:{valid:!0};case"TAKE_FINISHING_CARD":return s?{valid:!1,error:"Already opened",errorCode:"ALREADY_OPENED"}:t!==14?{valid:!1,error:"Must have exactly 14 cards",errorCode:"WRONG_HAND_SIZE"}:{valid:!0};case"DISCARD":return t===0?{valid:!1,error:"No cards to discard",errorCode:"EMPTY_HAND"}:{valid:!0};default:return{valid:!0}}}static canLayMelds(e,t,s,i=51,r){if(s.currentPlayerId!==e)return{valid:!1,error:"Not your turn",errorCode:"NOT_YOUR_TURN"};if(s.phase!==_.MELD&&s.phase!=="MELD")return{valid:!1,error:"Wrong phase",errorCode:"WRONG_PHASE"};const n=this.getPlayer(s,e);if(!n)return{valid:!1,error:"Player not found",errorCode:"PLAYER_NOT_FOUND"};for(let l=0;l<t.length;l++){const d=t[l];if(!I.isValidSet(d)&&!I.isValidRun(d))return{valid:!1,error:`Meld ${l+1} is not a valid set or run`,errorCode:"INVALID_MELD"};const c=n.hand||r;if(c){for(const h of d)if(!c.some(g=>g.id===h.id))return{valid:!1,error:"One or more cards not in hand",errorCode:"CARD_NOT_IN_HAND"}}}const o=t.flat().map(l=>l.id);if(o.length!==new Set(o).size)return{valid:!1,error:"Cannot use same card in multiple melds",errorCode:"DUPLICATE_CARDS"};if(!n.hasOpened){const l=t.reduce((d,c)=>d+I.calculateMeldScore(c),0);if(l<i)return{valid:!1,error:`Need ${i} points to open (have ${l})`,errorCode:"INSUFFICIENT_POINTS"}}return{valid:!0}}static validateGameStateIntegrity(e){if(!e.players.find(i=>i.id===e.currentPlayerId))return{valid:!1,error:"Current player not found",errorCode:"PLAYER_NOT_FOUND"};for(const i of e.players)if(i.handSize<0||i.handSize>15)return{valid:!1,error:`Player ${i.name} has invalid hand size: ${i.handSize}`,errorCode:"INVALID_HAND_SIZE"};return e.drawPileSize<0?{valid:!1,error:"Draw pile has negative size",errorCode:"INVALID_DRAW_PILE"}:![_.DRAW,_.MELD,_.DISCARD,_.GAME_OVER].includes(e.phase)&&!["DRAW","MELD","DISCARD","GAME_OVER"].includes(e.phase)?{valid:!1,error:`Invalid phase: ${e.phase}`,errorCode:"INVALID_PHASE"}:{valid:!0}}static canReorderHand(e,t,s,i){return e?t<0||t>=i?{valid:!1,error:"Invalid from index",errorCode:"INVALID_INDEX"}:s<0||s>=i?{valid:!1,error:"Invalid to index",errorCode:"INVALID_INDEX"}:t===s?{valid:!1,error:"Cannot move card to same position",errorCode:"SAME_POSITION"}:{valid:!0}:{valid:!1,error:"Player not found",errorCode:"PLAYER_NOT_FOUND"}}static canRemoveMeld(e,t,s){return e?t<0||t>=s.length?{valid:!1,error:"Invalid meld index",errorCode:"INVALID_MELD_INDEX"}:s.length===0?{valid:!1,error:"No melds to remove",errorCode:"NO_MELDS"}:{valid:!0}:{valid:!1,error:"Player not found",errorCode:"PLAYER_NOT_FOUND"}}static canShuffleDeck(e){return e.drawPileSize>0?{valid:!1,error:"Draw pile is not empty",errorCode:"DRAW_PILE_NOT_EMPTY"}:e.players.reduce((s,i)=>s+i.handSize,0)+e.drawPileSize>=104?{valid:!1,error:"All cards are in play",errorCode:"NO_CARDS_TO_SHUFFLE"}:{valid:!0}}static canAddToMeld(e,t,s,i,r,n){const a=this.getPlayerByIdOrIndex(r,e);if(!a)return{valid:!1,error:"Player not found",errorCode:"PLAYER_NOT_FOUND"};if(r.currentPlayerId!==a.id)return{valid:!1,error:"Not your turn",errorCode:"NOT_YOUR_TURN"};if(r.phase!==_.MELD&&r.phase!=="MELD")return{valid:!1,error:"Wrong phase",errorCode:"WRONG_PHASE"};const o=a.hand||n;let l;if(o&&(l=o.find(h=>h.id===t),!l))return{valid:!1,error:"Card not in hand",errorCode:"CARD_NOT_IN_HAND"};const d=this.getPlayerByIdOrIndex(r,s);if(!d)return{valid:!1,error:"Meld owner not found",errorCode:"PLAYER_NOT_FOUND"};if(i<0||i>=d.melds.length)return{valid:!1,error:"Meld does not exist",errorCode:"MELD_NOT_FOUND"};const c=d.melds[i];return l&&!I.canAddToMeld(l,c)?{valid:!1,error:"Card cannot be added to this meld",errorCode:"INVALID_ADDITION"}:d.id!==a.id&&!a.hasOpened?{valid:!1,error:"Must open before adding to other players' melds",errorCode:"NOT_OPENED"}:{valid:!0}}static canSkipMeld(e,t){return t.currentPlayerId!==e?{valid:!1,error:"Not your turn",errorCode:"NOT_YOUR_TURN"}:t.phase!==_.MELD&&t.phase!=="MELD"?{valid:!1,error:"Not in meld phase",errorCode:"WRONG_PHASE"}:{valid:!0}}static canGoOut(e,t){const s=this.getPlayer(t,e);return s?s.hasOpened?s.handSize>1?{valid:!1,error:"Must lay down all cards",errorCode:"CARDS_REMAINING"}:{valid:!0}:{valid:!1,error:"Must open before going out",errorCode:"NOT_OPENED"}:{valid:!1,error:"Player not found",errorCode:"PLAYER_NOT_FOUND"}}static getPlayerByIdOrIndex(e,t){return typeof t=="number"?t<0||t>=e.players.length?void 0:e.players[t]:e.players.find(s=>s.id===t)}static getPlayer(e,t){return e.players.find(s=>s.id===t)}static getPlayerIndex(e,t){return e.players.findIndex(s=>s.id===t)}static getAllowedActions(e,t){const s=[];if(t.currentPlayerId!==e)return[];const i=t.phase;return i===_.DRAW||i==="DRAW"?(this.canDrawFromDeck(e,t).valid&&s.push("DRAW_DECK"),this.canDrawFromDiscard(e,t).valid&&s.push("DRAW_DISCARD"),this.canTakeFinishingCard(e,t).valid&&s.push("TAKE_FINISHING_CARD")):i===_.MELD||i==="MELD"?(s.push("LAY_MELDS"),s.push("ADD_TO_MELD"),s.push("SKIP_MELD")):(i===_.DISCARD||i==="DISCARD")&&s.push("DISCARD"),s}}const re={OPENING_REQUIREMENT:51};class ne{constructor(){this.events=new Map}on(e,t){return this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t),this}off(e,t){const s=this.events.get(e);if(s){const i=s.indexOf(t);i!==-1&&s.splice(i,1)}return this}emit(e,...t){const s=this.events.get(e);return s&&s.length>0?(s.forEach(i=>{try{i(...t)}catch(r){console.error(`Error in event handler for "${e}":`,r)}}),!0):!1}once(e,t){const s=(...i)=>{this.off(e,s),t(...i)};return this.on(e,s)}removeAllListeners(e){return e?this.events.delete(e):this.events.clear(),this}listenerCount(e){return this.events.get(e)?.length||0}}class ae extends ne{constructor(){super(),this.socket=null,this.roomId=null,this.playerId=null,this.playerName=null,this.isConnected=!1,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.lastGameState=null}async connect(e="http://localhost:3000"){return new Promise((t,s)=>{this.socket=se(e,{reconnection:!0,reconnectionDelay:1e3,reconnectionAttempts:this.maxReconnectAttempts}),this.socket.on("connect",()=>{console.log("âœ… Connected to game server"),this.isConnected=!0,this.playerId=this.socket.id,this.reconnectAttempts=0,this.emit("connected"),t()}),this.socket.on("connect_error",i=>{console.error("âŒ Connection error:",i),this.isConnected=!1,s(i)}),this.socket.on("disconnect",i=>{console.log("ðŸ”Œ Disconnected:",i),this.isConnected=!1,this.emit("disconnected",i)}),this.socket.on("reconnect",i=>{console.log(`ðŸ”„ Reconnected after ${i} attempts`),this.emit("reconnected")}),this.socket.on("reconnect_attempt",i=>{this.reconnectAttempts=i,console.log(`ðŸ”„ Reconnection attempt ${i}/${this.maxReconnectAttempts}`),this.emit("reconnecting",i)}),this.socket.on("reconnect_failed",()=>{console.error("âŒ Reconnection failed"),this.emit("reconnect_failed")}),this.setupEventListeners()})}setupEventListeners(){this.socket&&(this.socket.on(f.ROOM_CREATED,e=>{console.log("ðŸŽ® Room created:",e),this.roomId=e.roomId,this.emit(f.ROOM_CREATED,e)}),this.socket.on(f.ROOM_JOINED,e=>{console.log("ðŸ‘¥ Room joined:",e),this.roomId=e.roomId,this.emit(f.ROOM_JOINED,e)}),this.socket.on(f.ROOM_UPDATED,e=>{console.log("ðŸ”„ Room updated:",e),this.emit(f.ROOM_UPDATED,e)}),this.socket.on(f.PLAYER_JOINED,e=>{console.log("ðŸ‘¤ Player joined:",e),this.emit(f.PLAYER_JOINED,e)}),this.socket.on(f.PLAYER_LEFT,e=>{console.log("ðŸ‘‹ Player left:",e),this.emit(f.PLAYER_LEFT,e)}),this.socket.on(f.PLAYER_RECONNECTED,e=>{console.log("ðŸ”„ Player reconnected:",e),this.emit(f.PLAYER_RECONNECTED,e)}),this.socket.on(f.ROOM_LIST,e=>{console.log("ðŸ“‹ Public rooms received:",e),this.emit(f.ROOM_LIST,e)}),this.socket.on(f.GAME_STARTED,()=>{console.log("ðŸŽ² Game started!"),this.emit(f.GAME_STARTED)}),this.socket.on(f.GAME_STATE_UPDATE,e=>{this.lastGameState=e,console.log("ðŸ“Š Game state update"),this.emit(f.GAME_STATE_UPDATE,e)}),this.socket.on(f.ROUND_STARTED,e=>{console.log(`ðŸ”„ Round ${e.round} started`),this.emit(f.ROUND_STARTED,e)}),this.socket.on(f.ROUND_ENDED,e=>{console.log(`ðŸŽ® Round ${e.round} ended, winner: ${e.winner.name}`),this.emit(f.ROUND_ENDED,e)}),this.socket.on(f.TURN_CHANGED,e=>{console.log("ðŸ”„ Turn changed:",e),this.emit(f.TURN_CHANGED,e)}),this.socket.on(f.CARD_DRAWN,e=>{console.log("ðŸŽ´ Card drawn"),this.emit(f.CARD_DRAWN,e)}),this.socket.on(f.CARD_DISCARDED,e=>{console.log("ðŸ—‘ï¸ Card discarded"),this.emit(f.CARD_DISCARDED,e)}),this.socket.on(f.MELDS_LAID,e=>{console.log("ðŸ“‹ Melds laid"),this.emit(f.MELDS_LAID,e)}),this.socket.on(f.MELD_PHASE_SKIPPED,e=>{console.log("â­ï¸ Meld phase skipped"),this.emit(f.MELD_PHASE_SKIPPED,e)}),this.socket.on(f.CARD_ADDED_TO_MELD,e=>{console.log("âž• Card added to meld"),this.emit(f.CARD_ADDED_TO_MELD,e)}),this.socket.on(f.GAME_OVER,e=>{console.log("ðŸ† Game over:",e),this.emit(f.GAME_OVER,e)}),this.socket.on(f.CHAT_MESSAGE,e=>{this.emit(f.CHAT_MESSAGE,e)}),this.socket.on(f.ERROR,e=>{console.error("âš ï¸ Server error:",e),this.emit(f.ERROR,e)}),this.socket.on(f.INFO,e=>{console.log("â„¹ï¸ Info:",e),this.emit(f.INFO,e)}))}createRoom(e,t=3,s=!1){if(!this.socket){console.error("Not connected to server");return}this.playerName=e;const i={playerName:e,maxPlayers:t,isPrivate:s};this.socket.emit(f.CREATE_ROOM,i)}joinRoom(e,t,s){if(!this.socket){console.error("Not connected to server");return}this.playerName=t;const i={roomId:e,playerName:t,password:s};this.socket.emit(f.JOIN_ROOM,i)}leaveRoom(){this.socket&&(this.socket.off(f.GAME_STATE_UPDATE),this.socket.off(f.TURN_CHANGED),this.socket.emit(f.LEAVE_ROOM,{roomId:this.roomId}),this.lastGameState=null,this.roomId=null)}requestPublicRooms(){if(!this.socket){console.error("Not connected to server");return}console.log("ðŸ” Requesting public room list..."),this.socket.emit(f.GET_ROOMS)}startGame(){!this.socket||!this.roomId||this.socket.emit(f.START_GAME,{roomId:this.roomId})}startNewRound(){this.validateGameAction()&&this.socket.emit(f.START_NEW_ROUND,{roomId:this.roomId})}drawCard(){if(!this.validateGameAction())return;const e={roomId:this.roomId};this.socket.emit(f.DRAW_CARD,e)}drawFromDiscard(){this.validateGameAction()&&this.socket.emit(f.DRAW_FROM_DISCARD,{roomId:this.roomId})}takeFinishingCard(){this.validateGameAction()&&this.socket.emit(f.TAKE_FINISHING_CARD,{roomId:this.roomId,playerId:this.playerId})}discardCard(e){if(!this.validateGameAction())return;const t={roomId:this.roomId,cardId:e};this.socket.emit(f.DISCARD_CARD,t)}undoSpecialDraw(){this.socket.emit(f.UNDO_SPECIAL_DRAW,{roomId:this.roomId})}layMelds(e){if(!this.validateGameAction())return;const t={roomId:this.roomId,melds:e};this.socket.emit(f.LAY_MELDS,t)}skipMeld(){this.validateGameAction()&&this.socket.emit(f.SKIP_MELD,{roomId:this.roomId,playerId:this.playerId})}addCardToMeld(e,t,s){this.validateGameAction()&&this.socket.emit(f.ADD_TO_MELD,{roomId:this.roomId,playerId:this.playerId,cardId:e,meldOwner:t,meldIndex:s})}reorderHand(e,t){this.validateGameAction()&&this.socket.emit(f.REORDER_HAND,{roomId:this.roomId,fromIndex:e,toIndex:t})}sendChatMessage(e){if(!this.socket||!this.roomId)return;const t={roomId:this.roomId,message:e};this.socket.emit(f.CHAT_MESSAGE,t)}sendEmote(e){!this.socket||!this.roomId||this.socket.emit(f.EMOTE,{roomId:this.roomId,emoteType:e})}validateGameAction(){return this.socket?this.isConnected?this.roomId?!0:(console.error("Not in a room"),!1):(console.error("Connection lost"),!1):(console.error("Not connected to server"),!1)}disconnect(){this.socket&&(this.socket.disconnect(),this.socket.removeAllListeners(),this.socket=null),this.roomId=null,this.playerId=null,this.playerName=null,this.isConnected=!1,this.lastGameState=null}getRoomId(){return this.roomId}getPlayerId(){return this.playerId}getPlayerName(){return this.playerName}isInRoom(){return this.roomId!==null}getConnectionStatus(){return this.isConnected?"connected":this.reconnectAttempts>0?"reconnecting":"disconnected"}getLastGameState(){return this.lastGameState}}class oe extends P.Scene{constructor(){super({key:T.MENU}),this.networkManager=null}create(){const{width:e,height:t}=this.scale;this.input.once("pointerdown",()=>{this.scale.isFullscreen||this.scale.startFullscreen()}),this.add.text(e/2,t*.2,"REMI",{fontSize:"52px",fontFamily:"Arial",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.add.text(e/2,t*.25,"Card Game",{fontSize:"22px",fontFamily:"Arial",color:"#cccccc"}).setOrigin(.5),this.createButton(e/2,t*.4,"ðŸŽ® Single Player","#4CAF50").on("pointerdown",()=>{this.startSinglePlayerSetup()}),this.createButton(e/2,t*.5,"ðŸŒ Multiplayer","#2196F3").on("pointerdown",()=>{this.startMultiplayer()}),this.createButton(e/2,t*.6,"âš™ï¸ Settings","#757575",.7).on("pointerdown",()=>{this.showSettings()}),this.add.text(e-10,t-10,"by Sveto",{fontSize:"16px",fontFamily:"Arial",color:"#666666"}).setOrigin(1,1)}createButton(e,t,s,i,r=1){const n=this.add.container(e,t),a=this.add.rectangle(0,0,400*r,80*r,0,.8);a.setStrokeStyle(3,parseInt(i.replace("#","0x")));const o=this.add.text(0,0,s,{fontSize:`${32*r}px`,fontFamily:"Arial",color:"#ffffff"}).setOrigin(.5);return n.add([a,a,o]),n.setSize(400*r,80*r),n.setInteractive(),n.on("pointerover",()=>{a.setFillStyle(parseInt(i.replace("#","0x")),.3),this.tweens.add({targets:n,scaleX:1.05,scaleY:1.05,duration:100,ease:"Power2"})}),n.on("pointerout",()=>{a.setFillStyle(0,.8),this.tweens.add({targets:n,scaleX:1,scaleY:1,duration:100,ease:"Power2"})}),n}startSinglePlayer(){console.log("Starting single player mode"),this.scene.start(T.GAME,{isMultiplayer:!1})}startSinglePlayerSetup(){console.log("Starting single player setup"),this.scene.start(T.SINGLE_PLAYER_SETUP)}startMultiplayer(){console.log("Starting multiplayer mode");const e=this.add.text(this.scale.width/2,this.scale.height/2,"Connecting to server...",{fontSize:"24px",fontFamily:"Arial",color:"#ffffff"}).setOrigin(.5);this.networkManager=new ae,this.networkManager.connect("http://localhost:3000").then(()=>{console.log("Connected to server!"),e.destroy(),this.scene.start(T.LOBBY,{networkManager:this.networkManager})}).catch(t=>{console.error("Failed to connect:",t),e.setText(`Connection failed!
Click to retry`),e.setInteractive(),e.on("pointerdown",()=>{e.destroy(),this.startMultiplayer()})})}showSettings(){console.log("Settings clicked");const e=this.add.text(this.scale.width/2,this.scale.height/2,"Settings coming soon!",{fontSize:"32px",fontFamily:"Arial",color:"#ffffff",backgroundColor:"#000000",padding:{x:20,y:10}}).setOrigin(.5).setDepth(1e3);this.time.delayedCall(2e3,()=>{e.destroy()})}}const m={layout:{titleY:80,contentStartY:.3,elementSpacing:80,inputSpacing:100,bottomPadding:120},fonts:{title:{size:"48px",family:"Arial",style:"bold"},heading:{size:"32px",family:"Arial"},label:{size:"24px",family:"Arial"},body:{size:"20px",family:"Arial"},button:{size:"28px",family:"Arial"},smallButton:{size:"20px"},roomCode:{size:"48px",family:"Arial",style:"bold"},playerName:{size:"28px",family:"Arial"}},colors:{text:{primary:"#ffffff",secondary:"#cccccc",accent:"#FFD700"},buttons:{create:"#4CAF50",join:"#2196F3",browse:"#9C27B0",back:"#757575",start:"#4CAF50"},background:0,backgroundAlpha:.8},buttons:{large:{width:400,height:70,borderWidth:3},small:{width:300,height:50,borderWidth:2}},animation:{hoverScale:100,messageFade:2e3,sceneTransition:1e3}};var j=(u=>(u.MAIN_MENU="main_menu",u.CREATE_ROOM="create_room",u.JOIN_ROOM="join_room",u.WAITING_ROOM="waiting_room",u.PUBLIC_ROOMS="public_rooms",u))(j||{});class le extends P.Scene{constructor(){super({key:T.LOBBY}),this.currentRoomId=null,this.currentState="main_menu",this.uiGroups=new Map,this.backButton=null,this.titleText=null,this.playerListTexts=[],this.startButton=null,this.roomCodeText=null}init(e){this.networkManager=e.networkManager}create(){this.createUIGroups(),this.createPersistentUI(),this.setupNetworkListeners(),this.transitionTo("main_menu")}createUIGroups(){Object.values(j).forEach(e=>{this.uiGroups.set(e,this.add.group())}),this.uiGroups.set("messages",this.add.group())}addToGroup(e,t){const s=this.uiGroups.get(e);s&&s.add(t)}clearGroup(e){const t=this.uiGroups.get(e);t&&t.clear(!0,!0)}clearDynamicUI(){Object.values(j).forEach(e=>{this.clearGroup(e)}),this.playerListTexts=[],this.startButton=null,this.roomCodeText=null}transitionTo(e){switch(this.clearDynamicUI(),this.currentState=e,this.titleText&&this.titleText.setVisible(e!=="public_rooms"),e){case"main_menu":this.buildMainMenu();break;case"create_room":this.buildCreateRoom();break;case"join_room":this.buildJoinRoom();break;case"waiting_room":this.buildWaitingRoom();break;case"public_rooms":this.buildPublicRooms();break}}createPersistentUI(){const{width:e}=this.scale;this.backButton=this.createButton(50,50,"â† Back",m.colors.buttons.back,"small"),this.backButton.on("pointerdown",()=>this.handleBack()),this.titleText=this.add.text(e/2,m.layout.titleY,"Multiplayer Lobby",{fontSize:m.fonts.title.size,fontFamily:m.fonts.title.family,color:m.colors.text.primary,fontStyle:m.fonts.title.style}).setOrigin(.5)}handleBack(){this.currentState==="waiting_room"&&this.currentRoomId&&(this.networkManager.leaveRoom(),this.currentRoomId=null),this.currentState==="main_menu"?(this.networkManager.disconnect(),this.scene.start(T.MENU)):this.transitionTo("main_menu")}buildMainMenu(){const{width:e,height:t}=this.scale,s="main_menu",i=new $(e/2,t*m.layout.contentStartY,m.layout.elementSpacing),r=this.createButton(i.x,i.nextY(),"ðŸŽ® Create Room",m.colors.buttons.create,"large");r.on("pointerdown",()=>this.transitionTo("create_room")),this.addToGroup(s,r);const n=this.createButton(i.x,i.nextY(),"ðŸšª Join Room",m.colors.buttons.join,"large");n.on("pointerdown",()=>this.transitionTo("join_room")),this.addToGroup(s,n);const a=this.createButton(i.x,i.nextY(),"ðŸ“‹ Browse Public Rooms",m.colors.buttons.browse,"small");a.on("pointerdown",()=>this.transitionTo("public_rooms")),this.addToGroup(s,a)}buildCreateRoom(){const{width:e,height:t}=this.scale,s="create_room",i=new $(e/2,t*m.layout.contentStartY,m.layout.inputSpacing),r=this.createLabel(i.x,i.nextY(),"Enter your name:");this.addToGroup(s,r);const n=i.currentY+50,a=this.createTextInput(i.x,n,"playerNameInput","Your Name",20,m.colors.buttons.create);this.addToGroup(s,a),i.advance(20);const o=this.createLabel(i.x,i.nextY(),"Room Visibility:");this.addToGroup(s,o);const l=i.currentY+40,d=this.add.dom(i.x,l).createFromHTML(`
  <div style="display: flex; align-items: center; color: white; font-family: Arial; font-size: 15px;">
    <input type="checkbox" id="isPublicCheckbox" style="width: 15px; height: 15px; margin-right: 10px;">
    <label for="isPublicCheckbox">Make Room Private</label>
  </div>
`);this.addToGroup(s,d),i.advance(20);const c=this.createButton(i.x,i.nextY(),"Create Room",m.colors.buttons.create,"large");c.on("pointerdown",()=>this.handleCreateRoom()),this.addToGroup(s,c)}handleCreateRoom(){const e=document.getElementById("playerNameInput"),t=document.getElementById("isPublicCheckbox"),s=e?.value.trim()||"Player",i=t?.checked||!1;if(s.length<2){this.showMessage("Name must be at least 2 characters!");return}this.networkManager.createRoom(s,6,i),this.showLoadingMessage("Creating room...")}buildJoinRoom(){const{width:e,height:t}=this.scale,s="join_room",i=new $(e/2,t*.25,60),r=this.createLabel(i.x,i.nextY(),"Enter Room Code:");this.addToGroup(s,r);const n=i.currentY+40,a=this.createTextInput(i.x,n,"roomCodeInput","ABC123",6,m.colors.buttons.join,{uppercase:!0,letterSpacing:!0,large:!0});this.addToGroup(s,a),i.advance(100);const o=this.createLabel(i.x,i.nextY(),"Your Name:");this.addToGroup(s,o);const l=i.currentY+40,d=this.createTextInput(i.x,l,"playerNameJoinInput","Your Name",20,m.colors.buttons.join);this.addToGroup(s,d),i.advance(100);const c=this.createButton(i.x,i.nextY(),"Join Room",m.colors.buttons.join,"large");c.on("pointerdown",()=>this.handleJoinRoom()),this.addToGroup(s,c)}handleJoinRoom(){const e=document.getElementById("roomCodeInput"),t=document.getElementById("playerNameJoinInput"),s=e?.value.trim().toUpperCase()||"",i=t?.value.trim()||"Player";if(s.length!==3){this.showMessage("Room code must be 6 characters!");return}if(i.length<2){this.showMessage("Name must be at least 2 characters!");return}this.networkManager.joinRoom(s,i),this.showLoadingMessage("Joining room...")}buildWaitingRoom(){const{width:e,height:t}=this.scale,s="waiting_room";this.roomCodeText=this.add.text(e/2,150,`Room: ${this.currentRoomId}`,{fontSize:m.fonts.roomCode.size,fontFamily:m.fonts.roomCode.family,color:m.colors.text.accent,fontStyle:m.fonts.roomCode.style}).setOrigin(.5),this.addToGroup(s,this.roomCodeText);const i=this.add.text(e/2,210,"Share this code with friends!",{fontSize:m.fonts.body.size,fontFamily:m.fonts.body.family,color:m.colors.text.secondary}).setOrigin(.5);this.addToGroup(s,i);const r=this.createButton(e/2,260,"ðŸ“‹ Copy Code",m.colors.buttons.browse,"small");r.on("pointerdown",()=>{this.currentRoomId&&(navigator.clipboard.writeText(this.currentRoomId),this.showMessage("Code copied!",1500))}),this.addToGroup(s,r);const n=this.add.text(e/2,350,"Players:",{fontSize:m.fonts.heading.size,fontFamily:m.fonts.heading.family,color:m.colors.text.primary}).setOrigin(.5);this.addToGroup(s,n),this.startButton=this.createButton(e/2,t-m.layout.bottomPadding,"â–¶ï¸ Start Game",m.colors.buttons.start,"large"),this.startButton.on("pointerdown",()=>this.networkManager.startGame()),this.startButton.setVisible(!1),this.addToGroup(s,this.startButton)}updatePlayerList(e){if(this.currentState!=="waiting_room")return;const{width:t}=this.scale,s="waiting_room";this.playerListTexts.forEach(l=>l.destroy()),this.playerListTexts=[];let i=400;const r=50;e.forEach(l=>{const d=l.isHost?"ðŸ‘‘":"ðŸ‘¤",c=l.isConnected?"ðŸŸ¢":"ðŸ”´",h=this.add.text(t/2,i,`${d} ${l.name} ${c}`,{fontSize:m.fonts.playerName.size,fontFamily:m.fonts.playerName.family,color:m.colors.text.primary}).setOrigin(.5);this.addToGroup(s,h),this.playerListTexts.push(h),i+=r});const n=this.networkManager.getPlayerId(),o=e.some(l=>l.id===n&&l.isHost)&&e.length>=2;this.startButton&&this.startButton.setVisible(o)}buildPublicRooms(){const{width:e,height:t}=this.scale,s="public_rooms",i=new $(e/2,m.layout.titleY,60),r=this.add.text(i.x,i.nextY(),"Available Public Rooms",{fontSize:m.fonts.title.size,fontFamily:m.fonts.title.family,color:m.colors.text.primary,fontStyle:m.fonts.title.style}).setOrigin(.5);this.addToGroup(s,r);const n=this.createLabel(i.x,i.nextY(),"Enter your name:");this.addToGroup(s,n);const a=i.currentY+40,o=this.createTextInput(i.x,a,"publicPlayerNameInput","Your Name",20,m.colors.buttons.browse);this.addToGroup(s,o),i.advance(80);const l=this.add.container(0,i.currentY);this.addToGroup(s,l),this.networkManager.requestPublicRooms(),this.showMessage("Fetching rooms...",1e3)}setupNetworkListeners(){this.networkManager.on(f.ROOM_CREATED,e=>{console.log("Room created:",e.roomId),this.currentRoomId=e.roomId,this.transitionTo("waiting_room")}),this.networkManager.on(f.ROOM_JOINED,e=>{console.log("Room joined:",e.roomId),this.currentRoomId=e.roomId,this.transitionTo("waiting_room")}),this.networkManager.on(f.ROOM_UPDATED,e=>{console.log("Room updated:",e),this.updatePlayerList(e.players)}),this.networkManager.on(f.PLAYER_JOINED,e=>{console.log("Player joined:",e.playerName),this.showMessage(`${e.playerName} joined!`,2e3)}),this.networkManager.on(f.PLAYER_LEFT,e=>{console.log("Player left:",e.playerId),this.showMessage("A player left",2e3)}),this.networkManager.on(f.GAME_STARTED,()=>{console.log("Game starting!"),this.showMessage("Game starting...",m.animation.sceneTransition),this.time.delayedCall(m.animation.sceneTransition,()=>{this.scene.start(T.GAME,{isMultiplayer:!0,networkManager:this.networkManager,roomId:this.currentRoomId})})}),this.networkManager.on(f.ERROR,e=>{console.error("Network error:",e),this.showMessage(e.message||"An error occurred",3e3)}),this.networkManager.on(f.ROOM_LIST,e=>{this.updatePublicRoomsList(e)})}createButton(e,t,s,i,r="large"){const n=this.add.container(e,t),{width:a,height:o,borderWidth:l}=m.buttons[r],d=r==="large"?m.fonts.button.size:m.fonts.smallButton.size,c=this.add.rectangle(0,0,a,o,m.colors.background,m.colors.backgroundAlpha);c.setStrokeStyle(l,parseInt(i.replace("#","0x")));const h=this.add.text(0,0,s,{fontSize:d,fontFamily:m.fonts.button.family,color:m.colors.text.primary}).setOrigin(.5);n.add([c,h]),n.setSize(a,o),n.setInteractive();const g=parseInt(i.replace("#","0x"));return n.on("pointerover",()=>{c.setFillStyle(g,.3),this.tweens.add({targets:n,scaleX:1.05,scaleY:1.05,duration:m.animation.hoverScale})}),n.on("pointerout",()=>{c.setFillStyle(m.colors.background,m.colors.backgroundAlpha),this.tweens.add({targets:n,scaleX:1,scaleY:1,duration:m.animation.hoverScale})}),n}createLabel(e,t,s){return this.add.text(e,t,s,{fontSize:m.fonts.label.size,fontFamily:m.fonts.label.family,color:m.colors.text.primary}).setOrigin(.5)}updatePublicRoomsList(e){if(this.currentState!=="public_rooms")return;const{width:t}=this.scale,s="public_rooms";if(this.uiGroups.get(s)?.getChildren().forEach(i=>{i instanceof P.GameObjects.Container&&i.isRoomButton&&i.destroy()}),e.length===0){const i=this.add.text(t/2,400,"No public rooms found.",{fontSize:m.fonts.body.size,color:m.colors.text.primary}).setOrigin(.5);this.addToGroup(s,i),i.isRoomButton=!0;return}e.forEach((i,r)=>{const n=300+r*80,a=this.createButton(t/2,n,`Join ${i.hostName}'s Room (${i.playerCount}/${i.maxPlayers})`,m.colors.buttons.join,"small");a.on("pointerdown",()=>{const l=document.getElementById("publicPlayerNameInput")?.value.trim()||"Player";if(l.length<2){this.showMessage("Please enter a name first!");return}this.networkManager.joinRoom(i.id,l)}),a.isRoomButton=!0,this.addToGroup(s,a)})}createTextInput(e,t,s,i,r,n,a={}){const o=a.large?250:300,l=a.large?60:50,d=a.large?32:24,c=`
      width: ${o}px;
      height: ${l}px;
      font-size: ${d}px;
      text-align: center;
      ${a.uppercase?"text-transform: uppercase;":""}
      border: 2px solid ${n};
      border-radius: 8px;
      background: #1a1a1a;
      color: white;
      padding: 8px;
      ${a.letterSpacing?"letter-spacing: 8px;":""}
    `;return this.add.dom(e,t).createFromHTML(`
      <input type="text" 
             id="${s}" 
             placeholder="${i}" 
             maxlength="${r}"
             style="${c}">
    `)}showMessage(e,t=m.animation.messageFade){const s=this.add.text(this.scale.width/2,this.scale.height-50,e,{fontSize:m.fonts.label.size,fontFamily:m.fonts.label.family,color:m.colors.text.primary,backgroundColor:"#000000",padding:{x:20,y:10}}).setOrigin(.5).setDepth(1e3);this.addToGroup("messages",s),this.tweens.add({targets:s,alpha:0,y:s.y-30,duration:t,ease:"Power2",onComplete:()=>s.destroy()})}showLoadingMessage(e){this.clearGroup(this.currentState);const t=this.add.text(this.scale.width/2,this.scale.height/2,e,{fontSize:m.fonts.heading.size,fontFamily:m.fonts.heading.family,color:m.colors.text.primary}).setOrigin(.5);this.addToGroup(this.currentState,t)}shutdown(){this.networkManager?.removeAllListeners(),this.children.removeAll(!0),this.uiGroups.clear()}}class ${constructor(e,t,s){this.isFirst=!0,this.x=e,this.currentY=t,this.spacing=s}nextY(){return this.isFirst?(this.isFirst=!1,this.currentY):(this.currentY+=this.spacing,this.currentY)}advance(e){this.currentY+=e}reset(e){this.currentY=e,this.isFirst=!0}}var A=(u=>(u.GAME_STARTED="GAME_STARTED",u.CARD_DRAWN_FROM_DECK="CARD_DRAWN_FROM_DECK",u.CARD_DRAWN_FROM_DISCARD="CARD_DRAWN_FROM_DISCARD",u.FINISHING_CARD="FINISHING_CARD",u.CARD_DISCARDED="CARD_DISCARDED",u.MELDS_LAID_DOWN="MELDS_LAID_DOWN",u.CARD_ADDED_TO_MELD="CARD_ADDED_TO_MELD",u.MELD_VALIDATION_RESULT="MELD_VALIDATION_RESULT",u.HAND_REORDERED="HAND_REORDERED",u.PHASE_CHANGED="PHASE_CHANGED",u.TURN_ENDED="TURN_ENDED",u.PLAYER_TURN_STARTED="PLAYER_TURN_STARTED",u.DRAW_PILE_SHUFFLED="DRAW_PILE_SHUFFLED",u.DRAW_PILE_EMPTY="DRAW_PILE_EMPTY",u.GAME_OVER="GAME_OVER",u))(A||{});class de{constructor(){this.listeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),()=>{const s=this.listeners.get(e);if(s){const i=s.indexOf(t);i>-1&&s.splice(i,1)}}}emit(e){const t=this.listeners.get(e.type);t&&t.forEach(s=>s(e))}clear(){this.listeners.clear()}}var D=(u=>(u.DRAW="DRAW",u.MELD="MELD",u.DISCARD="DISCARD",u.GAME_OVER="GAME_OVER",u))(D||{});class B{static createButton(e,t,s,i,r=v.PRIMARY,n=400,a=70){const o=e.add.container(t,s),l=typeof r=="string"?parseInt(r.replace("#","0x")):r,d=e.add.rectangle(0,0,n,a,3050327,.8);d.setStrokeStyle(3,l);const c=e.add.text(0,0,i,{fontSize:`${Math.floor(a*.4)}px`,fontFamily:"Arial",color:"#ffffff"}).setOrigin(.5);return o.add([d,c]),o.setSize(n,a),o.setInteractive(),o.on("pointerover",()=>{d.setFillStyle(l,.3),e.tweens.add({targets:o,scaleX:1.05,scaleY:1.05,duration:100,ease:"Power2"})}),o.on("pointerout",()=>{d.setFillStyle(3050327,.8),e.tweens.add({targets:o,scaleX:1,scaleY:1,duration:100,ease:"Power2"})}),o.background=d,o.label=c,o}static createTextInput(e,t,s,i,r,n=300,a=50,o=20){return e.add.dom(t,s).createFromHTML(`
      <input type="text" 
             id="${r}" 
             placeholder="${i}" 
             maxlength="${o}"
             style="
               width: ${n}px;
               height: ${a}px;
               font-size: ${Math.floor(a*.5)}px;
               text-align: center;
               border: 2px solid #4CAF50;
               border-radius: 8px;
               background: #1a1a1a;
               color: white;
               padding: 8px;
             ">
    `)}static showToast(e,t,s=2e3,i=v.SUCCESS){const r=e.add.text(e.scale.width/2,e.scale.height-50,t,{fontSize:"24px",fontFamily:"Arial",color:"#ffffff",backgroundColor:`#${i.toString(16).padStart(6,"0")}`,padding:{x:20,y:10}}).setOrigin(.5).setDepth(1e3);return e.tweens.add({targets:r,alpha:0,y:r.y-30,duration:s,ease:"Power2",onComplete:()=>r.destroy()}),r}static createModal(e,t,s,i){const{width:r,height:n}=e.scale,a=e.add.container(0,0).setDepth(2e3),o=e.add.rectangle(r/2,n/2,r,n,0,.8);o.setInteractive();const l=Math.min(600,r*.9),d=Math.min(400,n*.7),c=e.add.rectangle(r/2,n/2,l,d,1710618);c.setStrokeStyle(3,v.PRIMARY);const h=e.add.text(r/2,n/2-d/3,t,{fontSize:"36px",fontFamily:"Arial",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),g=e.add.text(r/2,n/2,s,{fontSize:"24px",fontFamily:"Arial",color:"#cccccc",align:"center",wordWrap:{width:l-40}}).setOrigin(.5);a.add([o,c,h,g]);const p=n/2+d/3.5,y=l/(i.length+1);return i.forEach((S,k)=>{const x=r/2-l/2+y*(k+1),b=this.createButton(e,x,p,S.text,S.color||v.PRIMARY,200,60);b.on("pointerdown",()=>{S.callback(),a.destroy()}),a.add(b)}),a}static createLoadingSpinner(e,t,s,i=50){const r=e.add.container(t,s),n=8;for(let a=0;a<n;a++){const o=a/n*Math.PI*2,l=Math.cos(o)*i,d=Math.sin(o)*i,c=e.add.circle(l,d,4,16777215,1-a/n);r.add(c)}return e.tweens.add({targets:r,angle:360,duration:1e3,repeat:-1,ease:"Linear"}),r}static createProgressBar(e,t,s,i,r,n=v.SUCCESS){const a=e.add.container(t,s),o=e.add.rectangle(0,0,i,r,3355443);o.setStrokeStyle(2,6710886);const l=e.add.rectangle(-i/2,0,0,r,n);return l.setOrigin(0,.5),a.add([o,l]),{container:a,setProgress:c=>{c=P.Math.Clamp(c,0,1),e.tweens.add({targets:l,width:i*c,duration:200,ease:"Power2"})}}}static createPlayerCard(e,t,s,i,r=!1,n=0,a=0){const o=e.add.container(t,s),l=250,d=100,c=e.add.rectangle(0,0,l,d,1710618,.9);c.setStrokeStyle(3,r?v.SUCCESS:3355443);const h=e.add.text(-l/2+10,-d/2+15,i,{fontSize:"24px",fontFamily:"Arial",color:r?"#4CAF50":"#ffffff",fontStyle:"bold"}).setOrigin(0),g=e.add.text(-l/2+10,0,`ðŸƒ ${n} cards`,{fontSize:"18px",fontFamily:"Arial",color:"#cccccc"}).setOrigin(0),p=e.add.text(-l/2+10,d/2-15,`Score: ${a}`,{fontSize:"18px",fontFamily:"Arial",color:a>=0?"#4CAF50":"#F44336"}).setOrigin(0,1);return o.add([c,h,g,p]),o.updateInfo=(y,S,k,x)=>{h.setText(y),h.setColor(S?"#4CAF50":"#ffffff"),g.setText(`ðŸƒ ${k} cards`),p.setText(`Score: ${x}`),p.setColor(x>=0?"#4CAF50":"#F44336"),c.setStrokeStyle(3,S?v.SUCCESS:3355443)},o}static shake(e,t){e.tweens.add({targets:t,x:t.x+10,duration:50,yoyo:!0,repeat:3,ease:"Power2"})}static pulse(e,t,s=1.1){e.tweens.add({targets:t,scaleX:s,scaleY:s,duration:300,yoyo:!0,ease:"Sine.easeInOut"})}static fadeIn(e,t,s=500){t.alpha=0,e.tweens.add({targets:t,alpha:1,duration:s,ease:"Power2"})}static fadeOut(e,t,s=500,i=!0){e.tweens.add({targets:t,alpha:0,duration:s,ease:"Power2",onComplete:()=>{i&&t.destroy()}})}static slideIn(e,t,s,i=500){const r={},n={};switch(s){case"left":r.x=-t.x-100,n.x=t.x;break;case"right":r.x=e.scale.width+100,n.x=t.x;break;case"top":r.y=-t.y-100,n.y=t.y;break;case"bottom":r.y=e.scale.height+100,n.y=t.y;break}Object.assign(t,r),e.tweens.add({targets:t,...n,duration:i,ease:"Back.easeOut"})}}var H=(u=>(u.EASY="EASY",u.MEDIUM="MEDIUM",u.HARD="HARD",u.EXPERT="EXPERT",u))(H||{});class ee{constructor(e){this.seenCards=new Map,this.deckCardsRemaining=new Map,this.opponentModels=new Map,this.turnNumber=0,this.gamePhase="early",this.SIMULATION_COUNT=20,this.LOOKAHEAD_DEPTH=2,this.solutionCache=new Map,this.config=e,this.resetTracking()}shouldDrawFromDiscard(e,t){try{const s=e.getState(),i=s.topDiscardCard;if(!i||s.discardPileSize===0)return!1;const r=e.getPlayerHand(t),n=e.hasPlayerOpened(t);this.trackSeenCard(i);const a=[...r,i],o=this.solveHandWithValidation(a,e,t),l=this.determineMeldsToLay(o,n,a,e,t);if(l.length===0)return!1;const d=l.some(y=>y.some(S=>S.id===i.id)),c=l.flat(),h=a.filter(y=>!c.some(S=>S.id===y.id)),g=o.canGoOut&&h.length===1&&h[0].id===i.id;if(!d&&!g||!n&&l.reduce((S,k)=>S+this.calcScore(k),0)<51)return!1;if(this.config.difficulty==="EXPERT"||this.config.difficulty==="HARD"){if(o.canGoOut)return!0;const y=this.getHighestOpponentDanger();if(y.dangerLevel>70&&this.wouldHelpOpponent(i,y.playerIndex))return!0;const S=this.solveHandWithValidation(r,e,t);return o.totalScore-S.totalScore>=3}const p=this.solveHandWithValidation(r,e,t);return o.totalScore-p.totalScore>=5}catch(s){return console.error("[AI] Error in shouldDrawFromDiscard:",s),!1}}shouldTakeFinishingCard(e,t){try{const s=e.getFinishingCard();if(!s||e.hasDrawnFinishingCard()||e.hasPlayerOpened(t))return!1;const i=e.getPlayerHand(t);if(i.length!==14)return!1;const r=[...i,s],n=this.solveHandWithValidation(r,e,t);if(!n.canGoOut||n.totalScore<51)return!1;const a=n.melds.some(l=>l.some(d=>d.id===s.id)),o=n.remainingCards.length===1&&n.remainingCards[0].id===s.id;return a||o}catch(s){return console.error("[AI] Error in shouldTakeFinishingCard:",s),!1}}planMeldAndDiscard(e,t){try{const s=e.getPlayerHand(t),i=e.hasPlayerOpened(t),r=e.getState();if(s.length===0)throw new Error("No cards in hand");this.updateGamePhase(r,e),this.turnNumber++,this.turnNumber%5===0&&this.solutionCache.clear();const n=this.solveHandWithValidation(s,e,t);console.log(`[AI ${t}] Turn ${this.turnNumber}: hand=${s.length} cards, hasOpened=${i}, solution.totalScore=${n.totalScore}, solution.melds=${n.melds.length}, canGoOut=${n.canGoOut}`);let a=[];const o=[];a=this.determineMeldsToLay(n,i,s,e,t),console.log(`[AI ${t}] Decision: laying ${a.length} melds (total score: ${a.reduce((p,y)=>p+this.calcScore(y),0)})`),a=a.map(p=>this.orderCardsInMeldAdvanced(p));const l=a.flat();if(s.filter(p=>!l.some(y=>y.id===p.id)).length===0&&a.length>0){const p=a.map((y,S)=>({meld:y,index:S,score:this.calcScore(y)}));p.sort((y,S)=>y.score-S.score),a=a.filter((y,S)=>S!==p[0].index)}if(i&&(this.config.difficulty==="EXPERT"||this.config.difficulty==="HARD")){const p=this.findOptimalMeldAdditions(s,a,e,r,t);o.push(...p)}const c=new Set([...a.flat().map(p=>p.id),...o.map(p=>p.card.id)]),h=s.filter(p=>!c.has(p.id));let g;return h.length===0?a.length>0?g=this.selectCardFromMelds(a,s):g=s.find(y=>!this.isJoker(y))||s[0]:g=this.selectBestDiscardAdvanced(h,r,t,e,s),this.trackSeenCard(g),console.log(`[AI ${t}] Discarding: ${g.suit} ${g.value}`),{meldsToLay:a,cardToDiscard:g,cardsToAddToMelds:o}}catch(s){console.error("[AI] Error in planMeldAndDiscard:",s);const i=e.getPlayerHand(t),r=i.find(n=>!this.isJoker(n));return{meldsToLay:[],cardToDiscard:r||i[0],cardsToAddToMelds:[]}}}updateOpponentModel(e,t,s,i){try{let r=this.opponentModels.get(e);switch(r||(r={playerIndex:e,discardedCards:[],pickedFromDiscard:[],estimatedDeadwood:140,hasOpened:!1,meldCount:0,handSize:14,likelyNeeds:new Map,likelyHas:new Map,dangerLevel:0,playStyle:"balanced"},this.opponentModels.set(e,r)),t){case"discard":s&&(r.discardedCards.push(s),this.trackSeenCard(s),this.reduceNeedProbability(r,s),r.handSize=Math.max(0,r.handSize-1),this.updateDangerLevel(r));break;case"pick_discard":s&&(r.pickedFromDiscard.push(s),this.inferLikelyNeeds(r,s),r.handSize++,r.likelyHas.set(this.getCardKey(s),100),r.dangerLevel=Math.min(100,r.dangerLevel+15));break;case"draw_deck":r.handSize++;break;case"lay_melds":if(i){r.meldCount+=i.length;const n=i.flat().length;r.handSize=Math.max(0,r.handSize-n),i.flat().forEach(a=>this.trackSeenCard(a)),this.updateDangerLevel(r)}break;case"open":r.hasOpened=!0,r.dangerLevel=Math.min(100,r.dangerLevel+20);break}this.detectPlayStyle(r)}catch(r){console.error("[AI] Error updating opponent model:",r)}}inferLikelyNeeds(e,t){if(this.isJoker(t))return;const s=["HEART","DIAMOND","CLUB","SPADE"];for(const i of s)if(i!==t.suit){const r=`${t.value}-${i}`,n=e.likelyNeeds.get(r)||0;e.likelyNeeds.set(r,Math.min(100,n+40))}for(let i=-2;i<=2;i++){if(i===0)continue;const r=t.value+i;if(r>=1&&r<=13){const n=`${r}-${t.suit}`,a=e.likelyNeeds.get(n)||0,o=Math.abs(i)===1?50:25;e.likelyNeeds.set(n,Math.min(100,a+o))}}}reduceNeedProbability(e,t){const s=["HEART","DIAMOND","CLUB","SPADE"];for(const i of s){const r=`${t.value}-${i}`,n=e.likelyNeeds.get(r)||0;e.likelyNeeds.set(r,Math.max(0,n-30))}for(let i=-1;i<=1;i++){if(i===0)continue;const r=t.value+i;if(r>=1&&r<=13){const n=`${r}-${t.suit}`,a=e.likelyNeeds.get(n)||0;e.likelyNeeds.set(n,Math.max(0,a-15))}}}updateDangerLevel(e){let t=Math.max(0,14-e.handSize)*6;e.hasOpened&&(t+=20),t+=e.meldCount*10,t+=e.pickedFromDiscard.length*8,e.dangerLevel=Math.min(100,t)}detectPlayStyle(e){const t=e.discardedCards.length,s=e.pickedFromDiscard.length;t>0&&(s/t>.5?e.playStyle="aggressive":e.discardedCards.some(r=>this.getCardPoints(r)>=10)?e.playStyle="defensive":e.playStyle="balanced")}wouldHelpOpponent(e,t){const s=this.opponentModels.get(t);if(!s)return!1;const i=this.getCardKey(e);return(s.likelyNeeds.get(i)||0)>50}getHighestOpponentDanger(){let e={playerIndex:-1,dangerLevel:0};return this.opponentModels.forEach((t,s)=>{t.dangerLevel>e.dangerLevel&&(e={playerIndex:s,dangerLevel:t.dangerLevel})}),e}selectBestDiscardAdvanced(e,t,s,i,r){try{if(e.length===0)throw new Error("No cards available to discard");const n=e.filter(o=>!this.isJoker(o));if(n.length>0)e=n;else return console.warn("[AI] Only jokers available to discard!"),e[0];if(e.length===1)return e[0];const a=e.map(o=>{let l=0;const d=this.getCardPoints(o);l-=d*2;const c=this.evaluateCardSynergyAdvanced(o,e);l+=c*2;const h=this.evaluateFuturePotential(o,r);if(l+=h*2,this.config.difficulty==="EXPERT"||this.config.difficulty==="HARD"){const p=this.calculateOpponentDangerScore(o);l+=p*4;const y=this.calculateDiscardSafety(o);l-=y*2,this.isDeadCard(o,r)&&(l-=50)}const g=this.calculateIsolationScore(o,r);return l-=g,this.gamePhase==="late"&&(l-=d*2),{card:o,score:l}});return a.sort((o,l)=>o.score-l.score),this.config.randomness>0&&a.length>1&&Math.random()<this.config.randomness?a[Math.min(1,a.length-1)].card:a[0].card}catch(n){console.error("[AI] Error in selectBestDiscardAdvanced:",n);const a=e.find(o=>!this.isJoker(o));return a||e[0]}}calculateOpponentDangerScore(e){let t=0;return this.opponentModels.forEach(s=>{const i=this.getCardKey(e),n=(s.likelyNeeds.get(i)||0)*(s.dangerLevel/100);t+=n;for(let a=-1;a<=1;a++){if(a===0)continue;const o=e.value+a;if(o>=1&&o<=13){const l=`${o}-${e.suit}`,d=s.likelyNeeds.get(l)||0;t+=d*.3*(s.dangerLevel/100)}}}),t}calculateDiscardSafety(e){const t=Array.from(this.seenCards.values()).filter(i=>i.value===e.value).length,s=Array.from(this.seenCards.values()).filter(i=>i.suit===e.suit&&Math.abs(i.value-e.value)<=2).length;return t*10+s*5}isDeadCard(e,t){const s=t.filter(o=>o.value===e.value&&o.id!==e.id),i=t.filter(o=>this.isJoker(o)),r=s.length+i.length>=2,n=t.filter(o=>o.suit===e.suit&&o.id!==e.id);let a=!1;for(const o of n)if(Math.abs(o.value-e.value)<=3){a=!0;break}return!r&&!a}findOptimalMeldAdditions(e,t,s,i,r){try{const n=new Set(t.flat().map(g=>g.id)),a=e.filter(g=>!n.has(g.id)),o=Math.max(0,a.length-1);if(o===0)return[];const l=this.getAllTableMelds(s,i),d=[];for(const g of a)for(const p of l)if(this.canAddCardToMeld(g,p.cards)){const y=this.evaluateMeldAdditionValue(g,p,r);y>0&&d.push({card:g,meldOwner:p.owner,meldIndex:p.index,value:y})}d.sort((g,p)=>p.value-g.value);const c=[],h=new Set;for(const g of d){if(c.length>=o)break;h.has(g.card.id)||(c.push({card:g.card,meldOwner:g.meldOwner,meldIndex:g.meldIndex}),h.add(g.card.id))}return c}catch(n){return console.error("[AI] Error finding meld additions:",n),[]}}evaluateMeldAdditionValue(e,t,s){let i=this.getCardPoints(e)*5;return t.cards.some(n=>this.isJoker(n))&&this.wouldReplaceJokerInMeld(e,t.cards)&&(i+=200),t.owner===s&&(i+=20),this.gamePhase==="late"&&(i+=30),i}wouldReplaceJokerInMeld(e,t){if(this.isJoker(e))return!1;const s=t.findIndex(r=>this.isJoker(r));if(s===-1)return!1;const i=[...t];return i[s]=e,this.isValidSet(i)||this.isValidRun(i)}canAddCardToMeld(e,t){const s=[...t,e];return this.isValidSet(s)||this.isValidRun(s)}determineMeldsToLay(e,t,s,i,r){let n=[];const a=e.totalScore;if(e.melds.length===0)return[];if(this.config.difficulty==="HARD"||this.config.difficulty==="EXPERT"){if(t)(e.canGoOut&&e.remainingCards.length===1||e.remainingCards.length<=3&&e.deadwoodValue<=15||a>=20||e.melds.length>0)&&(n=e.melds);else if(a>=51){const o=s.filter(d=>!e.melds.flat().some(c=>c.id===d.id)),l=this.calculateDeadwood(o);e.canGoOut&&o.length===1?n=e.melds:l<=15&&o.length<=3&&Math.random()<.3?(console.log(`[AI ${r}] Holding back - close to winning`),n=[]):n=e.melds}}else(t||a>=51)&&(n=e.melds);return n}resetTracking(){this.seenCards.clear(),this.opponentModels.clear(),this.solutionCache.clear(),this.turnNumber=0,this.gamePhase="early",this.deckCardsRemaining.clear();const e=["HEART","DIAMOND","CLUB","SPADE"];for(const t of e)for(let s=1;s<=13;s++)this.deckCardsRemaining.set(`${s}-${t}`,2);this.deckCardsRemaining.set("JOKER",4)}trackSeenCard(e){const t=this.getCardKey(e);this.seenCards.set(t,e);const s=this.deckCardsRemaining.get(t)||0;this.deckCardsRemaining.set(t,Math.max(0,s-1))}getCardKey(e){return this.isJoker(e)?"JOKER":`${e.value}-${e.suit}`}updateGamePhase(e,t){const s=e.handSizes.reduce((i,r)=>i+r,0)/e.numPlayers;s>10?this.gamePhase="early":s>5?this.gamePhase="mid":this.gamePhase="late"}solveHandWithValidation(e,t,s){const i=e.map(c=>c.id).sort().join(","),r=this.solutionCache.get(i);if(r)return r;const n=this.findAllValidCandidates(e,t,s);n.sort((c,h)=>Math.abs(h.efficiency-c.efficiency)>.5?h.efficiency-c.efficiency:h.priority!==c.priority?h.priority-c.priority:h.score-c.score);const a=this.findBestCombination(n,e,[],0,0),o=this.calculateDeadwood(a.remainingCards),l=a.remainingCards.length===1,d={...a,deadwoodValue:o,canGoOut:l,turnsToWin:l?0:Math.ceil(a.remainingCards.length/2)};return this.solutionCache.set(i,d),d}findAllValidCandidates(e,t,s){const i=[],r=Math.min(e.length,8);for(let n=3;n<=r;n++){const a=this.getCombinations(e,n);for(const o of a){const l=t.validateMelds(s,o);if(l.validMelds.length>0)for(let d=0;d<l.validMelds.length;d++){const c=l.validMelds[d],h=l.meldScores[d],g=this.isValidSet(c)?"SET":"RUN";i.push({cards:c,score:h,type:g,efficiency:h/c.length,priority:this.calculateMeldPriority(c,e,g),flexibility:this.calculateMeldFlexibility(c,e)})}}}return this.deduplicateCandidates(i)}calculateMeldPriority(e,t,s){let i=e.length*2;const r=e.filter(a=>this.isJoker(a)).length;i+=r*5,s==="RUN"&&(i+=3);const n=e.filter(a=>this.getCardPoints(a)>=10);return i+=n.length*2,i}calculateMeldFlexibility(e,t){let s=0;if(this.isValidRun(e)){const i=e.find(n=>!this.isJoker(n))?.suit,r=e.filter(n=>!this.isJoker(n)).map(n=>n.value);if(r.length>0){const n=Math.min(...r),a=Math.max(...r);t.some(o=>o.suit===i&&o.value===n-1)&&(s+=10),t.some(o=>o.suit===i&&o.value===a+1)&&(s+=10)}}if(this.isValidSet(e)&&e.length<4){const i=e.find(n=>!this.isJoker(n))?.value,r=new Set(e.filter(n=>!this.isJoker(n)).map(n=>n.suit));t.some(n=>n.value===i&&!r.has(n.suit)&&!e.includes(n))&&(s+=15)}return s}deduplicateCandidates(e){const t=new Set,s=[];for(const i of e){const r=i.cards.map(n=>n.id).sort().join(",");t.has(r)||(t.add(r),s.push(i))}return s}findBestCombination(e,t,s,i,r){if(r>15)return{melds:s,remainingCards:t,totalScore:i,deadwoodValue:this.calculateDeadwood(t),canGoOut:t.length===1,turnsToWin:99};let n={melds:s,remainingCards:t,totalScore:i,deadwoodValue:this.calculateDeadwood(t),canGoOut:t.length===1,turnsToWin:99};for(let a=0;a<e.length;a++){const o=e[a];if(this.canMakeMeld(o.cards,t)){const l=this.removeCards(t,o.cards),d=[...s,o.cards],c=i+o.score,h=this.findBestCombination(e.slice(a+1),l,d,c,r+1);this.isBetterSolution(h,n)&&(n=h)}}return n}isBetterSolution(e,t){return e.canGoOut&&!t.canGoOut?!0:!e.canGoOut&&t.canGoOut?!1:e.totalScore>t.totalScore+5?!0:t.totalScore>e.totalScore+5?!1:Math.abs(e.totalScore-t.totalScore)<=5?e.deadwoodValue<t.deadwoodValue:e.totalScore>t.totalScore}getAllTableMelds(e,t){const s=[];for(let i=0;i<t.numPlayers;i++)e.getPlayerMelds(i).forEach((n,a)=>{s.push({cards:n,owner:i,index:a})});return s}orderCardsInMeldAdvanced(e){if(!this.isValidRun(e))return[...e].sort((a,o)=>this.isJoker(a)?1:this.isJoker(o)?-1:a.suit.localeCompare(o.suit));const t=e.filter(a=>this.isJoker(a)),s=e.filter(a=>!this.isJoker(a));if(s.length===0)return e;const i=s.some(a=>a.value>=11);s.sort((a,o)=>{const l=a.value===1&&i?14:a.value,d=o.value===1&&i?14:o.value;return l-d});const r=[];let n=0;for(let a=0;a<s.length;a++){const o=s[a],l=s[a+1];if(r.push(o),l){const d=o.value===1&&i?14:o.value,h=(l.value===1&&i?14:l.value)-d-1,g=Math.min(h,t.length-n);for(let p=0;p<g;p++)r.push(t[n++])}}for(;n<t.length;)r.push(t[n++]);return r}evaluateCardSynergyAdvanced(e,t){if(this.isJoker(e))return 100;let s=0;const i=t.filter(o=>!this.isJoker(o)&&o.id!==e.id),r=i.filter(o=>o.value===e.value);s+=r.length*12,r.length>=2&&(s+=20);const n=i.filter(o=>o.suit===e.suit);for(const o of n){const l=Math.abs(o.value-e.value);l===1?s+=15:l===2?s+=8:l===3&&(s+=3)}const a=t.filter(o=>this.isJoker(o)).length;return a>0&&r.length>0&&(s+=a*10),s}evaluateFuturePotential(e,t){let s=0;const i=t.filter(n=>n.value===e.value&&n.id!==e.id);s+=i.length*5,i.length===2&&(s+=15);const r=t.filter(n=>n.suit===e.suit&&n.id!==e.id);for(const n of r)Math.abs(n.value-e.value)<=2&&(s+=5);return s}calculateIsolationScore(e,t){if(this.isJoker(e))return 0;let s=0;s+=t.filter(r=>r.value===e.value&&r.id!==e.id).length*5;const i=t.filter(r=>r.suit===e.suit&&r.id!==e.id);for(const r of i){const n=Math.abs(r.value-e.value);n<=3&&(s+=(4-n)*3)}return Math.max(0,20-s)}selectCardFromMelds(e,t){const s=e.flat(),i=s.filter(a=>!this.isJoker(a)),n=(i.length>0?i:s).map(a=>({card:a,score:this.isJoker(a)?9999:this.getCardPoints(a)}));return n.sort((a,o)=>a.score-o.score),n[0].card}isJoker(e){return e.suit==="JOKER_RED"||e.suit==="JOKER_BLACK"}getCardPoints(e){return this.isJoker(e)?0:e.value===1?10:e.value>=2&&e.value<=10?e.value:e.value>=11&&e.value<=13||e.value===14?10:0}calcScore(e){return e.reduce((t,s)=>t+this.getCardPoints(s),0)}calculateDeadwood(e){return e.reduce((t,s)=>t+this.getCardPoints(s),0)}canMakeMeld(e,t){const s=[...t];for(const i of e){const r=s.findIndex(n=>n.id===i.id);if(r===-1)return!1;s.splice(r,1)}return!0}removeCards(e,t){const s=[...e];for(const i of t){const r=s.findIndex(n=>n.id===i.id);r!==-1&&s.splice(r,1)}return s}getCombinations(e,t){if(t>e.length)return[];if(t===1)return e.map(i=>[i]);const s=[];for(let i=0;i<e.length-t+1;i++){const r=e[i];this.getCombinations(e.slice(i+1),t-1).forEach(a=>s.push([r,...a]))}return s}isValidSet(e){if(e.length<3)return!1;const t=e.filter(n=>!this.isJoker(n)),s=e.filter(n=>this.isJoker(n));if(t.length===0)return!1;const i=t[0].value;return!(!t.every(n=>n.value===i)||new Set(t.map(n=>n.suit)).size!==t.length||t.length+s.length>4)}isValidRun(e){if(e.length<3)return!1;const t=e.filter(r=>!this.isJoker(r));if(t.length===0)return!1;const s=t[0].suit;if(!t.every(r=>r.suit===s))return!1;const i=this.sortRunCardsForValidation(e);return this.validatePositionalRun(i)}sortRunCardsForValidation(e){const t=e.filter(a=>this.isJoker(a)),s=e.filter(a=>!this.isJoker(a)),i=s.some(a=>a.value>=11);s.sort((a,o)=>{const l=a.value===1&&i?14:a.value,d=o.value===1&&i?14:o.value;return l-d});const r=[];let n=0;for(let a=0;a<s.length;a++){const o=s[a],l=s[a+1];if(r.push(o),l){const d=o.value===1&&i?14:o.value,h=(l.value===1&&i?14:l.value)-d-1,g=Math.min(h,t.length-n);for(let p=0;p<g;p++)r.push(t[n++])}}for(;n<t.length;)r.push(t[n++]);return r}validatePositionalRun(e){const t=e.map((i,r)=>({card:i,index:r,isJoker:this.isJoker(i)})).filter(i=>!i.isJoker);if(t.length<2)return!0;let s=null;for(let i=0;i<t.length-1;i++){const r=t[i],n=t[i+1],o=n.index-r.index-1+1,l=r.card.value,d=n.card.value;let c=d-l,h=!1,g=!0;if(Math.abs(c)===o&&(h=!0,g=c>0),!h&&(l===1||d===1)){const S=(d===1?14:d)-(l===1?14:l);Math.abs(S)===o&&(h=!0,g=S>0)}if(!h)return!1;if(s===null)s=g;else if(s!==g)return!1}return!0}}const ce=1280,he=720,ue={HEART:26,DIAMOND:13,SPADE:39,CLUB:0,JOKER_RED:52,JOKER_BLACK:53},F={MAX_HAND_WIDTH_RATIO:.9,CARD_SPACING:228,MIN_SCALE:.1,MAX_SCALE:.4,PLAYER_HAND_Y_RATIO:.85,ANIMATION_DURATION:300};class ge{constructor(e,t){this.handSprites=[],this.handCards=[],this.selectedCards=new Set,this.handDropZones=[],this.currentValidMelds=[],this.scene=e,this.isMultiplayer=t.isMultiplayer,this.getCardId=t.getCardId,this.hasPlayerOpened=t.hasPlayerOpened,this.onSelectionChanged=t.onSelectionChanged}getHandCards(){return[...this.handCards]}getHandSprites(){return[...this.handSprites]}setHand(e){this.handCards=[...e],this.createHandVisuals()}addCard(e,t,s){const{width:i}=this.scene.scale;this.handCards.push(e);const r=t??i/2,n=s??this.getHandY(),a=this.createCardSprite(e,r,n);this.handSprites.push(a);const o=this.calculateHandLayout(),l=o.startX+(this.handSprites.length-1)*o.spacing;return this.scene.tweens.add({targets:a,x:l,y:this.getHandY(),scaleX:o.scaleFactor,scaleY:o.scaleFactor,duration:F.ANIMATION_DURATION,ease:"Back.easeOut",onStart:()=>a.setDepth(30),onComplete:()=>{this.makeCardInteractive(a),this.updateHandDisplay(),this.updateHandDropZones()}}),a}removeCard(e){const t=this.handSprites.findIndex(i=>i.cardData?.id===e.id);if(t===-1)return null;const s=this.handSprites[t];return this.handSprites.splice(t,1),this.handCards.splice(t,1),this.selectedCards.has(s)&&this.selectedCards.delete(s),s}removeCardsByIds(e){const t=[];return this.handSprites=this.handSprites.filter(s=>{const i=s.cardData;return e.has(i.id)?(this.destroyCardSafely(s),t.push(s),!1):!0}),this.handCards=this.handCards.filter(s=>!e.has(s.id)),this.updateHandDisplay(),this.updateHandDropZones(),t}reorderCard(e,t){if(e===t||e<0||e>=this.handSprites.length||t<0||t>=this.handSprites.length)return;const[s]=this.handSprites.splice(e,1);this.handSprites.splice(t,0,s);const[i]=this.handCards.splice(e,1);this.handCards.splice(t,0,i),this.updateHandDisplay(),this.updateHandDropZones()}getSpriteByIndex(e){return this.handSprites[e]??null}getSpriteIndex(e){return this.handSprites.indexOf(e)}handleCardClick(e){if(this.selectedCards.has(e)){const t=e.cardData;if(t){const s=this.findMeldContainingCard(t);s?this.deselectEntireMeld(s):this.deselectCard(e)}else this.deselectCard(e)}else this.selectCard(e);this.validateCurrentSelection()}findCardSprite(e){return this.handSprites.find(t=>t.cardData?.id===e.id)||null}selectCard(e){const t=this.getHandY();this.selectedCards.add(e),e.setTint(16776960),this.scene.tweens.add({targets:e,y:t-10,duration:100,ease:"Back.easeOut"}),this.scene.input.setDraggable(e,!1)}deselectCard(e){const t=this.getHandY();this.selectedCards.delete(e),e.clearTint(),this.scene.tweens.add({targets:e,y:t,duration:100,ease:"Back.easeOut"}),this.scene.input.setDraggable(e,!0)}clearSelection(){const e=this.getHandY();this.selectedCards.forEach(t=>{t.clearTint(),t.setY(e),t.input&&this.scene.input.setDraggable(t,!1)}),this.selectedCards.clear(),this.currentValidMelds=[],this.onSelectionChanged?.()}clearHand(){this.handSprites.forEach(e=>{this.scene.tweens.killTweensOf(e),e.removeAllListeners(),e.destroy()}),this.handSprites=[],this.handCards=[],this.handDropZones.forEach(e=>e.destroy()),this.handDropZones=[],this.clearSelection()}getSelectedCardsInOrder(){const e=[];return this.handSprites.forEach((t,s)=>{if(this.selectedCards.has(t)){const i=t.cardData;i&&e.push({card:i,index:s})}}),e.sort((t,s)=>t.index-s.index),e.map(t=>t.card)}getCurrentValidMelds(){return this.currentValidMelds}hasSelection(){return this.selectedCards.size>0}getSelectionCount(){return this.selectedCards.size}isSelected(e){return this.selectedCards.has(e)}updateHandDisplay(){const e=this.calculateHandLayout();if(e.numCards===0)return;const t=this.getHandY();this.handSprites.forEach((s,i)=>{const r=e.startX+i*e.spacing,n=this.selectedCards.has(s);this.scene.tweens.add({targets:s,x:r,y:n?t-10:t,scaleX:e.scaleFactor,scaleY:e.scaleFactor,duration:F.ANIMATION_DURATION,ease:"Sine.easeOut"}),s.setData("cardIndex",i),s.setData("zoneType","CARDS_IN_HAND")})}updateHandDropZones(){this.handDropZones.forEach(s=>s.destroy()),this.handDropZones=[];const e=this.calculateHandLayout();if(e.numCards===0)return;const t=this.getHandY();this.handSprites.forEach((s,i)=>{const r=e.startX+i*e.spacing,n=L*e.scaleFactor,a=U*e.scaleFactor,o=this.scene.add.zone(r,t,n,a).setRectangleDropZone(n,a).setOrigin(0).setData({zoneType:"CARDS_IN_HAND",positionIndex:i}).setDepth(-1);this.handDropZones.push(o)})}getHandDropZones(){return this.handDropZones}handleResize(){this.updateHandDisplay(),this.updateHandDropZones()}getCardFrame(e){return e.value===14||e.suit==="JOKER_RED"||e.suit==="JOKER_BLACK"?e.suit==="JOKER_RED"?52:53:(ue[e.suit]||0)+e.value-1}createCardSprite(e,t,s){const i=this.getCardFrame(e),r=this.scene.add.image(t,s,G.CARDS,i).setOrigin(0).setScale(this.getDynamicScale()).setInteractive().setData({cardId:e.id,isSelected:!1});return e.isFaceUp&&this.scene.input.setDraggable(r),r.setDepth(w.CARDS),r.cardData=e,r}makeCardInteractive(e){e.setInteractive({useHandCursor:!0}),this.scene.input.setDraggable(e,!0);let t=0,s={x:0,y:0};e.on("pointerdown",i=>{t=this.scene.time.now,s={x:i.x,y:i.y}}),e.on("pointerup",i=>{const r=P.Math.Distance.Between(s.x,s.y,i.x,i.y),n=this.scene.time.now-t;r<10&&n<300&&this.handleCardClick(e)})}destroyCardSafely(e){if(!(!e||!e.scene)){this.scene.tweens.killTweensOf(e),e.removeAllListeners();try{this.scene.input.setDraggable(e,!1)}catch{}e.labelText&&e.labelText.destroy(),e.destroy()}}destroy(){this.handSprites.forEach(e=>this.destroyCardSafely(e)),this.handSprites=[],this.handCards=[],this.selectedCards.clear(),this.handDropZones.forEach(e=>e.destroy()),this.handDropZones=[],this.currentValidMelds=[]}getDynamicScale(){const{width:e,height:t}=this.scene.scale,s=e/ce,i=t/he;let r=Math.min(s,i);return r=r/3,r=Math.max(F.MIN_SCALE,Math.min(r,F.MAX_SCALE)),r}getHandY(){return this.scene.scale.height*F.PLAYER_HAND_Y_RATIO}calculateHandPosition(e){const t=this.calculateHandLayout();return t.startX+e*t.spacing}calculateHandLayout(){const e=this.scene.scale.width,t=this.handSprites.length;if(t===0)return{startX:e/2,spacing:0,scaleFactor:this.getDynamicScale(),numCards:0};let s=this.getDynamicScale();const i=L*s,r=F.CARD_SPACING*s;let n=i+(t-1)*r;const a=e*F.MAX_HAND_WIDTH_RATIO;if(n>a){const h=a/n;s*=h;const g=L*s,p=F.CARD_SPACING*s;n=g+(t-1)*p}s=Math.max(s,F.MIN_SCALE);const o=L*s,l=F.CARD_SPACING*s,d=o+(t-1)*l;return{startX:(e-d)/2,spacing:l,scaleFactor:s,numCards:t}}createHandVisuals(){this.handSprites.forEach(s=>this.destroyCardSafely(s)),this.handSprites=[];const e=this.getHandY(),t=this.calculateHandLayout();this.handCards.forEach((s,i)=>{const r=t.startX+i*t.spacing,n=this.createCardSprite(s,r,e);n.setScale(t.scaleFactor),this.makeCardInteractive(n),this.handSprites.push(n)}),this.updateHandDisplay(),this.updateHandDropZones()}findMeldContainingCard(e){const t=this.getCardId(e);for(const s of this.currentValidMelds)if(s.some(r=>this.getCardId(r)===t))return s;return null}deselectEntireMeld(e){e.forEach(t=>{const s=this.getCardId(t),i=this.handSprites.find(r=>{const n=r.cardData;return n?this.getCardId(n)===s:!1});i&&this.selectedCards.has(i)&&this.deselectCard(i)})}validateCurrentSelection(){const e=this.getSelectedCardsInOrder();if(e.length<3){this.currentValidMelds=[],this.onSelectionChanged?.();return}const t=this.hasPlayerOpened(),s=e.map(r=>this.cardToCardData(r)),i=I.validateMelds(s,t,re.OPENING_REQUIREMENT);i.isValid&&i.validMelds.length>0?(this.currentValidMelds=this.cardDataMeldsToCards(i.validMelds,e),this.updateMeldVisualFeedback(i)):(this.currentValidMelds=[],this.selectedCards.forEach(r=>{r.setTint(16777157)})),this.onSelectionChanged?.()}cardToCardData(e){return{id:this.getCardId(e),suit:e.suit,value:e.value,isFaceUp:e.isFaceUp??!0}}cardDataMeldsToCards(e,t){return e.map(s=>s.map(i=>t.find(r=>this.getCardId(r)===i.id)).filter(i=>i!==void 0))}updateMeldVisualFeedback(e){if(!e.validMelds)return;const t=new Map;e.validMelds.forEach((i,r)=>{i.forEach(n=>t.set(n.id,r))});const s=[65280,65535,16711935,16776960];this.selectedCards.forEach(i=>{const r=i.cardData;if(!r)return;const n=this.getCardId(r),a=t.get(n);if(a!==void 0){const o=s[a%s.length];i.setTint(o)}else i.setTint(16777157)})}}const fe={HEART:26,DIAMOND:13,SPADE:39,CLUB:0,JOKER_RED:52,JOKER_BLACK:53},pe=1280,me=720,R={START_X:.2,START_Y:.7,CARD_OVERLAP:.01,MELD_SPACING:.15,MAX_MELDS_PER_ROW:5,CARD_SCALE:1,DROP_ZONE_PADDING:25},K={START_X:.2,START_Y:.15,MELD_SPACING:.15};class ye{constructor(e,t){this.allPlayerMelds=new Map,this.displayedOpponentMelds=null,this.opponentMeldDisplay=null,this.scene=e,this.config=t}getPlayerMelds(e){return this.allPlayerMelds.get(e)||[]}getMeld(e,t){return(this.allPlayerMelds.get(e)||[]).find(i=>i.meldIndex===t)??null}hasPlayerMelds(e){const t=this.allPlayerMelds.get(e);return t!==void 0&&t.length>0}getMeldCount(e){return this.getPlayerMelds(e).length}initializeForPlayers(e){this.allPlayerMelds.clear();for(let t=0;t<e;t++)this.allPlayerMelds.set(t,[])}getDynamicScale(){const e=this.scene.scale.width,t=this.scene.scale.height,s=e/pe,i=t/me;let r=Math.min(s,i);return r=Math.max(.4,Math.min(r,1.5)),r}createMeldVisual(e,t,s){const{width:i,height:r}=this.scene.scale,n=this.isMyMeld(e),a=this.calculateMeldPosition(s,e),o={meldIndex:s,meldOwner:e,cards:[],cardData:[...t],position:a,dropZone:null,highlight:null};t.forEach((h,g)=>{const p=a.x+g*i*R.CARD_OVERLAP,y=a.y,S=this.scene.add.image(p,y,G.CARDS,this.getCardFrame(h)).setScale(this.getDynamicScale()*R.CARD_SCALE).setDepth(w.CARDS+g).setData("cardId",h.id).setInteractive({draggable:!1});n||S.setVisible(!1),o.cards.push(S)});const{dropZone:l,highlight:d}=this.createMeldDropZone(a,t.length,s,e);n||(l.setVisible(!1),d.setVisible(!1)),o.dropZone=l,o.highlight=d;const c=this.allPlayerMelds.get(e)||[];c.push(o),this.allPlayerMelds.set(e,c)}createMeldDropZone(e,t,s,i){const{width:r,height:n}=this.scene.scale,a=t*r*R.CARD_OVERLAP+L*this.getDynamicScale()+R.DROP_ZONE_PADDING*2,o=U*this.getDynamicScale()+R.DROP_ZONE_PADDING*2,l=e.x+(t-1)*r*R.CARD_OVERLAP/2,d=this.scene.add.rectangle(l,e.y,a,o).setStrokeStyle(2,65280,0).setFillStyle(65280,0).setDepth(w.CARDS-1),c=this.scene.add.zone(l,e.y,a,o).setRectangleDropZone(a,o).setData({zoneType:"MELD_TABLE",meldIndex:s,playerIndex:i});return c.on("dragenter",()=>{d.setStrokeStyle(3,65280,1),d.setFillStyle(65280,.2)}),c.on("dragleave",()=>{d.setStrokeStyle(2,65280,0),d.setFillStyle(65280,0)}),{dropZone:c,highlight:d}}updateLayout(){const{width:e,height:t}=this.scene.scale,s=this.getDynamicScale();this.allPlayerMelds.forEach((i,r)=>{i.forEach(n=>{const a=this.calculateMeldPosition(n.meldIndex,r);n.position=a,n.cards.forEach((o,l)=>{const d=a.x+l*e*R.CARD_OVERLAP,c=a.y;o.setScale(s),o.setPosition(d,c)}),this.recreateMeldDropZone(n)})})}addCardToMeldVisual(e,t,s,i){this.scene.tweens.killTweensOf(t);const{width:r,height:n}=this.scene.scale;t.setData("cardId",s.id),e.cards.push(t),e.cardData=[...i],t.setScale(this.getDynamicScale()*R.CARD_SCALE),t.setOrigin(.5,.5),t.setAlpha(1),i.forEach((a,o)=>{const l=e.position.x+o*r*R.CARD_OVERLAP,d=e.position.y,c=e.cards.find(h=>h.getData("cardId")===a.id);c&&(c.clearTint(),c.setData("isSelected",!1),this.scene.tweens.add({targets:c,x:l,y:d,duration:150,ease:"Back.easeOut",onComplete:()=>{c.disableInteractive(),c.setDepth(w.CARDS+o)}}))}),this.recreateMeldDropZone(e)}handleJokerReplacement(e,t,s,i,r){const n=e.cards.find(d=>d.getData("cardId")===i.id),{width:a,height:o}=this.scene.scale,l=n?{x:n.x,y:n.y}:{x:e.position.x,y:e.position.y};if(t.setData("cardId",s.id),t.setScale(this.getDynamicScale()*R.CARD_SCALE),t.setOrigin(.5,.5),n){const d=e.cards.indexOf(n);d!==-1&&e.cards.splice(d,1),this.destroyCardSafely(n)}return e.cards.push(t),e.cardData=[...r],r.forEach((d,c)=>{const h=e.position.x+c*a*R.CARD_OVERLAP,g=e.position.y,p=e.cards.find(y=>y.getData("cardId")===d.id);p&&(this.scene.tweens.add({targets:p,x:h,y:g,duration:300,ease:"Back.easeOut",onComplete:()=>{p.disableInteractive()}}),p.setDepth(w.CARDS+c))}),this.recreateMeldDropZone(e),this.config.showMessage("Joker replaced and returned to hand!"),{replacedJoker:i,jokerStartPosition:l}}addCardDataToMeld(e,t,s){}togglePlayerMelds(e,t){this.displayedOpponentMelds===e||this.showOpponentMelds(e,t())}showOpponentMelds(e,t){this.allPlayerMelds.forEach((i,r)=>{this.isMyMeld(r)||i.forEach(n=>{n.cards.forEach(a=>a.setVisible(!1)),n.dropZone?.setVisible(!1),n.highlight?.setVisible(!1)})});const s=this.allPlayerMelds.get(e);s&&s.forEach(i=>{i.cards.forEach(r=>r.setVisible(!0)),i.dropZone?.setVisible(!0),i.highlight?.setVisible(!0)}),this.displayedOpponentMelds=e,this.opponentMeldDisplay&&(this.opponentMeldDisplay.destroy(),this.opponentMeldDisplay=null)}hideOpponentMelds(){this.displayedOpponentMelds=null,this.allPlayerMelds.forEach((e,t)=>{this.isMyMeld(t)||e.forEach(s=>{s.cards.forEach(i=>i.setVisible(!1)),s.dropZone?.setVisible(!1),s.highlight?.setVisible(!1)})}),this.opponentMeldDisplay&&(this.opponentMeldDisplay.destroy(),this.opponentMeldDisplay=null)}refreshMeldViewIfOpen(e){if(this.displayedOpponentMelds!==null){const t=this.displayedOpponentMelds;this.showOpponentMelds(t,e(t))}}isOpponentMeldsDisplayed(){return this.displayedOpponentMelds!==null}getDisplayedOpponentIndex(){return this.displayedOpponentMelds}updateFromServerState(e,t,s){console.log("Updating melds from server"),this.clearAllMelds(),e.forEach((i,r)=>{this.allPlayerMelds.set(r,[]),i.melds.forEach((n,a)=>{const o=s(n);this.createMeldVisual(r,o,a)})})}clearPlayerMelds(e){(this.allPlayerMelds.get(e)||[]).forEach(s=>{s.cards.forEach(i=>this.destroyCardSafely(i)),s.dropZone?.destroy(),s.highlight?.destroy()}),this.allPlayerMelds.set(e,[])}clearAllMelds(){this.allPlayerMelds.forEach((e,t)=>{e.forEach(s=>{s.cards.forEach(i=>this.destroyCardSafely(i)),s.dropZone?.destroy(),s.highlight?.destroy()})}),this.allPlayerMelds.clear()}clearMeldsAfterIndex(e,t){const s=this.allPlayerMelds.get(e)||[];s.slice(t).forEach(r=>{r.cards.forEach(n=>this.destroyCardSafely(n)),r.dropZone?.destroy(),r.highlight?.destroy()}),this.allPlayerMelds.set(e,s.slice(0,t))}destroy(){this.clearAllMelds(),this.hideOpponentMelds()}calculateMeldPosition(e,t){const s=this.isMyMeld(t),{width:i,height:r}=this.scene.scale;if(s){const n=e%R.MAX_MELDS_PER_ROW;return{x:i*R.START_X+n*i*R.MELD_SPACING,y:r*R.START_Y}}else{const n=e%R.MAX_MELDS_PER_ROW;return this.config.getOpponentIndex(t),{x:i*K.START_X+n*i*K.MELD_SPACING,y:r*K.START_Y}}}getCardFrame(e){return e.value===14||e.suit==="JOKER_RED"||e.suit==="JOKER_BLACK"?e.suit==="JOKER_RED"?52:53:(fe[e.suit]||0)+e.value-1}isMyMeld(e){return this.config.isMultiplayer()?e===this.config.getMyPlayerIndex():e===0}recreateMeldDropZone(e){const{width:t,height:s}=this.scene.scale;e.dropZone&&(e.dropZone.destroy(),e.dropZone=null),e.highlight&&(e.highlight.destroy(),e.highlight=null);const i=e.cards.length;if(i===0)return;const r=(i-1)*t*R.CARD_OVERLAP/2,n=e.position.x+r,a=e.position.y,l=(i-1)*t*R.CARD_OVERLAP+L*this.getDynamicScale()+R.DROP_ZONE_PADDING*2,d=L*this.getDynamicScale()+R.DROP_ZONE_PADDING*2,c=this.scene.add.rectangle(n,a,l,d).setStrokeStyle(2,65280,0).setFillStyle(65280,0).setDepth(w.CARDS-1),h=this.scene.add.zone(n,a,l,d).setRectangleDropZone(l,d).setData({zoneType:"MELD_TABLE",meldIndex:e.meldIndex,playerIndex:e.meldOwner});h.on("dragenter",()=>{c.setStrokeStyle(3,65280,1),c.setFillStyle(65280,.2)}),h.on("dragleave",()=>{c.setStrokeStyle(2,65280,0),c.setFillStyle(65280,0)}),e.dropZone=h,e.highlight=c}destroyCardSafely(e){if(!(!e||!e.scene)){this.scene.tweens.killTweensOf(e),e.removeAllListeners();try{this.scene.input.setDraggable(e,!1)}catch{}e.destroy()}}}const Se=1280,De=720,O={SPACING:70,CIRCLE_RADIUS:25,INDICATOR_RADIUS:6,CIRCLE_FILL:6710886,CIRCLE_FILL_ACTIVE:8947848,CIRCLE_STROKE:3355443,CIRCLE_STROKE_ACTIVE:16776960,MELD_INDICATOR_COLOR:65280,NAME_FONT_SIZE:"14px",COUNT_FONT_SIZE:"12px"};class Ce{constructor(e,t){this.playerIcons=new Map,this.scene=e,this.config=t}getDynamicScale(){const e=this.scene.scale.width,t=this.scene.scale.height,s=e/Se,i=t/De;let r=Math.min(s,i);return r=Math.max(.6,Math.min(r,1.2)),r}createIcons(){this.destroy();const e=this.config.getPlayersInfo(),t=this.scene.scale.width;let s=0;e.forEach((i,r)=>{if(i.isMe)return;const n=s*O.SPACING,a=this.createPlayerIcon(r,i,t,n);this.playerIcons.set(r,a),s++})}createPlayerIcon(e,t,s,i){const r=this.scene.add.circle(0,0,O.CIRCLE_RADIUS,O.CIRCLE_FILL,1).setStrokeStyle(3,O.CIRCLE_STROKE),n=this.scene.add.text(0,0,this.truncateName(t.name),{fontSize:O.NAME_FONT_SIZE,fontFamily:"Arial",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),a=this.scene.add.text(30,-20,`${t.handSize}`,{fontSize:O.COUNT_FONT_SIZE,fontFamily:"Arial",color:"#ffffff",backgroundColor:"#333333",padding:{x:4,y:2}}).setOrigin(.5),o=this.scene.add.circle(20,20,O.INDICATOR_RADIUS,O.MELD_INDICATOR_COLOR,1).setStrokeStyle(2,16777215).setVisible(t.hasOpened),l=this.scene.add.container(s,i,[r,n,a,o]);return l.setDepth(w.UI),r.setInteractive({useHandCursor:!0}),r.on("pointerdown",()=>{this.config.onPlayerClick?.(e)}),r.on("pointerover",()=>{t.isCurrentPlayer||r.setScale(1.1)}),r.on("pointerout",()=>{r.setScale(1)}),t.isCurrentPlayer&&this.setCurrentPlayerStyle(r,!0),{playerIndex:e,container:l,circle:r,nameText:n,cardCount:a,meldIndicator:o}}updateLayout(){if(this.playerIcons.size===0)return;const e=this.scene.scale.width,t=this.scene.scale.height,s=this.getDynamicScale(),i=e*.95,r=t*.1;let n=0;this.playerIcons.forEach(a=>{const o=r+n*O.SPACING*s;a.container.setScale(s),a.container.setPosition(i,o),n++})}updateAll(){this.config.getPlayersInfo().forEach((t,s)=>{if(t.isMe)return;const i=this.playerIcons.get(s);i&&this.updateIcon(i,t)})}updateIcon(e,t){e.nameText.setText(this.truncateName(t.name)),e.cardCount.setText(`${t.handSize}`),e.meldIndicator.setVisible(t.hasOpened),this.setCurrentPlayerStyle(e.circle,t.isCurrentPlayer)}updateCardCount(e){const s=this.config.getPlayersInfo()[e];if(!s)return;const i=this.playerIcons.get(e);i&&i.cardCount.setText(`${s.handSize}`)}updateMeldStatus(e,t){const s=this.playerIcons.get(e);s&&s.meldIndicator.setVisible(t)}setCurrentPlayer(e){this.playerIcons.forEach(s=>{this.setCurrentPlayerStyle(s.circle,!1)});const t=this.playerIcons.get(e);t&&this.setCurrentPlayerStyle(t.circle,!0)}updatePlayerName(e,t){const s=this.playerIcons.get(e);s&&s.nameText.setText(this.truncateName(t))}setPlayerDisconnected(e,t){const s=this.playerIcons.get(e);s&&(t?s.container.setAlpha(.4):s.container.setAlpha(1))}updateScore(e,t){}pulseIcon(e){const t=this.playerIcons.get(e);t&&this.scene.tweens.add({targets:t.circle,scaleX:1.2,scaleY:1.2,duration:200,yoyo:!0,repeat:2,ease:"Sine.easeInOut"})}shakeIcon(e){const t=this.playerIcons.get(e);if(!t)return;const s=t.container.x;this.scene.tweens.add({targets:t.container,x:s+5,duration:50,yoyo:!0,repeat:5,ease:"Sine.easeInOut",onComplete:()=>{t.container.x=s}})}flashMeldIndicator(e){const t=this.playerIcons.get(e);t&&(t.meldIndicator.setVisible(!0),this.scene.tweens.add({targets:t.meldIndicator,scaleX:1.5,scaleY:1.5,alpha:.5,duration:200,yoyo:!0,repeat:3,ease:"Sine.easeInOut",onComplete:()=>{t.meldIndicator.setScale(1),t.meldIndicator.setAlpha(1)}}))}highlightCardCountChange(e,t){const s=this.playerIcons.get(e);if(!s)return;const i=t?"#00ff00":"#ff6666",r="#ffffff";s.cardCount.setColor(i),this.scene.time.delayedCall(500,()=>{s.cardCount.setColor(r)})}getIcon(e){return this.playerIcons.get(e)}hasIcons(){return this.playerIcons.size>0}getPlayerIndices(){return Array.from(this.playerIcons.keys())}removeIcon(e){const t=this.playerIcons.get(e);t&&(t.circle.removeAllListeners(),t.container.destroy(),this.playerIcons.delete(e))}destroy(){this.playerIcons.forEach(e=>{e.circle.removeAllListeners(),e.container.destroy()}),this.playerIcons.clear()}setCurrentPlayerStyle(e,t){t?(e.setStrokeStyle(3,O.CIRCLE_STROKE_ACTIVE),e.setFillStyle(O.CIRCLE_FILL_ACTIVE)):(e.setStrokeStyle(3,O.CIRCLE_STROKE),e.setFillStyle(O.CIRCLE_FILL))}truncateName(e,t=6){return e.length<=t?e:e.substring(0,t-1)+"â€¦"}}const Me=1280,Ae=720,Z={EXPANSION:60,DRAG_DEPTH:1e3};class Ie{constructor(e,t){this.discardDropZone=null,this.discardHighlight=null,this.isDragEnabled=!0,this.scene=e,this.callbacks=t}setup(){this.scene.input.on(P.Input.Events.DRAG_START,this.onDragStart,this),this.scene.input.on(P.Input.Events.DRAG,this.onDrag,this),this.scene.input.on(P.Input.Events.DRAG_END,this.onDragEnd,this),this.scene.input.on(P.Input.Events.DROP,this.onDrop,this)}teardown(){this.scene.input.off(P.Input.Events.DRAG_START,this.onDragStart,this),this.scene.input.off(P.Input.Events.DRAG,this.onDrag,this),this.scene.input.off(P.Input.Events.DRAG_END,this.onDragEnd,this),this.scene.input.off(P.Input.Events.DROP,this.onDrop,this)}getDynamicScale(){const e=this.scene.scale.width,t=this.scene.scale.height,s=e/Me,i=t/Ae;let r=Math.min(s,i);return r=Math.max(.4,Math.min(r,1.5)),r}createDiscardDropZone(e){const t=e.width??L*this.getDynamicScale()+Z.EXPANSION,s=e.height??U*this.getDynamicScale()+Z.EXPANSION;this.discardDropZone=this.scene.add.zone(e.x,e.y,t,s).setRectangleDropZone(t,s).setData("zoneType","DISCARD"),this.discardDropZone.on("dragenter",()=>{this.discardHighlight?.setStrokeStyle(3,16737894,1),this.discardHighlight?.setFillStyle(16737894,.2)}),this.discardDropZone.on("dragleave",()=>{this.discardHighlight?.setStrokeStyle(3,16737894,0),this.discardHighlight?.setFillStyle(16737894,0)}),this.discardDropZone.on("drop",()=>{this.discardHighlight?.setStrokeStyle(3,16737894,0),this.discardHighlight?.setFillStyle(16737894,0)})}moveDiscardDropZone(e,t){this.discardDropZone&&(this.discardDropZone.setPosition(e,t),this.discardDropZone.setScale(this.getDynamicScale())),this.discardHighlight&&(this.discardHighlight.setPosition(e,t),this.discardHighlight.setScale(this.getDynamicScale()))}getDiscardDropZone(){return this.discardDropZone}setDiscardHighlight(e){this.discardHighlight&&(e?(this.discardHighlight.setStrokeStyle(3,16737894,.5),this.discardHighlight.setFillStyle(16737894,.1)):(this.discardHighlight.setStrokeStyle(3,16737894,0),this.discardHighlight.setFillStyle(16737894,0)))}setEnabled(e){this.isDragEnabled=e}isEnabled(){return this.isDragEnabled}makeDraggable(e,t=!0){this.scene.input.setDraggable(e,t)}snapBack(e,t=!0){const s=e.getData("origX"),i=e.getData("origY");t?this.scene.tweens.add({targets:e,x:s,y:i,duration:150,ease:"Back.easeOut"}):e.setPosition(s,i)}canDropOnDiscard(){const e=this.callbacks.getCurrentPhase();return e!==D.MELD&&e!==D.DISCARD?{success:!1,error:"Draw a card first!"}:this.callbacks.isMyTurn()?{success:!0}:{success:!1,error:"Not your turn!"}}canDropOnMeld(){return this.callbacks.getCurrentPhase()===D.DRAW?{success:!1,error:"Draw a card first!"}:this.callbacks.isMyTurn()?{success:!0}:{success:!1,error:"Not your turn!"}}destroy(){this.teardown(),this.discardDropZone&&(this.discardDropZone.removeAllListeners(),this.discardDropZone.destroy(),this.discardDropZone=null),this.discardHighlight&&(this.discardHighlight.destroy(),this.discardHighlight=null)}onDragStart(e,t){this.isDragEnabled&&(t.setData("origX",t.x),t.setData("origY",t.y),t.setData("wasDropped",!1),t.setDepth(Z.DRAG_DEPTH),this.callbacks.isCardSelected(t)&&this.callbacks.onCardDeselect(t))}onDrag(e,t,s,i){this.isDragEnabled&&t.setPosition(s,i)}onDragEnd(e,t){t.setDepth(w.CARDS),t.getData("wasDropped")||this.snapBack(t,!1),t.setData("wasDropped",!1)}onDrop(e,t,s){switch(t.setData("wasDropped",!0),s.getData("zoneType")){case"CARDS_IN_HAND":this.handleDropOnHand(t,s);break;case"DISCARD":this.handleDropOnDiscard(t);break;case"MELD_TABLE":this.handleDropOnMeld(t,s);break;default:this.snapBack(t)}}handleDropOnHand(e,t){const s=t.getData("positionIndex"),i=this.callbacks.getCardSpriteIndex(e);if(i===-1||i===s){this.callbacks.updateHandDisplay();return}this.callbacks.onHandReorder(i,s)}handleDropOnDiscard(e){const t=this.canDropOnDiscard();if(!t.success){this.callbacks.showMessage(t.error),this.snapBack(e);return}const s=e.cardData;if(!s){console.error("No card data on sprite"),this.snapBack(e);return}this.callbacks.onDiscardDrop(s,e)}handleDropOnMeld(e,t){const s=this.canDropOnMeld();if(!s.success){this.callbacks.showMessage(s.error),this.snapBack(e);return}const i=t.getData("meldIndex"),r=t.getData("playerIndex"),n=e.cardData;if(!n){console.error("No card data on sprite"),this.snapBack(e);return}this.callbacks.onMeldDrop(n,e,r,i)}}const W={INITIAL_DELAY:500,THINK_DELAY:500,MELD_ADDITION_DELAY:200,DISCARD_DELAY:500};class Re{constructor(e,t,s){this.aiPlayers=new Map,this.currentTurnId=null,this.isProcessingTurn=!1,this.scene=e,this.callbacks=t,this.config={difficulty:s?.difficulty??H.HARD,thinkDelay:s?.thinkDelay??800,randomness:s?.randomness??.1}}initialize(e=2,t){let s,i;if(t!==void 0)s=e,i=t;else{const r=this.callbacks.getLogic();let n=2;try{const a=r?.getState?.();a?.numPlayers&&(n=a.numPlayers)}catch{console.log("[AIManager] Game not started yet, using default 2 players")}s=n,i=e===2?0:e}this.initializeForPlayers(s,i)}initializeForPlayers(e=2,t=0){this.aiPlayers.clear(),this.currentTurnId=null,this.isProcessingTurn=!1,e<2&&(console.warn(`[AIManager] numPlayers (${e}) too low, using 2`),e=2),(t<0||t>=e)&&(console.warn(`[AIManager] humanPlayerIndex (${t}) out of range, using 0`),t=0),console.log(`[AIManager] Initializing for ${e} players, human is player ${t}`);for(let s=0;s<e;s++)s!==t&&(console.log(`[AIManager] Creating AI player for index ${s}`),this.aiPlayers.set(s,new ee({difficulty:this.config.difficulty,thinkDelay:this.config.thinkDelay,randomness:this.config.randomness})));console.log(`[AIManager] Initialized ${this.aiPlayers.size} AI players for indices: ${Array.from(this.aiPlayers.keys()).join(", ")}`)}initializeWithPlayerCount(e,t=0){this.initializeForPlayers(e,t)}setDifficulty(e){switch(this.config.difficulty=e,e){case H.EASY:this.config.randomness=.3;break;case H.MEDIUM:this.config.randomness=.15;break;case H.HARD:this.config.randomness=.08;break;case H.EXPERT:this.config.randomness=.02;break}const t=Array.from(this.aiPlayers.keys());for(const s of t)this.aiPlayers.set(s,new ee({difficulty:this.config.difficulty,thinkDelay:this.config.thinkDelay,randomness:this.config.randomness}))}getAIPlayer(e){if(e!==void 0)return this.aiPlayers.get(e)||null;const t=this.aiPlayers.values().next();return t.done?null:t.value}isInitialized(){return this.aiPlayers.size>0}notifyOpponentDiscard(e,t){this.aiPlayers.forEach(s=>{typeof s.updateOpponentModel=="function"&&s.updateOpponentModel(e,"discard",t)})}notifyOpponentPickDiscard(e,t){this.aiPlayers.forEach(s=>{typeof s.updateOpponentModel=="function"&&s.updateOpponentModel(e,"pick_discard",t)})}notifyOpponentDrawDeck(e){this.aiPlayers.forEach(t=>{typeof t.updateOpponentModel=="function"&&t.updateOpponentModel(e,"draw_deck")})}notifyOpponentLayMelds(e,t){this.aiPlayers.forEach(s=>{typeof s.updateOpponentModel=="function"&&s.updateOpponentModel(e,"lay_melds",void 0,t)})}notifyOpponentOpened(e){this.aiPlayers.forEach(t=>{typeof t.updateOpponentModel=="function"&&t.updateOpponentModel(e,"open")})}runTurn(){if(!this.canRunTurn())return console.log("[AIManager] Cannot run turn"),!1;const e=this.callbacks.getLogic();if(!e)return console.log("[AIManager] No game logic"),!1;const s=e.getState().currentPlayer,i=Date.now();return this.currentTurnId=i,this.isProcessingTurn=!0,this.executeTurnSequenceSafe(i,s),!0}cancelTurn(){console.log("[AIManager] Cancelling turn"),this.currentTurnId=null,this.isProcessingTurn=!1}isTurnRunning(){return this.isProcessingTurn}canRunTurn(){const e=this.callbacks.getLogic();if(!e)return console.log("[AIManager] canRunTurn: no logic"),!1;let t;try{t=e.getState()}catch{return console.log("[AIManager] canRunTurn: game not started"),!1}return t?t.phase===D.GAME_OVER?(console.log("[AIManager] canRunTurn: game over"),!1):!(t.currentPlayer===0||((this.aiPlayers.size===0||!this.aiPlayers.has(t.currentPlayer))&&(console.log(`[AIManager] Auto-initializing AI players (current player ${t.currentPlayer} not found)`),this.initializeForPlayers(t.numPlayers,0)),!this.aiPlayers.has(t.currentPlayer))||this.isProcessingTurn):(console.log("[AIManager] canRunTurn: no state"),!1)}resetForNewGame(e,t=0){console.log(`[AIManager] Resetting for new game with ${e} players`),this.cancelTurn(),this.aiPlayers.clear(),this.initializeForPlayers(e,t)}shouldDrawFromDiscard(e){const t=this.callbacks.getLogic(),s=this.aiPlayers.get(e);if(!t||!s)return!1;try{return s.shouldDrawFromDiscard(t,e)}catch(i){return console.error("[AIManager] Error in shouldDrawFromDiscard:",i),!1}}shouldTakeFinishingCard(e){const t=this.callbacks.getLogic(),s=this.aiPlayers.get(e);if(!t||!s)return!1;try{return s.shouldTakeFinishingCard(t,e)}catch(i){return console.error("[AIManager] Error in shouldTakeFinishingCard:",i),!1}}planTurn(e){const t=this.callbacks.getLogic(),s=this.aiPlayers.get(e);if(!t||!s)return null;try{return s.planMeldAndDiscard(t,e)}catch(i){return console.error("[AIManager] Error in planTurn:",i),null}}destroy(){this.cancelTurn(),this.aiPlayers.clear()}executeTurnSequenceSafe(e,t){const s=async()=>{try{await this.executeTurnSequenceAsync(e,t)}catch(i){console.error("[AIManager] Critical error in turn execution:",i),this.forceCompleteTurn(e)}};this.scene.time.delayedCall(W.INITIAL_DELAY,()=>{s()})}async executeTurnSequenceAsync(e,t){if(!this.validateTurn(e,t)){this.forceCompleteTurn(e);return}if(!this.executeDrawPhase(t)){console.error(`[AIManager] AI ${t} draw failed`),this.forceCompleteTurn(e);return}if(this.callbacks.updatePlayerIcons(),await this.delay(W.THINK_DELAY),!this.validateTurn(e,t)){this.forceCompleteTurn(e);return}const i=this.executeMeldPhase(t);if(!i){console.error(`[AIManager] AI ${t} meld planning failed`),this.forceCompleteTurn(e);return}const r=i.cardsToAddToMelds??[];if(r.length>0)for(let n=0;n<r.length;n++){if(await this.delay(W.MELD_ADDITION_DELAY),!this.validateTurn(e,t)){this.forceCompleteTurn(e);return}this.executeMeldAddition(t,r[n])}if(await this.delay(W.DISCARD_DELAY),!this.validateTurn(e,t)){this.forceCompleteTurn(e);return}this.executeDiscardPhase(t,i),this.callbacks.updatePlayerIcons(),this.completeTurn(e)}delay(e){return new Promise(t=>{this.scene.time.delayedCall(e,t)})}executeDrawPhase(e){const t=this.callbacks.getLogic(),s=this.aiPlayers.get(e);if(!t||!s)return console.error("[AIManager] Draw phase: missing logic or AI player"),!1;try{if(s.shouldTakeFinishingCard(t,e)&&t.takeFinishingCard(e))return this.callbacks.showMessage("AI took the finishing card! ðŸƒ"),console.log(`[AIManager] AI ${e} took finishing card`),!0;if(s.shouldDrawFromDiscard(t,e)){const r=t.getState().topDiscardCard;if(t.drawFromDiscard(e))return console.log(`[AIManager] AI ${e} drew from discard`),r&&this.notifyOpponentPickDiscard(e,r),!0}const i=t.drawCard(e);return i&&this.notifyOpponentDrawDeck(e),i}catch(i){console.error("[AIManager] Error in draw phase:",i);try{return t.drawCard(e)}catch(r){return console.error("[AIManager] Even fallback draw failed:",r),!1}}}executeMeldPhase(e){const t=this.callbacks.getLogic(),s=this.aiPlayers.get(e);if(!t||!s)return console.error("[AIManager] Meld phase: missing logic or AI player"),null;try{const i=s.planMeldAndDiscard(t,e);return i.meldsToLay.length>0&&t.layDownMelds(e,i.meldsToLay)&&(console.log(`[AIManager] AI ${e} laid ${i.meldsToLay.length} melds`),this.callbacks.onOpponentOpened(e),this.notifyOpponentLayMelds(e,i.meldsToLay),this.notifyOpponentOpened(e)),i}catch(i){console.error("[AIManager] Error in meld phase:",i);const r=t.getPlayerHand(e);return r.length>0?{meldsToLay:[],cardToDiscard:r[0],cardsToAddToMelds:[]}:null}}executeMeldAddition(e,t){const s=this.callbacks.getLogic();if(s)try{s.addCardToMeld(e,t.card,t.meldOwner,t.meldIndex)}catch(i){console.error("[AIManager] Error adding to meld:",i)}}executeDiscardPhase(e,t){const s=this.callbacks.getLogic(),i=this.aiPlayers.get(e);if(!s){console.error("[AIManager] Discard phase: missing logic");return}try{const r=s.getPlayerHand(e);if(r.length===0)return;let n=r.find(a=>a.id===t.cardToDiscard.id);!n&&i&&(n=i.selectBestDiscardAdvanced(r,s.getState(),e,s,r)),n||(n=r[0]),s.discardCard(e,n),this.notifyOpponentDiscard(e,n)}catch(r){console.error("[AIManager] Error in discard phase:",r);try{const n=s.getPlayerHand(e);n.length>0&&s.discardCard(e,n[0])}catch(n){console.error("[AIManager] Emergency discard failed:",n)}}}validateTurn(e,t){if(this.currentTurnId!==e)return!1;const s=this.callbacks.getLogic();if(!s)return!1;const i=s.getState();return!(i.phase===D.GAME_OVER||i.currentPlayer!==t)}completeTurn(e){this.currentTurnId===e&&(console.log(`[AIManager] Turn ${e} completed normally`),this.currentTurnId=null,this.isProcessingTurn=!1,this.callbacks.onAITurnComplete?.())}forceCompleteTurn(e){this.currentTurnId=null,this.isProcessingTurn=!1,this.callbacks.onAITurnComplete?.()}}class z{constructor(e,t,s=!1,i){this.faceUp=s,this.suit=e,this.value=t,this.serverId=i,this.id=i||`${e}_${t}_${this.#t()}`}get isFaceUp(){return this.faceUp}flip(){this.faceUp=!this.faceUp}#t(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID().slice(0,8):`${Date.now().toString(36)}_${Math.random().toString(36).slice(2,9)}`}equals(e){return this.id===e.id}toString(){return`${this.value}${this.suit[0]} [${this.id.slice(-8)}]`}static getScoreValueFromData(e){const t=e.suit,s=e.value;if(t==="JOKER_RED"||t==="JOKER_BLACK")return 25;if(typeof s=="string")switch(s){case"Ace":case"King":case"Queen":case"Jack":return 10;default:const i=parseInt(s);return isNaN(i)?5:i}return typeof s=="number"?s>=11&&s<=14?10:s:5}get isJoker(){return this.suit==="JOKER_RED"||this.suit==="JOKER_BLACK"}toCardData(){return{id:this.id,suit:this.suit,value:this.value,isFaceUp:this.isFaceUp}}}const Ee={HEART:"HEART",DIAMOND:"DIAMOND",SPADE:"SPADE",CLUB:"CLUB",JOKER_RED:"JOKER_RED",JOKER_BLACK:"JOKER_BLACK"};function Pe(u){for(let e=u.length-1;e>0;e-=1){const t=Math.floor(Math.random()*e),s=u[e];u[e]=u[t],u[t]=s}}class we{#t;#s;#e;constructor(e=1){this.#t=[],this.#s=[],this.#e=[];for(let t=0;t<e;t++)this.#r();this.reset()}get cards(){return this.#t}get drawPile(){return this.#s}get discardPile(){return this.#e}reset(){this.#e=[],this.#s=[...this.#t],this.shuffle()}shuffle(){Pe(this.#s)}draw(){return this.#s.shift()}shuffleInDiscardPile(){this.#e.forEach(e=>{e.flip(),this.#s.push(e)}),this.#e=[]}#r(){const e=Object.values(Ee),t=14;for(let s=0;s<4;s+=1)for(let i=1;i<14;i+=1)this.#t.push(new z(e[s],i));this.#t.push(new z(e[e.length-1],t)),this.#t.push(new z(e[e.length-2],t))}}class N{static isValidSet(e){return I.isValidSet(C(e))}static isValidRun(e){return I.isValidRun(C(e))}static isValidMeld(e){return I.isValidMeld(C(e))}static mapCardDataToCards(e,t){const s=new Map(t.map(i=>[i.id,i]));return e.map(i=>{const r=s.get(i.id);if(!r)throw new Error(`Card ${i.id} not found in original array`);return r})}static splitIntoMeldGroups(e){const t=C(e);return I.splitIntoMeldGroups(t).map(i=>this.mapCardDataToCards(i,e))}static findBestMeldCombination(e){const t=C(e);return I.findBestMeldCombination(t).map(i=>this.mapCardDataToCards(i,e))}static sortRunCards(e){const t=C(e),s=I.sortRunCards(t);return this.mapCardDataToCards(s,e)}static sortMeldForDisplay(e){const t=C(e),s=I.sortMeldForDisplay(t);return this.mapCardDataToCards(s,e)}static canCardReplaceJoker(e,t,s){const i=C([e])[0],r=C([t])[0],n=C(s);return I.canCardReplaceJoker(i,r,n)}static canCardsBeAdjacent(e,t){const s=C([e])[0],i=C([t])[0];return I.canCardsBeAdjacent(s,i)}static calculateMeldScore(e){return I.calculateMeldScore(C(e))}static validateMelds(e,t,s=51){const i=C(e),r=I.validateMelds(i,t,s);return{...r,selectedCards:e,validMelds:r.validMelds.map(n=>n.map(a=>this.findCardById(e,a.id))),invalidCards:r.invalidCards.map(n=>this.findCardById(e,n.id))}}static findCardById(e,t){const s=e.find(i=>i.id===t);if(!s)throw new Error(`Card ${t} not found`);return s}static getJokerValueInMeld(e,t){const s=C([e])[0],i=C(t);return I.getJokerValueInMeld(s,i)}static getJokerRepresentedValueInRun(e,t){const s=C([e])[0],i=C(t);return I.getJokerRepresentedValueInRun(s,i)}static buildSequenceWithJokers(e,t){const s=C(e);return I.buildSequenceWithJokers(s,t)}static canAddToMeld(e,t){return I.getAddPosition(C([e])[0],C(t))}static getMeldType(e){return I.getMeldType(C(e))}static isJoker(e){return e.suit==="JOKER_RED"||e.suit==="JOKER_BLACK"}static getCardPoints(e){return this.isJoker(e)?0:e.value===1?10:e.value>=2&&e.value<=10?e.value:e.value>=11&&e.value<=13||e.value===14?10:0}}class ve{constructor(){this.#t=new de,this.#e=[],this.#r=[],this.#n=[],this.#i=0,this.#a=D.DRAW,this.#g=0,this.#d=[],this.#c=0,this.#h=!1,this.#u=null,this.#o=null,this.#l=!1,this.gameStateSnapshot=null}#t;#s;#e;#r;#n;#i;#a;#g;#d;#c;#h;#u;#o;#l;on(e,t){return this.#t.on(e,t)}newGame(e=2){this.#g=e,this.#i=0,this.#a=D.DRAW,this.#s=new we(2),this.#e=[],this.#r=[],this.#n=Array(e).fill(!1),this.#d=[],this.#c=0;for(let s=0;s<e;s++)this.#e[s]=[],this.#r[s]=[];for(let s=0;s<14;s++)for(let i=0;i<e;i++){const r=this.#s.draw();r.flip(),this.#e[i].push(r)}const t=this.#s.drawPile.filter(s=>!this.#p(s));if(t.length>0){const s=Math.floor(Math.random()*t.length);this.#o=t[s]}else this.#o=null,console.warn("The draw pile contains no non-Joker cards to select from.");this.#t.emit({type:A.GAME_STARTED,timestamp:Date.now(),numPlayers:e,startingPlayer:0}),this.#t.emit({type:A.PLAYER_TURN_STARTED,timestamp:Date.now(),playerIndex:0,phase:D.DRAW})}getFinishingCard(){return this.#o}hasDrawnFinishingCard(){return this.#l}canPlayerFinishNow(e){return this.getPlayerHand(e).length<2}getDiscardCard(){return this.#u}hasDrawnFromDiscard(){return this.#h}setDiscardCard(e=null){this.#u=e}setHasDrawnFromDiscard(e=!1){this.#h=e}#f(){const e=this.getState(),t=this.#e.map((r,n)=>({id:`player_${n}`,name:`Player ${n+1}`,handSize:r.length,hasOpened:this.#n[n]||!1,melds:this.#r[n]?.map(a=>a.map(o=>C([o])[0]))||[],hand:r.map(a=>C([a])[0])})),s=e.topDiscardCard?C([e.topDiscardCard])[0]:null,i=this.#o?C([this.#o])[0]:null;return{currentPlayerId:`player_${this.#i}`,phase:e.phase,players:t,drawPileSize:e.drawPileSize,discardPileTop:s,finishingCard:i,finishingCardDrawn:this.#l}}drawCard(e){const t=this.#f(),s=`player_${e}`;if(!V.canDrawFromDeck(s,t).valid)return!1;const r=t.players.find(a=>a.id===s);if(r&&!V.validateHandSizeForAction("DRAW",r.handSize,r.hasOpened).valid)return!1;const n=this.#s.draw();return n.flip(),this.#e[e].push(n),this.#t.emit({type:A.CARD_DRAWN_FROM_DECK,timestamp:Date.now(),playerIndex:e,card:n,handSize:this.#e[e].length}),this.setPhase(D.MELD),!0}restoreState(e){if(this.#e[0]=e.hand.map(t=>{const s=new z(t.suit,t.value);return t.isFaceUp&&s.flip(),s}),this.#r[0]=e.melds.map(t=>t.map(s=>{const i=new z(s.suit,s.value);return s.isFaceUp&&i.flip(),i})),e.finishingCard!==void 0&&this.setFinishingCard(e.finishingCard),e.discardCard){const t=new z(e.discardCard.suit,e.discardCard.value);e.discardCard.isFaceUp&&t.flip(),this.#s.discardPile.some(i=>i.id===t.id)||this.#s.discardPile.push(t)}this.#a=e.phase,this.#d=[],this.#c=0}drawFromDiscard(e){const t=this.#f(),s=`player_${e}`,i=V.canDrawFromDiscard(s,t);if(!i.valid)return console.log("Draw from discard validation failed:",i.error),!1;this.setHasDrawnFromDiscard(!0);const r=this.#s.discardPile.pop();return r.flip(),this.#e[e].push(r),this.setDiscardCard(r),this.#t.emit({type:A.CARD_DRAWN_FROM_DISCARD,timestamp:Date.now(),playerIndex:e,card:r,handSize:this.#e[e].length}),this.setPhase(D.MELD),!0}takeFinishingCard(e){const t=this.#f(),s=`player_${e}`,i=V.canTakeFinishingCard(s,t);if(!i.valid)return console.log("Take finishing card validation failed:",i.error),!1;const r=this.#o;return this.#o=null,this.#l=!0,r===null?!1:(r.flip(),this.#e[e].push(r),this.#t.emit({type:A.FINISHING_CARD,timestamp:Date.now(),playerIndex:e,card:r,handSize:this.#e[e].length}),this.setPhase(D.MELD),!0)}saveGameStateSnapshot(){const e=this.getPlayerHand(0),t=this.getPlayerMelds(0),s=this.getState().phase;this.gameStateSnapshot={hand:e,melds:t,phase:s,finishingCard:this.getFinishingCard(),discardCard:this.getState().topDiscardCard},console.log("Game state saved for potential undo")}setFinishingCardDrawn(e=!1){this.#l=e}getFinishingState(){return this.#l}setFinishingCard(e=null){this.#o=e}returnCardToDiscard(e){this.#s.discardPile.push(e)}removeLastMeld(e){const t=this.#r[e];if(t.length===0)return!1;const s=t.pop(),i=this.#e[e];return s.forEach(r=>i.push(r)),!0}checkGameOver(){this.#e[this.#i].length===0&&this.endGame(this.#i)}validateMelds(e,t){const s=this.#n[e],i=N.validateMelds(t,s,51);return{selectedCards:t,validMelds:i.validMelds,invalidCards:i.invalidCards,totalScore:i.totalScore,meldScores:i.meldScores,meetsOpenRequirement:i.meetsOpenRequirement,minimumNeeded:i.minimumNeeded,hasOpened:s}}#I(e){for(const t of this.#e){const s=t.find(i=>i.id===e);if(s)return s}for(const t of this.#r)for(const s of t){const i=s.find(r=>r.id===e);if(i)return i}throw new Error(`Card ${e} not found in game`)}currentScore(){return this.#c}layDownMelds(e,t){if(this.#a!==D.MELD&&this.#a!==D.DISCARD||e!==this.#i)return!1;const s=this.#e[e];if(!t.flat().every(l=>s.includes(l))||!t.every(l=>this.#S(l)||this.#D(l)))return!1;const n=this.#n[e],a=this.#C(t);if(!n&&a<51)return!1;const o=t.map(l=>this.#y(l));return o.flat().forEach(l=>{const d=s.indexOf(l);d>-1&&s.splice(d,1)}),this.#r[e].push(...o),n||(this.#n[e]=!0),this.#c=0,this.#d=[],this.#t.emit({type:A.MELDS_LAID_DOWN,timestamp:Date.now(),playerIndex:e,melds:o,meldScore:a,playerHasOpened:this.#n[e]}),!0}#y(e){return N.sortMeldForDisplay(e)}#R(e){return N.sortRunCards(e)}addCardToMeld(e,t,s,i){console.log("addCardToMeld called:",{playerIndex:e,cardId:t.id,meldOwner:s,meldIndex:i});const r=this.#e[e],n=this.#r[s]?.[i];if(!n)return!1;const a=n.findIndex(d=>this.#p(d));if(a!==-1){const d=n[a];if(N.canCardReplaceJoker(t,d,n)){const c=r.indexOf(t);return r.splice(c,1),n[a]=t,r.push(d),this.#m(n),this.#t.emit({type:A.CARD_ADDED_TO_MELD,timestamp:Date.now(),playerIndex:e,card:t,meldIndex:i,meldOwner:s,replacedJoker:d}),!0}}const o=N.canAddToMeld(t,n);if(this.#a!==D.MELD&&this.#a!==D.DISCARD)return console.log("âŒ Failed: Wrong phase. Current:",this.#a),!1;if(e!==this.#i)return console.log("âŒ Failed: Not current player. Expected:",this.#i,"Got:",e),!1;if(!this.#n[e]||!this.#n[s])return console.log("âŒ Failed: Players not opened.",{playerOpened:this.#n[e],ownerOpened:this.#n[s]}),!1;if(!n)return console.log("âŒ Failed: Meld not found.",{meldOwner:s,meldIndex:i,ownerMelds:this.#r[s]?.length??0}),!1;if(!r.includes(t))return console.log("âŒ Failed: Card not in hand!",{cardId:t.id,handCardIds:r.map(d=>d.id),cardInHandById:r.some(d=>d.id===t.id)}),!1;if(!o)return console.log("âŒ Failed: ValidationBridge.canAddToMeld returned null",{card:{id:t.id,suit:t.suit,value:t.value},meldCards:n.map(d=>({id:d.id,suit:d.suit,value:d.value}))}),!1;if(console.log("âœ… All checks passed, proceeding with add"),!r.includes(t)||!o)return!1;const l=r.indexOf(t);return r.splice(l,1),n.push(t),this.#m(n),this.#t.emit({type:A.CARD_ADDED_TO_MELD,timestamp:Date.now(),playerIndex:e,card:t,meldIndex:i,meldOwner:s,replacedJoker:null}),!0}#m(e){const t=N.sortMeldForDisplay(e);e.length=0,e.push(...t)}#E(e,t,s){return N.canCardReplaceJoker(e,t,s)}discardCard(e,t){const s=this.#f(),i=`player_${e}`,r=this.#e[e],n=r.map(l=>C([l])[0]),a=V.canDiscard(i,t.id,s,n);if(!a.valid)return console.log("Discard validation failed:",a.error),!1;const o=r.indexOf(t);return o===-1?!1:(r.splice(o,1),this.#s.discardPile.push(t),this.#t.emit({type:A.CARD_DISCARDED,timestamp:Date.now(),playerIndex:e,card:t,handSize:r.length}),r.length===0?(this.endGame(e),!0):(this.endTurn(),!0))}reorderHand(e,t,s){const i=this.#e[e],r=`player_${e}`;if(!V.canReorderHand(r,t,s,i.length).valid)return!1;const[a]=i.splice(t,1);return i.splice(s,0,a),!0}getState(){return{currentPlayer:this.#i,phase:this.#a,numPlayers:this.#g,drawPileSize:this.#s.drawPile.length,discardPileSize:this.#s.discardPile.length,topDiscardCard:this.#s.discardPile[this.#s.discardPile.length-1]||null,playersHaveOpened:[...this.#n],handSizes:this.#e.map(e=>e.length)}}getPlayerHand(e){return[...this.#e[e]||[]]}getPlayerMelds(e){return this.#r[e]?.map(t=>[...t])||[]}getCurrentMelds(){return this.#d}hasPlayerOpened(e){return this.#n[e]||!1}setPhase(e){this.#a=e,this.#t.emit({type:A.PHASE_CHANGED,timestamp:Date.now(),newPhase:e,currentPlayer:this.#i})}endTurn(){const e=this.#i;this.#i=(this.#i+1)%this.#g,this.#h=!1,this.#u=null,this.#l=!1,this.gameStateSnapshot=null,this.#t.emit({type:A.TURN_ENDED,timestamp:Date.now(),previousPlayer:e,nextPlayer:this.#i}),this.setPhase(D.DRAW),this.#t.emit({type:A.PLAYER_TURN_STARTED,timestamp:Date.now(),playerIndex:this.#i,phase:this.#a})}endGame(e){this.setPhase(D.GAME_OVER),this.#h=!1,this.#u=null,this.#l=!1,this.gameStateSnapshot=null;const t=this.#e.map(s=>s.reduce((i,r)=>i+this.#A(r),0));this.#t.emit({type:A.GAME_OVER,timestamp:Date.now(),winner:e,scores:t})}#S(e){return N.isValidSet(e)}#D(e){return N.isValidRun(e)}#P(e){return N.isValidMeld(e)}#C(e){return e.reduce((t,s)=>t+this.#M(s),0)}#M(e){return N.calculateMeldScore(e)}#A(e){return this.#p(e)?0:e.value===1?10:e.value>=2&&e.value<=10?e.value:e.value>=11&&e.value<=13||e.value===14?10:0}#w(e,t){return N.canCardsBeAdjacent(e,t)}#p(e){return e.suit==="JOKER_RED"||e.suit==="JOKER_BLACK"}}class Te{constructor(e,t){this.logic=null,this.undoEnabled=!1,this.currentRound=1,this.totalRounds=3,this.gameScene=e,this.config=t}setup(){console.log("ðŸŽ® Setting up single-player mode"),this.logic=new ve;const{width:e,height:t}=this.gameScene.scale;this.setupEventListeners(),this.gameScene.aiManager.initialize();const s=this.config.numPlayers??4;this.totalRounds=this.config.numRounds??3,this.logic.newGame(s),this.gameScene.meldManager.initializeForPlayers(s),this.gameScene.setIsMyTurn(!0),console.log("âœ… Single-player game started")}getLogic(){return this.logic}hasPlayerOpened(e=0){return this.logic?.hasPlayerOpened(e)??!1}getPlayerMelds(e){return this.logic?.getPlayerMelds(e)??[]}destroy(){this.logic&&(this.logic=null),this.undoEnabled=!1,this.currentRound=1}handleDrawPileClick(){return this.logic?this.logic.drawCard(0):!1}handleDiscardPileClick(){return this.logic?(this.logic.saveGameStateSnapshot(),this.undoEnabled=!0,this.logic.drawFromDiscard(0)):!1}handleFinishingCardClick(){return this.logic?this.logic.hasPlayerOpened(0)?(this.gameScene.showMessage("You can't take the finishing card if you already have melds!"),!1):(this.logic.saveGameStateSnapshot(),this.undoEnabled=!0,this.logic.takeFinishingCard(0)):!1}handleDiscard(e,t){const{width:s,height:i}=this.gameScene.scale;if(!this.logic)return!1;if(this.logic.hasDrawnFromDiscard()&&this.logic.getDiscardCard()&&!this.checkIfDiscardCardWasUsed())return this.gameScene.showUndoOption(t,()=>this.executeUndo(),()=>this.gameScene.showMessage("Moras ili odigrati uzetu kartu ili se vratiti na pocetak poteza!",1e4)),!1;if(this.logic.hasDrawnFinishingCard()&&this.gameScene.handManager.getHandCards().length>1)return this.gameScene.showFinishingCardUndoOption(t,()=>this.executeFinishingCardUndo(),()=>this.gameScene.showMessage("Moras ili zavrsiti igru ili se vratiti na pocetak poteza!",1e4)),!1;if(this.logic.discardCard(0,e)){this.gameScene.handManager.removeCard(e),this.gameScene.handManager.updateHandDisplay(),this.gameScene.handManager.updateHandDropZones();const n=this.gameScene.handManager.getCardFrame(e);return this.gameScene.tweens.add({targets:t,x:s*this.config.layout.DISCARD_PILE.x,y:i*this.config.layout.DISCARD_PILE.y,duration:150,ease:"Power2",onComplete:()=>{this.gameScene.discardPileSprite&&this.gameScene.discardPileSprite.setFrame(n).setVisible(!0),this.gameScene.handManager.destroyCardSafely(t)}}),this.gameScene.playerIconManager.updateAll(),this.undoEnabled=!1,!0}return!1}handleAddToMeld(e,t,s){return this.logic?this.logic.addCardToMeld(0,e,t,s):!1}handleLayMelds(e){if(!this.logic)return!1;const t=this.logic.validateMelds(0,e);return!t.validMelds||t.validMelds.length===0?(this.gameScene.showMessage("Invalid melds"),!1):!this.logic.hasPlayerOpened(0)&&t.totalScore<51?(this.gameScene.showMessage("Need at least 51 points to open"),!1):this.gameScene.handManager.getHandCards().length===e.length?(this.gameScene.showMessage("Must keep at least one card to discard"),!1):this.logic.layDownMelds(0,t.validMelds)}handleReorderHand(e,t){this.logic?.reorderHand(0,e,t)}executeUndo(){if(!this.logic||!this.logic.gameStateSnapshot){console.error("No snapshot to restore!");return}console.log("Executing undo...");const e=this.logic.gameStateSnapshot.melds.length;this.gameScene.meldManager.clearMeldsAfterIndex(0,e),this.logic.restoreState(this.logic.gameStateSnapshot),this.updateDiscardPileVisual();const t=this.logic.getPlayerHand(0);this.gameScene.handManager.setHand(t),this.gameScene.time.delayedCall(300,()=>{this.logic?.drawCard(0)?(this.gameScene.showMessage("Drew from deck instead"),this.logic?.setHasDrawnFromDiscard(),this.logic?.setDiscardCard(),this.logic&&(this.logic.gameStateSnapshot=null)):console.error("Draw failed!")})}executeFinishingCardUndo(){if(!this.logic||!this.logic.gameStateSnapshot){console.error("No snapshot to restore!");return}const e=this.logic.gameStateSnapshot.melds.length;this.gameScene.meldManager.clearMeldsAfterIndex(0,e),this.logic.restoreState(this.logic.gameStateSnapshot);const t=this.logic.getFinishingCard(),s=this.logic.getPlayerHand(0);this.gameScene.handManager.setHand(s),t&&this.gameScene.finishingCardSprite&&(this.gameScene.finishingCardSprite.setVisible(!0),this.logic.setFinishingCard(t)),this.gameScene.time.delayedCall(300,()=>{this.logic?.drawCard(0),this.gameScene.showMessage("Drew from deck instead"),this.logic?.setFinishingCardDrawn(!1),this.logic&&(this.logic.gameStateSnapshot=null),this.undoEnabled=!1})}canUndo(){return this.undoEnabled&&this.logic?.gameStateSnapshot!==void 0}setupEventListeners(){this.logic&&(this.logic.on(A.GAME_STARTED,e=>this.onGameStarted(e)),this.logic.on(A.CARD_DRAWN_FROM_DECK,e=>this.onCardDrawn(e)),this.logic.on(A.CARD_DRAWN_FROM_DISCARD,e=>this.onCardDrawnFromDiscard(e)),this.logic.on(A.FINISHING_CARD,e=>this.onFinishingCardDrawn(e)),this.logic.on(A.CARD_DISCARDED,e=>this.onCardDiscarded(e)),this.logic.on(A.MELDS_LAID_DOWN,e=>this.onMeldsLaidDown(e)),this.logic.on(A.CARD_ADDED_TO_MELD,e=>this.onCardAddedToMeld(e)),this.logic.on(A.PHASE_CHANGED,e=>this.onPhaseChanged(e)),this.logic.on(A.TURN_ENDED,e=>this.onTurnEnded(e)),this.logic.on(A.PLAYER_TURN_STARTED,e=>this.onPlayerTurnStarted(e)),this.logic.on(A.GAME_OVER,e=>this.onGameOver(e)))}onGameStarted(e){const{width:t,height:s}=this.gameScene.scale;console.log("ðŸŽ² Game started event received"),this.gameScene.createDrawPile(),this.gameScene.createDiscardPile(),this.gameScene.createFinishingCardDisplay(),this.gameScene.dragDropManager.createDiscardDropZone({x:t*this.config.layout.DISCARD_PILE.x,y:s*this.config.layout.DISCARD_PILE.y}),this.gameScene.playerIconManager.createIcons();const i=this.logic.getPlayerHand(0);this.gameScene.handManager.setHand(i),this.updateDiscardPileVisual(),this.gameScene.updatePhaseUI(),this.gameScene.updateScoreDisplay?.()}onCardDrawn(e){const{width:t,height:s}=this.gameScene.scale;if(e.playerIndex!==0)return;const i=e.card;this.gameScene.handManager.addCard(i,t*this.config.layout.DRAW_PILE.x,s*this.config.layout.DRAW_PILE.y),this.gameScene.playerIconManager.updateAll(),this.gameScene.setCurrentPhase(D.MELD),this.gameScene.updatePhaseUI(),this.gameScene.updateMeldUI()}onCardDrawnFromDiscard(e){const{width:t,height:s}=this.gameScene.scale;if(e.playerIndex!==0)return;const i=e.card;this.gameScene.handManager.addCard(i,t*this.config.layout.DISCARD_PILE.x,s*this.config.layout.DISCARD_PILE.y),this.gameScene.time.delayedCall(F.ANIMATION_DURATION,()=>{this.updateDiscardPileVisual()}),this.gameScene.setCurrentPhase(D.MELD),this.gameScene.updatePhaseUI(),this.gameScene.updateMeldUI()}onFinishingCardDrawn(e){const{width:t,height:s}=this.gameScene.scale;if(e.playerIndex!==0)return;const i=e.card;this.gameScene.handManager.addCard(i,t*this.config.layout.FINISHING_CARD.x,s*this.config.layout.FINISHING_CARD.y),this.gameScene.finishingCardSprite&&this.gameScene.finishingCardSprite.setVisible(!1),this.gameScene.showMessage("Drew finishing card - you must go all out this turn!")}onCardDiscarded(e){e.playerIndex!==0&&(this.updateDiscardPileVisual(),this.gameScene.playerIconManager.updateCardCount(e.playerIndex),this.gameScene.playerIconManager.highlightCardCountChange(e.playerIndex,!1))}onMeldsLaidDown(e){const{playerIndex:t,melds:s}=e,i=this.gameScene.meldManager.getPlayerMelds(t).length;if(s.forEach((r,n)=>{const a=i+n;this.gameScene.meldManager.createMeldVisual(t,r,a)}),t===0){const r=new Set(s.flat().map(n=>n.id));this.gameScene.handManager.removeCardsByIds(r)}this.gameScene.updateMeldUI(),this.gameScene.playerIconManager.updateMeldStatus(t,!0),t!==0&&this.gameScene.playerIconManager.flashMeldIndicator(t)}onCardAddedToMeld(e){const{playerIndex:t,card:s,meldOwner:i,meldIndex:r,replacedJoker:n}=e,a=this.gameScene.meldManager.getMeld(i,r);if(!a){console.error("Meld not found");return}let l=[...this.logic?.getPlayerMelds(i)?.[r]??[]];if(l.length>0){const d=l.filter(h=>!h.suit.includes("JOKER")),c=d.length>0&&d.every(h=>h.suit===d[0].suit);l.sort((h,g)=>{const p=h.suit.includes("JOKER"),y=g.suit.includes("JOKER");if(p&&y)return h.suit.localeCompare(g.suit);if(p&&!y)return 1;if(!p&&y)return-1;if(c)return h.value-g.value;{const S={CLUB:0,DIAMOND:1,HEART:2,SPADE:3},k=(S[h.suit]||99)-(S[g.suit]||99);return k!==0?k:h.value-g.value}})}if(t===0){const d=this.gameScene.handManager.removeCard(s);if(!d){console.error("Card not found in hand:",s.id);return}if(n){const c=this.gameScene.meldManager.handleJokerReplacement(a,d,s,n,l);c&&this.gameScene.handManager.addCard(n,c.jokerStartPosition.x,c.jokerStartPosition.y)}else this.gameScene.meldManager.addCardToMeldVisual(a,d,s,l);this.gameScene.handManager.updateHandDisplay(),this.gameScene.handManager.updateHandDropZones(),this.gameScene.handManager.getHandCards().length===0&&this.gameScene.time.delayedCall(500,()=>{this.logic?.checkGameOver()})}else{if(i===0){const d={x:100+t*200,y:100},c=this.gameScene.handManager.createCardSprite(s,d.x,d.y);n?(this.gameScene.meldManager.handleJokerReplacement(a,c,s,n,l),this.gameScene.showMessage("AI replaced your Joker!")):(this.gameScene.meldManager.addCardToMeldVisual(a,c,s,l),this.gameScene.showMessage("AI added card to your meld!"))}else{const d={x:100+t*200,y:100},c=this.gameScene.handManager.createCardSprite(s,d.x,d.y);this.gameScene.meldManager.addCardToMeldVisual(a,c,s,l),this.gameScene.meldManager.getDisplayedOpponentIndex()===t||c.setVisible(!1)}this.gameScene.playerIconManager.updateCardCount(t)}this.gameScene.meldManager.refreshMeldViewIfOpen(d=>this.getPlayerMelds(d))}onPhaseChanged(e){this.gameScene.setCurrentPhase(e.newPhase),this.gameScene.updatePhaseUI(),this.gameScene.updateMeldUI();const t=this.gameScene.isMyTurn&&(e.newPhase===D.DISCARD||e.newPhase===D.MELD);this.gameScene.dragDropManager.setDiscardHighlight(t)}onTurnEnded(e){this.undoEnabled=!1}onPlayerTurnStarted(e){const{playerIndex:t}=e;this.gameScene.setIsMyTurn(t===0),this.gameScene.updatePhaseUI(),this.gameScene.playerIconManager.setCurrentPlayer(t),t!==0&&(this.gameScene.playerIconManager.pulseIcon(t),this.gameScene.time.delayedCall(500,()=>{this.gameScene.aiManager.runTurn()}))}onGameOver(e){const{winner:t}=e,s=this.logic?.getState().numPlayers||3;this.gameScene.aiManager.cancelTurn();for(let i=0;i<s;i++){let r;i===t?r=-40:r=this.calculateHandPenalty(i),this.gameScene.addRoundScore(i,r)}if(this.currentRound++,this.currentRound<=this.totalRounds)this.gameScene.showMessage(`Round ${this.currentRound-1} complete! ${t===0?"You won!":`Player ${t+1} won!`}`,2500),this.gameScene.time.delayedCall(3e3,()=>{console.log(`ðŸŽ® Starting round ${this.currentRound} of ${this.totalRounds}`),this.gameScene.setCurrentRound(this.currentRound),this.resetForNewRound()});else{this.gameScene.showMessage("Game Over!",3e3);const i={winner:t,totalScores:this.gameScene.getTotalScores()};this.gameScene.showFinalResults?.(i)}}resetForNewRound(){if(this.logic){this.gameScene.aiManager.cancelTurn();const e=this.config.numPlayers??4;this.logic.newGame(e),this.gameScene.aiManager.initializeForPlayers(e,0),this.gameScene.meldManager.clearAllMelds(),this.gameScene.handManager.clearHand(),this.gameScene.setIsMyTurn(!0),this.gameScene.setCurrentPhase(D.DRAW),this.gameScene.createDrawPile(),this.gameScene.createDiscardPile(),this.gameScene.createFinishingCardDisplay();const t=this.logic.getPlayerHand(0);this.gameScene.handManager.setHand(t),this.gameScene.meldManager.clearAllMelds(),this.gameScene.updatePhaseUI(),this.gameScene.updateMeldUI()}}calculateHandPenalty(e){if(!this.logic)return 0;const t=this.logic.getPlayerHand(e);return this.logic.hasPlayerOpened(e)?t.reduce((s,i)=>i.suit==="JOKER_RED"||i.suit==="JOKER_BLACK"?s+25:i.value===1||[13,12,11].includes(i.value)?s+10:s+i.value,0):100}updateDiscardPileVisual(){if(!this.logic||!this.gameScene.discardPileSprite){console.log("âš ï¸ updateDiscardPileVisual: missing logic or sprite");return}const e=this.logic.getState().topDiscardCard;if(e){const t=this.gameScene.handManager.getCardFrame(e);this.gameScene.discardPileSprite.setFrame(t).setVisible(!0)}else this.gameScene.discardPileSprite.setVisible(!1)}validateSelection(e){if(!this.logic||e.length<3)return{score:0,isValid:!1,meetsOpenRequirement:!1};const t=this.logic.validateMelds(0,e);return{score:t.totalScore,isValid:t.validMelds.length>0&&t.invalidCards.length===0,meetsOpenRequirement:t.meetsOpenRequirement}}checkIfDiscardCardWasUsed(){if(!this.logic)return!0;const e=this.logic.getDiscardCard();if(!e)return!0;const t=this.logic.getState().numPlayers;for(let s=0;s<t;s++)if(this.logic.getPlayerMelds(s).some(n=>n.some(a=>a.id===e.id)))return!0;return!1}}class Y{static serverCardToClient(e){return new z(e.suit,e.value,e.isFaceUp,e.id)}static clientCardToServer(e){return{id:e.serverId||e.id,suit:e.suit,value:e.value,isFaceUp:e.isFaceUp}}static serverCardsToClient(e){return e.map(t=>this.serverCardToClient(t))}static clientCardsToServer(e){return e.map(t=>this.clientCardToServer(t))}static getCardIds(e){return e.map(t=>t.serverId||t.id)}static findCardByServerId(e,t){return e.find(s=>s.serverId===t||s.id===t)}static areCardSetsEqual(e,t){if(e.length!==t.length)return!1;const s=e.map(r=>r.serverId||r.id).sort(),i=t.map(r=>r.id).sort();return s.every((r,n)=>r===i[n])}static getCardSetDiff(e,t){const s=new Set(e.map(a=>a.serverId||a.id)),i=new Set(t.map(a=>a.id)),r=t.filter(a=>!s.has(a.id)),n=e.filter(a=>!i.has(a.serverId||a.id));return{added:r,removed:n}}static getPlayerInfo(e){return{name:e.name,handSize:e.handSize,meldCount:e.melds.length,hasOpened:e.hasOpened,score:e.score}}static getMyPlayer(e,t){return e.players.find(s=>s.id===t)}static getOpponents(e,t){return e.players.filter(s=>s.id!==t)}static isMyTurn(e,t){return e.currentPlayerId===t}static getPhaseText(e,t){return(t?"YOUR TURN - ":"OPPONENT'S TURN - ")+({DRAW:"Draw Phase",MELD:"Meld Phase",DISCARD:"Discard Phase",GAME_OVER:"Game Over"}[e]||e)}static formatPlayerName(e,t,s=15){let i=e.name;return e.id===t?i="You":i.length>s&&(i=i.substring(0,s-3)+"..."),i}static getScoreDisplay(e){const t=e.score;return t===0?"0":t>0?`+${t}`:`${t}`}static sortMeldsForDisplay(e){return[...e].sort((t,s)=>{const i=t.length>0&&new Set(t.map(o=>o.value)).size===1,r=s.length>0&&new Set(s.map(o=>o.value)).size===1;if(i&&!r)return-1;if(!i&&r)return 1;const n=t[0]?.value||0,a=s[0]?.value||0;return n-a})}static isGameOver(e){return e.phase==="GAME_OVER"}static getWinner(e){return e.players.find(t=>t.handSize===0)||e.players.reduce((t,s)=>s.score>t.score?s:t)}static createEmptyState(e){return{currentPlayerId:"",currentPlayerName:"",phase:"DRAW",players:[],drawPileSize:0,discardPileTop:null,finishingCard:null,finishingCardDrawn:!1,myHand:[],turnNumber:0,gameStartTime:Date.now()}}static isValidGameState(e){return e&&typeof e.currentPlayerId=="string"&&typeof e.phase=="string"&&Array.isArray(e.players)&&typeof e.drawPileSize=="number"}}class _e{constructor(){this.previousState=null}detectChanges(e){if(!this.previousState)return this.previousState=e,{phaseChanged:!0,turnChanged:!0,handChanged:!0,meldsChanged:!0,discardChanged:!0};const t={phaseChanged:e.phase!==this.previousState.phase,turnChanged:e.currentPlayerId!==this.previousState.currentPlayerId,handChanged:!this.areHandsEqual(e.myHand,this.previousState.myHand),meldsChanged:this.haveMeldsChanged(e,this.previousState),discardChanged:this.hasDiscardChanged(e,this.previousState)};return this.previousState=e,t}areHandsEqual(e,t){if(!e||!t)return e===t;if(e.length!==t.length)return!1;const s=e.map(r=>r.id).sort(),i=t.map(r=>r.id).sort();return s.every((r,n)=>r===i[n])}haveMeldsChanged(e,t){return e.players.some((s,i)=>{const r=t.players[i];return!r||s.melds.length!==r.melds.length?!0:s.melds.some((n,a)=>{const o=r.melds[a];return!o||n.length!==o.length?!0:n.some((l,d)=>{const c=o[d];return!c||l.id!==c.id})})})}hasDiscardChanged(e,t){const s=e.discardPileTop,i=t.discardPileTop;return!s||!i?s!==i:s.id!==i.id}reset(){this.previousState=null}}class ke{constructor(e,t){this.currentServerState=null,this.stateChangeTracker=new _e,this.boardCreated=!1,this.lastDrawnFromDiscardId=null,this.tookFinishingCard=!1,this.drewFromDiscardId=null,this.drawnCardUsedInMeld=!1,this.previousHandIds=new Set,this.currentRound=1,this.totalRounds=10,this.gameScene=e,this.config=t,this.networkManager=t.networkManager,this.myPlayerId=t.myPlayerId}setup(){console.log("ðŸŒ Setting up multiplayer mode"),this.setupEventListeners();const e=this.networkManager.getLastGameState();e?(console.log("ðŸ“Š Processing cached game state"),this.handleGameStateUpdate(e)):console.log("â³ Waiting for game state from server..."),console.log("âœ… Multiplayer listeners registered")}getServerState(){return this.currentServerState}getMyPlayerId(){return this.myPlayerId}getMyPlayerIndex(){return this.currentServerState?this.currentServerState.players.findIndex(e=>e.id===this.myPlayerId):0}hasPlayerOpened(e){return this.currentServerState?.players[e]?.hasOpened??!1}getPlayerMelds(e){return this.currentServerState?.players[e]?.melds??[]}destroy(){this.networkManager.removeAllListeners(),this.currentServerState=null}handleDrawPileClick(){this.networkManager.drawCard(),this.drewFromDiscardId=null,this.tookFinishingCard=!1,this.drawnCardUsedInMeld=!1}handleDiscardPileClick(){this.currentServerState?.discardPileTop&&(this.drewFromDiscardId=this.currentServerState.discardPileTop.id,this.drawnCardUsedInMeld=!1),this.tookFinishingCard=!1,this.networkManager.drawFromDiscard()}handleFinishingCardClick(){const e=this.getMyPlayerIndex();if(this.hasPlayerOpened(e)){this.gameScene.showMessage("You can't take the finishing card if you already have melds!");return}this.tookFinishingCard=!0,this.drewFromDiscardId=null,this.drawnCardUsedInMeld=!1,this.networkManager.takeFinishingCard()}handleDiscard(e,t){const s=e.serverId;if(!s)return console.error("Card missing serverId:",e),!1;if(this.drewFromDiscardId&&!this.drawnCardUsedInMeld){if(s===this.drewFromDiscardId)return this.gameScene.showMessage("Cannot discard the card you just drew!"),this.snapBackCard(t),!1;if(this.gameScene.handManager.getHandCards().some(n=>n.serverId===this.drewFromDiscardId))return this.showDiscardDrawUndoOption(t),!1}if(this.tookFinishingCard&&this.gameScene.handManager.getHandCards().length>1)return this.showFinishingCardUndoOption(t),!1;const i=V.canDiscard(this.myPlayerId,s,this.currentServerState);return i.valid?(this.gameScene.handManager.removeCard(e),this.gameScene.handManager.updateHandDisplay(),this.gameScene.handManager.updateHandDropZones(),this.gameScene.tweens.add({targets:t,x:this.config.layout.DISCARD_PILE.x,y:this.config.layout.DISCARD_PILE.y,duration:200,ease:"Power2",onComplete:()=>{if(this.networkManager.discardCard(s),this.gameScene.handManager.destroyCardSafely(t),this.gameScene.discardPileSprite){const r=this.gameScene.handManager.getCardFrame(e);this.gameScene.discardPileSprite.setFrame(r).setVisible(!0)}this.resetDrawTracking()}}),!0):(this.gameScene.showMessage(i.error||"Cannot discard"),this.snapBackCard(t),!1)}handleAddToMeld(e,t,s,i){const r=e.serverId;if(!r)return console.error("Card missing serverId"),!1;this.drewFromDiscardId&&r===this.drewFromDiscardId&&(this.drawnCardUsedInMeld=!0);const n=V.canAddToMeld(this.myPlayerId,r,s,i,this.currentServerState);if(!n.valid)return this.gameScene.showMessage(n.error||"Cannot add to meld"),!1;const a=this.gameScene.meldManager.getMeld(s,i);if(!a)return console.error("Meld not found"),!1;const o=this.currentServerState.players[s]?.melds[i];if(o){const d={id:r,suit:e.suit,value:e.value,isFaceUp:!0},c=o.find(p=>p.suit==="JOKER_RED"||p.suit==="JOKER_BLACK");c&&I.canCardReplaceJoker(d,c,o)&&console.log("ðŸƒ This card will replace a joker - awaiting server confirmation");const h=this.sortMeldData(o),g=Y.serverCardsToClient(h);this.gameScene.handManager.removeCard(e),this.gameScene.handManager.updateHandDisplay(),this.gameScene.handManager.updateHandDropZones(),this.gameScene.meldManager.addCardToMeldVisual(a,t,e,g)}else{this.gameScene.handManager.removeCard(e),this.gameScene.handManager.updateHandDisplay(),this.gameScene.handManager.updateHandDropZones();const d=[...a.cardData,e];this.gameScene.meldManager.addCardToMeldVisual(a,t,e,d)}const l=this.currentServerState.players[s].id;return this.networkManager.addCardToMeld(r,l,i),!0}handleLayMelds(e){const t=this.validateSelection(e);if(!t.isValid)return t.invalidCards.length>0?this.gameScene.showMessage("Some cards cannot form valid melds"):this.gameScene.showMessage("Invalid melds"),!1;if(!t.meetsOpenRequirement)return this.gameScene.showMessage(`Need 51 points to open (have ${t.score})`),!1;if(this.gameScene.handManager.getHandCards().length===e.length)return this.gameScene.showMessage("Must keep at least one card to discard"),!1;this.drewFromDiscardId&&e.some(n=>n.serverId===this.drewFromDiscardId)&&(this.drawnCardUsedInMeld=!0);const i=t.validMelds.map(r=>r.map(n=>n.serverId||n.id));return this.networkManager.layMelds(i),this.gameScene.handManager.clearSelection(),!0}handleReorderHand(e,t){this.gameScene.handManager.reorderCard(e,t),this.networkManager.reorderHand(e,t)}handleSkipMeld(){if(!this.gameScene.isMyTurn){this.gameScene.showMessage("Not your turn");return}if(this.currentServerState?.phase!=="MELD"){this.gameScene.showMessage("Can only skip during meld phase");return}this.networkManager.skipMeld()}leaveRoom(){this.networkManager.leaveRoom()}disconnect(){this.networkManager.disconnect()}validateSelection(e){if(e.length<3)return{score:0,isValid:!1,meetsOpenRequirement:!1,validMelds:[],invalidCards:e};const t=e.map(h=>({id:h.serverId||h.id,suit:h.suit,value:h.value,isFaceUp:h.isFaceUp})),s=I.splitIntoMeldGroups(t),i=new Set(s.flat().map(h=>h.id)),r=t.filter(h=>!i.has(h.id)),n=s.map(h=>h.map(g=>e.find(p=>(p.serverId||p.id)===g.id)).filter(Boolean)).filter(h=>h.length>=3),a=r.map(h=>e.find(g=>(g.serverId||g.id)===h.id)).filter(Boolean),o=s.reduce((h,g)=>h+I.calculateMeldScore(g),0),l=this.hasPlayerOpened(this.getMyPlayerIndex()),d=n.length>0&&a.length===0,c=l||o>=51;return{score:o,isValid:d,meetsOpenRequirement:c,validMelds:n,invalidCards:a}}setupEventListeners(){this.networkManager.on(f.GAME_STATE_UPDATE,e=>{this.handleGameStateUpdate(e)}),this.networkManager.on(f.GAME_OVER,e=>{this.handleGameOver(e)}),this.networkManager.on(f.ERROR,e=>{this.handleError(e)}),this.networkManager.on(f.PLAYER_LEFT,e=>{this.handlePlayerLeft(e)}),this.networkManager.on(f.PLAYER_RECONNECTED,e=>{this.handlePlayerReconnected(e)}),this.networkManager.on(f.UNDO_CONFIRMED,e=>{e.type==="FINISHING_CARD"?(this.gameScene.showMessage("Undo successful - drew from deck instead"),this.currentServerState?.finishingCard&&this.gameScene.finishingCardSprite&&this.gameScene.finishingCardSprite.setVisible(!0)):e.type==="DRAW_FROM_DISCARD"&&this.gameScene.showMessage("Undo successful - drew from deck instead")}),this.networkManager.on(f.ROUND_STARTED,e=>{this.handleRoundStarted(e)}),this.networkManager.on(f.ROUND_ENDED,e=>{this.handleRoundEnded(e)}),this.networkManager.on(f.CARD_ADDED_TO_MELD,e=>{this.handleCardAddedToMeldEvent(e)})}handleGameStateUpdate(e){const t=this.currentServerState;this.currentServerState=e;const s=this.stateChangeTracker.detectChanges(e);if(console.log("ðŸ“¨ State update received, changes:",s),this.boardCreated||(this.createGameBoard(),this.boardCreated=!0),this.gameScene.playerIconManager.updateAll(),s.handChanged&&e.myHand&&this.updateHand(e.myHand),s.meldsChanged&&(this.updateMelds(e),this.handleJokerReplacementFromServer(e,t)),this.checkForNewlyOpenedPlayers(e,t),s.discardChanged&&e.discardPileTop&&this.updateDiscardPile(e.discardPileTop),e.finishingCard)if(this.gameScene.finishingCardSprite){const i=this.gameScene.handManager.getCardFrame(e.finishingCard);this.gameScene.finishingCardSprite.setFrame(i).setVisible(!0)}else this.gameScene.createFinishingCardFromServer(e.finishingCard);if(this.gameScene.setIsMyTurn(Y.isMyTurn(e,this.myPlayerId)),this.gameScene.setCurrentPhase(e.phase),this.gameScene.updatePhaseUI(),this.gameScene.meldManager.refreshMeldViewIfOpen(i=>this.getPlayerMelds(i)),s.turnChanged){const i=e.players.findIndex(n=>n.id===e.currentPlayerId);this.gameScene.playerIconManager.setCurrentPlayer(i),i!==this.getMyPlayerIndex()&&this.gameScene.playerIconManager.pulseIcon(i),this.lastDrawnFromDiscardId=null,this.tookFinishingCard=!1;const r=this.gameScene.isMyTurn&&e.phase!=="DRAW";this.gameScene.dragDropManager.setDiscardHighlight(r)}t&&e.players.forEach((i,r)=>{if(i.id===this.myPlayerId)return;const n=t.players.find(a=>a.id===i.id);if(n&&n.handSize!==i.handSize){const a=i.handSize>n.handSize;this.gameScene.playerIconManager.highlightCardCountChange(r,a)}})}handleRoundStarted(e){this.currentRound=e.round,this.totalRounds=e.totalRounds,typeof this.gameScene.setCurrentRound=="function"&&this.gameScene.setCurrentRound(this.currentRound),this.gameScene.showMessage(`Round ${this.currentRound} started!`,2e3),this.boardCreated=!1,this.lastDrawnFromDiscardId=null,this.tookFinishingCard=!1,this.previousHandIds=new Set,this.resetDrawTracking(),this.gameScene.discardPileSprite&&this.gameScene.discardPileSprite.setVisible(!1),this.gameScene.finishingCardSprite&&(this.gameScene.finishingCardSprite.destroy(),this.gameScene.finishingCardSprite=null),this.gameScene.meldManager.clearAllMelds(),this.gameScene.handManager.clearHand()}handleRoundEnded(e){const{round:t,winner:s,roundScores:i,cumulativeScores:r}=e;if(this.currentRound=t,typeof this.gameScene.addRoundScore=="function"&&i.forEach(({playerId:n,score:a})=>{this.gameScene.addRoundScore(n,a)}),typeof this.gameScene.showRoundResults=="function")this.gameScene.showRoundResults?.({round:t,winner:s.id,scores:i,cumulativeScores:r});else{const n=s.id===this.myPlayerId;this.gameScene.showMessage(`${s.name} won round ${t}! ${n?"ðŸŽ‰":"ðŸ˜”"}`,3e3)}}createGameBoard(){this.gameScene.createDrawPile(),this.gameScene.createDiscardPile(),this.previousHandIds=new Set,this.gameScene.dragDropManager.createDiscardDropZone({x:this.config.layout.DISCARD_PILE.x,y:this.config.layout.DISCARD_PILE.y}),this.gameScene.playerIconManager.createIcons()}updateHand(e){const t=new Set(e.map(r=>r.id)),s=e.filter(r=>!this.previousHandIds.has(r.id)),i=[...this.previousHandIds].filter(r=>!t.has(r));if(this.previousHandIds.size===0||i.length>1||s.length>3){const r=Y.serverCardsToClient(e);this.gameScene.handManager.setHand(r)}else{for(const r of i){const n=this.gameScene.handManager.getHandCards().find(a=>a.serverId===r||a.id===r);n&&this.gameScene.handManager.removeCard(n)}for(const r of s){const n=Y.serverCardToClient(r);let a=this.config.layout.DRAW_PILE.x,o=this.config.layout.DRAW_PILE.y;(r.suit==="JOKER_RED"||r.suit==="JOKER_BLACK")&&(a=this.gameScene.scale.width/2,o=this.gameScene.scale.height/2-100),this.gameScene.handManager.addCard(n,a,o)}this.gameScene.handManager.updateHandDisplay()}this.previousHandIds=t}updateMelds(e){this.gameScene.meldManager.updateFromServerState(e.players,this.myPlayerId,t=>Y.serverCardsToClient(t))}updateDiscardPile(e){if(this.gameScene.discardPileSprite){const t=this.gameScene.handManager.getCardFrame(e);this.gameScene.discardPileSprite.setFrame(t).setVisible(!0)}}checkForNewlyOpenedPlayers(e,t){e.players.forEach((s,i)=>{if(s.id===this.myPlayerId)return;const r=t?.players.find(a=>a.id===s.id);s.hasOpened&&!r?.hasOpened&&(this.gameScene.meldManager.showOpponentMelds(i,s.melds),this.gameScene.playerIconManager.flashMeldIndicator(i))})}handleJokerReplacementFromServer(e,t){if(!t)return;const s=e.myHand||[],i=t.myHand||[];s.filter(n=>{const a=n.suit==="JOKER_RED"||n.suit==="JOKER_BLACK",o=i.some(l=>l.id===n.id);return a&&!o}).length>0&&this.gameScene.showMessage("ðŸƒ Joker replaced and added to your hand!")}handleCardAddedToMeldEvent(e){const{playerId:t,meldOwner:s,meldIndex:i,replacedJoker:r}=e;if(this.currentServerState.players.findIndex(n=>n.id===s),t!==this.myPlayerId){const n=this.currentServerState?.players.find(a=>a.id===t)?.name||"Player";r&&this.gameScene.showMessage(`${n} replaced a joker!`),this.gameScene.meldManager.refreshMeldViewIfOpen(a=>this.getPlayerMelds(a))}this.gameScene.playerIconManager.updateAll()}handleGameOver(e){const t={winner:e.winner,totalScores:e.finalScores||[],roundResults:e.roundResults||[]};if(typeof this.gameScene.showFinalResults=="function")this.gameScene.showFinalResults?.(t);else{const i=e.winner.id===this.myPlayerId?`ðŸ† You won the game! Final score: ${e.winner.score}`:`ðŸ† ${e.winner.name} won the game!`;this.gameScene.showMessage(i,5e3)}}handleError(e){console.error("âŒ Network error:",e),B.showToast(this.gameScene,e.message||"Network error",3e3,v.ERROR)}handlePlayerLeft(e){const t=e.playerName||"A player";if(e.disconnected||!1){this.gameScene.showMessage(`${t} disconnected - waiting for reconnection...`);const i=this.currentServerState?.players.findIndex(r=>r.name===t);i!==void 0&&i>=0&&this.gameScene.playerIconManager.setPlayerDisconnected(i,!0)}else this.gameScene.showMessage(`${t} left the game`);this.gameScene.playerIconManager.updateAll()}handlePlayerReconnected(e){const t=e.playerName||"A player";this.gameScene.showMessage(`${t} reconnected!`);const s=this.currentServerState?.players.findIndex(i=>i.id===e.playerId);s!==void 0&&s>=0&&this.gameScene.playerIconManager.setPlayerDisconnected(s,!1)}sortMeldData(e){if(e.length===0)return[];const t=[...e],s=t.filter(r=>r.suit!=="JOKER_RED"&&r.suit!=="JOKER_BLACK"),i=s.length>0&&s.every(r=>r.suit===s[0].suit);return t.sort((r,n)=>{const a=r.suit==="JOKER_RED"||r.suit==="JOKER_BLACK",o=n.suit==="JOKER_RED"||n.suit==="JOKER_BLACK";if(a&&o)return r.suit.localeCompare(n.suit);if(a&&!o)return 1;if(!a&&o)return-1;if(i)return r.value-n.value;{const l={CLUB:0,DIAMOND:1,HEART:2,SPADE:3},d=(l[r.suit]||99)-(l[n.suit]||99);return d!==0?d:r.value-n.value}}),t}showDiscardDrawUndoOption(e){this.snapBackCard(e),B.createModal(this.gameScene,"âš ï¸ Must Use Drawn Card","You must use the card you drew from the discard pile in a meld, or undo your draw.",[{text:"Undo & Draw from Deck",callback:()=>{this.networkManager.undoSpecialDraw(),this.resetDrawTracking()},color:v.PRIMARY},{text:"Keep Trying",callback:()=>{this.gameScene.showMessage("Add the drawn card to a meld first!")},color:v.SECONDARY}])}showFinishingCardUndoOption(e){this.snapBackCard(e),B.createModal(this.gameScene,"âš ï¸ Cannot Finish","You took the finishing card but cannot go out this turn.",[{text:"Undo & Draw from Deck",callback:()=>{this.networkManager.undoSpecialDraw(),this.resetDrawTracking()},color:v.PRIMARY},{text:"Keep Trying",callback:()=>{this.gameScene.showMessage("Lay down all your cards to finish!")},color:v.SECONDARY}])}resetDrawTracking(){this.drewFromDiscardId=null,this.tookFinishingCard=!1,this.drawnCardUsedInMeld=!1}snapBackCard(e){const t=e.getData("origX"),s=e.getData("origY");t!==void 0&&s!==void 0&&this.gameScene.tweens.add({targets:e,x:t,y:s,duration:150,ease:"Back.easeOut"})}}const Oe=1280,Ne=720,M={DISCARD_PILE:{x:.6,y:.5},DRAW_PILE:{x:.4,y:.5},FINISHING_CARD:{x:.5,y:.48}};class Le extends P.Scene{constructor(){super({key:T.GAME}),this.isMultiplayer=!1,this.networkManager=null,this.myPlayerId=null,this.numPlayers=4,this.numRounds=10,this.currentRound=1,this.totalScores=new Map,this.aiDifficulty=H.EXPERT,this.singlePlayerHandler=null,this.multiplayerHandler=null,this.drawPileSprites=[],this.discardPileSprite=null,this.discardPileRectangle=null,this.finishingCardSprite=null,this.drawZone=null,this.phaseText=null,this.turnIndicator=null,this.myScoreText=null,this.meldScoreText=null,this.meldButton=null,this.undoDialog=null,this.scoreDisplay=null,this.roundTitleText=null,this.standingsTitleText=null,this.scoreDisplayShown=!1,this.standingsListContainer=null,this.isMyTurn=!1,this.currentPhase=D.DRAW}init(e){if(this.isMultiplayer=e.isMultiplayer||!1,this.isMultiplayer)this.networkManager=e.networkManager,this.myPlayerId=this.networkManager?.getPlayerId()||null;else{e.gameConfig?(this.numPlayers=e.gameConfig.maxPlayers||4,this.numRounds=e.gameConfig.rounds||3,this.aiDifficulty=H.EXPERT):(this.numPlayers=e.numPlayers||4,this.numRounds=e.numRounds||3,this.aiDifficulty=e.aiDifficulty||H.EXPERT),this.currentRound=1,this.totalScores=new Map;for(let t=0;t<this.numPlayers;t++)this.totalScores.set(t,0)}}create(){this.initializeManagers(),this.createUI(),this.isMultiplayer?this.setupMultiplayerMode():this.setupSinglePlayerMode(),this.createScoreDisplay(),this.updateLayout(this.scale),this.scale.on("resize",this.updateLayout,this)}shutdown(){this.scale.off("resize",this.updateLayout,this),this.singlePlayerHandler?.destroy(),this.multiplayerHandler?.destroy(),this.singlePlayerHandler=null,this.multiplayerHandler=null,this.handManager.destroy(),this.meldManager.destroy(),this.playerIconManager.destroy(),this.dragDropManager.destroy(),this.aiManager.destroy(),this.undoDialog?.destroy(),this.scoreDisplay?.destroy(),this.isMyTurn=!1,this.currentPhase=D.DRAW}setIsMyTurn(e){this.isMyTurn=e}setCurrentPhase(e){this.currentPhase=e}initializeManagers(){this.handManager=new ge(this,{isMultiplayer:()=>this.isMultiplayer,getCardId:e=>this.isMultiplayer&&e.serverId||e.id,hasPlayerOpened:()=>this.getHandler()?.hasPlayerOpened(0)??!1,onSelectionChanged:()=>{this.updateMeldUI()}}),this.meldManager=new ye(this,{isMultiplayer:()=>this.isMultiplayer,getMyPlayerIndex:()=>this.isMultiplayer?this.multiplayerHandler?.getMyPlayerIndex()??0:0,getOpponentIndex:e=>{const t=this.isMultiplayer?this.multiplayerHandler?.getMyPlayerIndex()??0:0;return e<t?e:e-1},showMessage:e=>this.showMessage(e)}),this.playerIconManager=new Ce(this,{getPlayersInfo:()=>this.getPlayersDisplayInfo(),onPlayerClick:e=>this.viewPlayerMelds(e)}),this.dragDropManager=new Ie(this,{isMyTurn:()=>this.isMyTurn,getCurrentPhase:()=>this.currentPhase,isMultiplayer:()=>this.isMultiplayer,isCardSelected:e=>this.handManager.isSelected(e),getCardSpriteIndex:e=>this.handManager.getSpriteIndex(e),onCardDeselect:e=>this.handManager.deselectCard(e),onHandReorder:(e,t)=>this.handleHandReorder(e,t),onDiscardDrop:(e,t)=>this.handleDiscardDrop(e,t),onMeldDrop:(e,t,s,i)=>this.handleMeldDrop(e,t,s,i),showMessage:e=>this.showMessage(e),updateHandDisplay:()=>this.handManager.updateHandDisplay()}),this.dragDropManager.setup(),this.aiManager=new Re(this,{getLogic:()=>this.singlePlayerHandler?.getLogic()??null,showMessage:e=>this.showMessage(e),updatePlayerIcons:()=>this.playerIconManager.updateAll(),onOpponentOpened:e=>{const t=this.singlePlayerHandler?.getPlayerMelds(e)??[];this.meldManager.showOpponentMelds(e,t)}},{difficulty:H.EXPERT})}setupSinglePlayerMode(){this.singlePlayerHandler=new Te(this,{numPlayers:this.numPlayers,numRounds:this.numRounds,aiDifficulty:this.aiDifficulty,layout:M}),this.singlePlayerHandler.setup()}setupMultiplayerMode(){if(!this.networkManager||!this.myPlayerId){console.error("Missing network configuration");return}this.multiplayerHandler=new ke(this,{networkManager:this.networkManager,myPlayerId:this.myPlayerId,layout:M}),this.multiplayerHandler.setup()}getHandler(){return this.isMultiplayer?this.multiplayerHandler:this.singlePlayerHandler}getDynamicScale(){const e=this.scale.width,t=this.scale.height,s=e/Oe,i=t/Ne;let r=Math.min(s,i);return r=r/3,r=Math.max(.4,Math.min(r,1.5)),r}updateLayout(e){const t=e.width,s=e.height;this.drawPileSprites&&this.drawPileSprites.forEach((i,r)=>{i.setPosition(t*M.DRAW_PILE.x+r*2,s*M.DRAW_PILE.y),i.setScale(this.getDynamicScale()*.9)}),this.drawZone&&(this.drawZone.setPosition(t*M.DRAW_PILE.x,s*M.DRAW_PILE.y),this.drawZone.setScale(this.getDynamicScale())),this.discardPileSprite&&(this.discardPileSprite.setPosition(t*M.DISCARD_PILE.x,s*M.DISCARD_PILE.y),this.discardPileSprite.setScale(this.getDynamicScale()*.9)),this.discardPileRectangle&&(this.discardPileRectangle.setPosition(t*M.DISCARD_PILE.x,s*M.DISCARD_PILE.y),this.discardPileRectangle.setSize(L*this.getDynamicScale()*.9,U*this.getDynamicScale()*.9)),this.dragDropManager.moveDiscardDropZone(t*M.DISCARD_PILE.x,s*M.DISCARD_PILE.y),this.finishingCardSprite&&(this.finishingCardSprite.setPosition(t*M.FINISHING_CARD.x,s*M.FINISHING_CARD.y),this.finishingCardSprite.setScale(this.getDynamicScale()*.9)),this.phaseText&&this.phaseText.setPosition(t/2,s/2-140),this.turnIndicator&&this.turnIndicator.setPosition(t/2,s/2-115),this.handManager.handleResize(),this.meldManager.updateLayout(),this.playerIconManager.updateLayout(),this.meldButton&&this.meldButton.setPosition(t/2,s-200),this.scoreDisplay&&this.scoreDisplay.setPosition(20,150)}handleHandReorder(e,t){this.singlePlayerHandler?.handleReorderHand(e,t),this.handManager.reorderCard(e,t)}handleDiscardDrop(e,t){let s=!1;this.isMultiplayer&&this.multiplayerHandler?s=this.multiplayerHandler.handleDiscard(e,t):this.singlePlayerHandler&&(s=this.singlePlayerHandler.handleDiscard(e,t)),s||this.dragDropManager.snapBack(t)}handleMeldDrop(e,t,s,i){let r=!1;this.isMultiplayer&&this.multiplayerHandler?r=this.multiplayerHandler.handleAddToMeld(e,t,s,i):this.singlePlayerHandler&&(r=this.singlePlayerHandler.handleAddToMeld(e,s,i)),r||this.dragDropManager.snapBack(t)}handleDrawPileClick(){if(!this.isMyTurn||this.currentPhase!==D.DRAW){this.showMessage("Cannot draw now");return}this.isMultiplayer?this.multiplayerHandler?.handleDrawPileClick():this.singlePlayerHandler?.handleDrawPileClick()}handleDiscardPileClick(){if(!this.isMyTurn||this.currentPhase!==D.DRAW){this.showMessage("Cannot draw from discard now");return}this.isMultiplayer?this.multiplayerHandler?.handleDiscardPileClick():this.singlePlayerHandler?.handleDiscardPileClick()}handleFinishingCardClick(){!this.isMyTurn||this.currentPhase!==D.DRAW||(this.isMultiplayer?this.multiplayerHandler?.handleFinishingCardClick():this.singlePlayerHandler?.handleFinishingCardClick())}handleLayMelds(){const e=this.handManager.getSelectedCardsInOrder();if(e.length<3){this.showMessage("Select at least 3 cards");return}this.isMultiplayer?this.multiplayerHandler?.handleLayMelds(e):this.singlePlayerHandler?.handleLayMelds(e)&&(this.handManager.clearSelection(),this.updateMeldUI())}viewPlayerMelds(e){if(!(this.isMultiplayer?this.multiplayerHandler?.hasPlayerOpened(e)??!1:this.singlePlayerHandler?.hasPlayerOpened(e)??!1)){this.showMessage(`Player ${e+1} has no melds yet`);return}const s=()=>this.isMultiplayer?this.multiplayerHandler?.getPlayerMelds(e)??[]:this.singlePlayerHandler?.getPlayerMelds(e)??[];this.meldManager.togglePlayerMelds(e,s)}createUI(){const{width:e,height:t}=this.scale;this.phaseText=this.add.text(e/2,t/2-140,"",{fontSize:"18px",fontFamily:"Arial",color:"#ffffff"}).setOrigin(.5).setDepth(w.UI),this.turnIndicator=this.add.text(e/2,t/2-115,"",{fontSize:"18px",fontFamily:"Arial",color:"#4CAF50",fontStyle:"bold"}).setOrigin(.5).setDepth(w.UI),this.meldScoreText=this.add.text(60,50,"0",{fontSize:"32px",fontFamily:"Arial",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(w.UI),this.meldButton=this.createMeldButton(),this.meldButton.setVisible(!1);const s=B.createButton(this,60,100,"â† Menu",v.PRIMARY,100,40);s.setDepth(w.UI),s.on("pointerdown",()=>this.handleBackToMenu())}createMeldButton(){const{width:e,height:t}=this.scale,s=this.add.rectangle(0,0,180,50,v.SUCCESS).setStrokeStyle(3,16777215),i=this.add.text(0,0,"ðŸ“‹ Lay Melds",{fontSize:"20px",fontFamily:"Arial",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),r=this.add.container(e/2,t-200,[s,i]);return r.setSize(200,60).setInteractive({useHandCursor:!0}).setDepth(w.UI),r.on("pointerover",()=>s.setFillStyle(6732650)),r.on("pointerout",()=>s.setFillStyle(v.SUCCESS)),r.on("pointerdown",()=>this.handleLayMelds()),r}createScoreDisplay(){const{width:e}=this.scale;this.scoreDisplay=this.add.container(20,150),this.roundTitleText=this.add.text(0,0,`Round ${this.currentRound}/${this.numRounds}`,{fontSize:"20px",fontFamily:"Arial",color:"#FFC107",fontStyle:"bold"}).setOrigin(0,0),this.standingsTitleText=this.add.text(0,35,"STANDINGS â–¼",{fontSize:"20px",fontFamily:"Arial",color:"#4CAF50",fontStyle:"bold"}).setOrigin(0,0).setInteractive({useHandCursor:!0}),this.standingsListContainer=this.add.container(0,75),this.standingsListContainer.setVisible(!1),this.scoreDisplay.add([this.roundTitleText,this.standingsTitleText,this.standingsListContainer]),this.scoreDisplay.setDepth(w.UI),this.standingsTitleText.on("pointerdown",()=>{this.scoreDisplayShown=!this.scoreDisplayShown,this.standingsListContainer!==null&&(this.standingsListContainer.setVisible(this.scoreDisplayShown),this.standingsTitleText!==null&&(this.standingsTitleText.setText(this.scoreDisplayShown?"STANDINGS â–²":"STANDINGS â–¼"),this.updateScoreDisplay()))})}updateScoreDisplay(){if(!this.scoreDisplay||!this.standingsListContainer||(this.standingsListContainer.removeAll(!0),!this.scoreDisplayShown))return;this.getCurrentStandings().forEach((t,s)=>{const i=s*40,r=s+1,n=r===1?"ðŸ‘‘ ":"",a=r===1?"ðŸ¥‡":r===2?"ðŸ¥ˆ":r===3?"ðŸ¥‰":`${r}.`,o=this.add.text(0,i,`${n}${a} ${t.name}: ${t.totalScore} pts`,{fontSize:"18px",fontFamily:"Arial",color:t.isMe?"#4CAF50":t.isCurrentPlayer?"#FFC107":"#FFFFFF"}).setOrigin(0,0);this.standingsListContainer.add(o)})}getCurrentStandings(){return this.getPlayersDisplayInfo().map(s=>({id:s.id,name:s.name,totalScore:this.totalScores.get(s.id)||0,isMe:s.isMe,isCurrentPlayer:s.isCurrentPlayer})).sort((s,i)=>s.totalScore-i.totalScore)}getTotalScores(){return this.totalScores}createDrawPile(){const{width:e,height:t}=this.scale;this.drawPileSprites=[];for(let s=0;s<3;s++){const i=this.add.image(e*M.DRAW_PILE.x+s*3,t*M.DRAW_PILE.y,G.CARDS,54).setScale(this.getDynamicScale()).setDepth(w.CARDS+s).setOrigin(.5,.5);this.drawPileSprites.push(i)}this.drawZone=this.add.zone(e*M.DRAW_PILE.x,t*M.DRAW_PILE.y,L*this.getDynamicScale()+20,U*this.getDynamicScale()+20).setInteractive({useHandCursor:!0}).setOrigin(.5,.5),this.drawZone.on("pointerdown",()=>this.handleDrawPileClick())}createDiscardPile(){const{width:e,height:t}=this.scale;this.discardPileRectangle=this.add.rectangle(e*M.DISCARD_PILE.x,t*M.DISCARD_PILE.y,L*this.getDynamicScale(),U*this.getDynamicScale(),3355443,.3).setStrokeStyle(2,6710886).setDepth(w.CARDS-1),this.discardPileSprite=this.add.image(e*M.DISCARD_PILE.x,t*M.DISCARD_PILE.y,G.CARDS,0).setScale(this.getDynamicScale()).setDepth(w.CARDS).setVisible(!1).setOrigin(.5,.5),this.discardPileSprite.setInteractive({useHandCursor:!0}),this.discardPileSprite.on("pointerdown",()=>this.handleDiscardPileClick())}createFinishingCardDisplay(){const{width:e,height:t}=this.scale,s=this.singlePlayerHandler?.getLogic();if(!s)return;const i=s.getFinishingCard();i&&(this.finishingCardSprite=this.add.image(e*M.FINISHING_CARD.x,t*M.FINISHING_CARD.y,G.CARDS,this.handManager.getCardFrame(i)).setScale(this.getDynamicScale()*.9).setDepth(w.CARDS),this.finishingCardSprite.setInteractive({useHandCursor:!0}),this.finishingCardSprite.on("pointerdown",()=>this.handleFinishingCardClick()))}createFinishingCardFromServer(e){const{width:t,height:s}=this.scale;this.finishingCardSprite=this.add.image(t*M.FINISHING_CARD.x,s*M.FINISHING_CARD.y,G.CARDS,this.handManager.getCardFrame(e)).setScale(this.getDynamicScale()*.9).setDepth(w.CARDS),this.finishingCardSprite.setInteractive({useHandCursor:!0}),this.finishingCardSprite.on("pointerdown",()=>this.handleFinishingCardClick())}updatePhaseUI(){const e={[D.DRAW]:"VUCI KARTU",[D.MELD]:"IGRAJ",[D.DISCARD]:"IZBACI KARTU",[D.GAME_OVER]:"IGRA ZAVRSENA"};this.phaseText?.setText(this.isMyTurn?e[this.currentPhase]:""),this.turnIndicator?.setText(this.isMyTurn?"TI SI NA REDU":"SACEKAJ..."),this.turnIndicator?.setColor(this.isMyTurn?"#4CAF50":"#FFC107")}updateMeldUI(){const e=this.handManager.getSelectedCardsInOrder();let t={score:0,isValid:!1,meetsOpenRequirement:!1};if(this.singlePlayerHandler?t=this.singlePlayerHandler.validateSelection(e):this.multiplayerHandler&&(t=this.multiplayerHandler.validateSelection(e)),this.meldScoreText&&(this.meldScoreText.setText(`${t.score}`),this.meldScoreText.setColor(t.score===0?"#ffffff":t.meetsOpenRequirement?"#00ff00":"#ff0000")),this.meldButton){const s=this.isMyTurn&&this.currentPhase===D.MELD&&e.length>=3&&t.isValid&&t.meetsOpenRequirement;this.meldButton.setVisible(s)}}updateScores(){this.updateScoreDisplay(),this.playerIconManager.updateAll()}showMessage(e,t=2e3){const s=this.add.text(this.scale.width/2,this.scale.height/2+100,e,{fontSize:"24px",fontFamily:"Arial",color:"#ffffff",backgroundColor:"#000000",padding:{x:20,y:10}}).setOrigin(.5).setDepth(1e3);this.tweens.add({targets:s,alpha:0,y:s.y-30,duration:t,ease:"Power2",onComplete:()=>s.destroy()})}showUndoOption(e,t,s){e.setPosition(e.getData("origX"),e.getData("origY")),this.undoDialog?.destroy();const{width:i,height:r}=this.scale,n=this.add.text(i*.25,r*.55,`Kartu uzetu sa stola moras i da iskoristis!

Ponisti potez i vuci kartu iz spila?`,{fontSize:"18px",color:"#000000",align:"center",wordWrap:{width:i*.5}}).setOrigin(0),a=this.add.rectangle(i*.38,r*.75,100,40,5025616).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerover",()=>a.setFillStyle(6732650)).on("pointerout",()=>a.setFillStyle(5025616)).on("pointerdown",()=>{this.undoDialog?.destroy(),this.undoDialog=null,t()}),o=this.add.text(i*.38,r*.75,"DA!",{fontSize:"16px",color:"#ffffff"}).setOrigin(.5),l=this.add.rectangle(i*.62,r*.75,100,40,16007990).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerover",()=>l.setFillStyle(15037299)).on("pointerout",()=>l.setFillStyle(16007990)).on("pointerdown",()=>{this.undoDialog?.destroy(),this.undoDialog=null,s()}),d=this.add.text(i*.62,r*.75,"NE!",{fontSize:"16px",color:"#ffffff"}).setOrigin(.5);this.undoDialog=this.add.container(0,0,[n,a,o,l,d]).setDepth(1e3)}showFinishingCardUndoOption(e,t,s){e.setPosition(e.getData("origX"),e.getData("origY")),this.undoDialog?.destroy();const{width:i,height:r}=this.scale,n=this.add.text(i*.25,r*.55,`S obzirom da si uzeo specijalnu kartu, moras i zavrsiti igru sada!

Ponisti potez i vuci kartu iz spila?`,{fontSize:"18px",color:"#000000",align:"center",wordWrap:{width:i*.5}}).setOrigin(0),a=this.add.rectangle(i*.38,r*.75,100,40,5025616).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerover",()=>a.setFillStyle(6732650)).on("pointerout",()=>a.setFillStyle(5025616)).on("pointerdown",()=>{this.undoDialog?.destroy(),this.undoDialog=null,t()}),o=this.add.text(i*.38,r*.75,"DA!",{fontSize:"16px",color:"#ffffff"}).setOrigin(.5),l=this.add.rectangle(i*.62,r*.75,100,40,16007990).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerover",()=>l.setFillStyle(15037299)).on("pointerout",()=>l.setFillStyle(16007990)).on("pointerdown",()=>{this.undoDialog?.destroy(),this.undoDialog=null,s()}),d=this.add.text(i*.62,r*.75,"NE!",{fontSize:"16px",color:"#ffffff"}).setOrigin(.5);this.undoDialog=this.add.container(0,0,[n,a,o,l,d]).setDepth(1e3)}getPlayersDisplayInfo(){if(this.isMultiplayer&&this.multiplayerHandler){const t=this.multiplayerHandler.getServerState();return t?t.players.map((s,i)=>({id:s.id,name:s.name,handSize:s.handSize,hasOpened:s.hasOpened,isCurrentPlayer:s.id===t.currentPlayerId,isMe:s.id===this.myPlayerId,score:this.totalScores.get(s.id)||0})):[]}else if(this.singlePlayerHandler){const t=this.singlePlayerHandler.getLogic();if(!t)return[];const s=t.getState(),i=this.numPlayers,r=[];for(let n=0;n<i;n++){const a=this.totalScores.get(n)||0;r.push({id:n,name:n===0?"You":`Bot ${n}`,handSize:s.handSizes&&s.handSizes[n]?s.handSizes[n]:0,hasOpened:s.playersHaveOpened&&s.playersHaveOpened[n]?s.playersHaveOpened[n]:!1,isCurrentPlayer:n===s.currentPlayer,isMe:n===0,score:a})}return r}const e=[];for(let t=0;t<this.numPlayers;t++)e.push({id:t,name:t===0?"You":`Bot ${t}`,handSize:0,hasOpened:!1,isCurrentPlayer:t===0,isMe:t===0,score:this.totalScores.get(t)||0});return e}handleBackToMenu(){B.createModal(this,"Leave Game?","Are you sure?",[{text:"Stay",callback:()=>{},color:v.SECONDARY},{text:"Leave",callback:()=>{this.multiplayerHandler?.leaveRoom(),this.multiplayerHandler?.disconnect(),this.scene.stop(T.GAME),this.scene.start(T.MENU)},color:v.ERROR}])}addRoundScore(e,t){const s=this.totalScores.get(e)||0;this.totalScores.set(e,s+t),this.updateScoreDisplay(),this.playerIconManager.updateAll()}setCurrentRound(e){this.currentRound=e,this.roundTitleText&&this.roundTitleText.setText(`Round ${this.currentRound}/${this.numRounds}`)}showFinalResults(e){const{winner:t,totalScores:s}=e,i=t===0?"You":`Bot ${t}`,n=Array.from(s.entries()).sort((o,l)=>l[1]-o[1]);let a=`ðŸŽ‰ GAME OVER! ðŸŽ‰

`;a+=`ðŸ† Winner: ${i}

`,a+=`FINAL STANDINGS:
`,n.forEach(([o,l],d)=>{const c=d+1,h=o===0?"You":`Bot ${o}`,g=c===1?"ðŸ¥‡":c===2?"ðŸ¥ˆ":c===3?"ðŸ¥‰":`${c}.`;a+=`${g} ${h}: ${l} points
`}),B.createModal(this,"Game Complete!",a,[{text:"Back to Menu",callback:()=>{this.scene.start(T.MENU)},color:v.PRIMARY},{text:"Play Again",callback:()=>{this.totalScores.clear(),this.currentRound=1,this.singlePlayerHandler?.destroy(),this.setupSinglePlayerMode()},color:v.SUCCESS}])}}class Fe extends P.Scene{constructor(){super({key:T.PRELOAD})}preload(){this.load.spritesheet(G.CARDS,"/assets/images/spritesheet.png",{frameWidth:L,frameHeight:U,spacing:4,margin:0,endFrame:54})}create(){this.add.image(400,300,G.CARDS,0),this.time.delayedCall(1e3,()=>{this.scene.start(T.MENU)})}}class xe extends P.Scene{constructor(){super({key:T.SINGLE_PLAYER_SETUP}),this.CONFIG={colors:{background:3050327,text:"#ffffff",accent:"#FFD700",disabled:"#666666",primary:"#4CAF50",secondary:"#2196F3"},fonts:{title:{size:"48px",family:"Arial",style:"bold"},label:{size:"32px",family:"Arial"},value:{size:"36px",family:"Arial",style:"bold"},button:{size:"32px",family:"Arial"}},layout:{titleY:80,sectionY:.35,sectionSpacing:.22},buttons:{large:{width:400,height:70,borderWidth:3},small:{width:300,height:50,borderWidth:2},arrow:{radius:50}},animation:{hoverScale:100}},this.selectedAICount=2,this.selectedRounds=3}create(){this.createBackground(),this.createTitle(),this.createAISelection(),this.createRoundsSelection(),this.createActionButtons()}createBackground(){this.add.rectangle(this.scale.width/2,this.scale.height/2,this.scale.width,this.scale.height,this.CONFIG.colors.background)}createTitle(){this.add.text(this.scale.width/2,this.CONFIG.layout.titleY,"Single Player Setup",{fontSize:this.CONFIG.fonts.title.size,fontFamily:this.CONFIG.fonts.title.family,color:this.CONFIG.colors.text,fontStyle:this.CONFIG.fonts.title.style}).setOrigin(.5)}createAISelection(){const e=this.scale.width/2,t=this.scale.height*this.CONFIG.layout.sectionY;this.add.text(e,t-15,"BROJ BOTOVA:",{fontSize:this.CONFIG.fonts.label.size,fontFamily:this.CONFIG.fonts.label.family,color:this.CONFIG.colors.text}).setOrigin(.5);const s=t+60;this.createArrowButton(e-120,s,"â†",()=>this.decreaseAICount(),this.selectedAICount<=1),this.add.text(e,s,`${this.selectedAICount}`,{fontSize:this.CONFIG.fonts.value.size,fontFamily:this.CONFIG.fonts.value.family,color:this.CONFIG.colors.accent,fontStyle:this.CONFIG.fonts.value.style}).setOrigin(.5),this.createArrowButton(e+120,s,"â†’",()=>this.increaseAICount(),this.selectedAICount>=5)}createRoundsSelection(){const e=this.scale.width/2,t=this.scale.height*(this.CONFIG.layout.sectionY+this.CONFIG.layout.sectionSpacing);this.add.text(e,t-15,"BROJ RUNDI:",{fontSize:this.CONFIG.fonts.label.size,fontFamily:this.CONFIG.fonts.label.family,color:this.CONFIG.colors.text}).setOrigin(.5);const s=t+60;this.createArrowButton(e-120,s,"â†",()=>this.decreaseRounds(),this.selectedRounds<=1),this.roundsText=this.add.text(e,s,`${this.selectedRounds}`,{fontSize:this.CONFIG.fonts.value.size,fontFamily:this.CONFIG.fonts.value.family,color:this.CONFIG.colors.accent,fontStyle:this.CONFIG.fonts.value.style}).setOrigin(.5),this.createArrowButton(e+120,s,"â†’",()=>this.increaseRounds(),this.selectedRounds>=15)}createArrowButton(e,t,s,i,r=!1){const n=this.add.container(e,t),a=this.CONFIG.buttons.arrow.radius,o=this.add.circle(0,0,a,r?3355443:6710886),l=this.add.text(0,0,s,{fontSize:"48px",color:r?"#555555":"#ffffff"}).setOrigin(.5);return n.add([o,l]),n.setSize(a*2,a*2),r||(n.setInteractive({useHandCursor:!0}),n.on("pointerover",()=>{o.setFillStyle(5025616),this.tweens.add({targets:n,scale:1.1,duration:this.CONFIG.animation.hoverScale})}),n.on("pointerout",()=>{o.setFillStyle(6710886),this.tweens.add({targets:n,scale:1,duration:this.CONFIG.animation.hoverScale})}),n.on("pointerdown",i)),n}increaseAICount(){this.selectedAICount<5&&(this.selectedAICount++,this.scene.restart())}decreaseAICount(){this.selectedAICount>1&&(this.selectedAICount--,this.scene.restart())}increaseRounds(){this.selectedRounds<15&&(this.selectedRounds++,this.updateRoundsDisplay())}decreaseRounds(){this.selectedRounds>1&&(this.selectedRounds--,this.updateRoundsDisplay())}updateRoundsDisplay(){this.roundsText.setText(`${this.selectedRounds}`)}createActionButtons(){const{width:e,height:t}=this.scale,s=t*.85;this.createButton(e/2,s,"ðŸŽ® Start Game",this.CONFIG.colors.primary,"large").on("pointerdown",()=>this.startGame()),this.createButton(100,50,"â† Back",this.CONFIG.colors.disabled,"small").on("pointerdown",()=>this.goBack())}createButton(e,t,s,i,r="large"){const n=this.add.container(e,t),{width:a,height:o,borderWidth:l}=this.CONFIG.buttons[r],d=r==="large"?this.CONFIG.fonts.button.size:"20px",c=this.add.rectangle(0,0,a,o,0,.8);c.setStrokeStyle(l,parseInt(i.replace("#","0x")));const h=this.add.text(0,0,s,{fontSize:d,fontFamily:this.CONFIG.fonts.button.family,color:this.CONFIG.colors.text}).setOrigin(.5);n.add([c,h]),n.setSize(a,o),n.setInteractive({useHandCursor:!0});const g=parseInt(i.replace("#","0x"));return n.on("pointerover",()=>{c.setFillStyle(g,.3),this.tweens.add({targets:n,scaleX:1.05,scaleY:1.05,duration:this.CONFIG.animation.hoverScale})}),n.on("pointerout",()=>{c.setFillStyle(0,.8),this.tweens.add({targets:n,scaleX:1,scaleY:1,duration:this.CONFIG.animation.hoverScale})}),n}startGame(){const e=this.add.text(this.scale.width/2,this.scale.height/2,"Starting game...",{fontSize:"32px",color:this.CONFIG.colors.text}).setOrigin(.5);this.tweens.add({targets:e,alpha:0,y:e.y-50,duration:1e3,onComplete:()=>{this.scene.start(T.GAME,{isMultiplayer:!1,gameConfig:{maxPlayers:this.selectedAICount+1,rounds:this.selectedRounds,aiCount:this.selectedAICount}})}})}goBack(){this.scene.start(T.MENU)}}const He={type:P.WEBGL,backgroundColor:"#2E8B57",dom:{createContainer:!0},scene:[Fe,oe,xe,le,Le],input:{activePointers:3,touch:!0,smoothFactor:0,windowEvents:!0},scale:{parent:"game-container",width:"100%",height:"100%",autoCenter:P.Scale.CENTER_BOTH,mode:P.Scale.RESIZE},physics:{default:"arcade",arcade:{debug:!1}}},be=new P.Game(He);window.addEventListener("error",u=>{console.error("Game error:",u.error)});window.game=be;
